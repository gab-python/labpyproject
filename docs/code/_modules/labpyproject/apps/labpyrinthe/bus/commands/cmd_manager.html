

<!DOCTYPE html>
<html class="writer-html5" lang="fr" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>labpyproject.apps.labpyrinthe.bus.commands.cmd_manager &mdash; Documentation labpyproject </title>
  

  
  <link rel="stylesheet" href="../../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../../_static/theme_overrides.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../../" src="../../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../../_static/jquery.js"></script>
        <script src="../../../../../../_static/underscore.js"></script>
        <script src="../../../../../../_static/doctools.js"></script>
        <script src="../../../../../../_static/language_data.js"></script>
        <script src="../../../../../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Recherche" href="../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../../index.html" class="icon icon-home" alt="Documentation Home"> labpyproject
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Rechercher docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../labpyproject.html">labpyproject</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../../labpyproject.apps.html">labpyproject.apps</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.html">labpyproject.apps.labpyrinthe</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.app.html">labpyproject.apps.labpyrinthe.app</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.app.app_types.html">app_types</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.app.app_types.html#classes">Classes</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.app.app_types.AppTypes.html">AppTypes</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.app.app_types.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.app.application.html">application</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.app.application.html#classes">Classes</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.app.application.AppManager.html">AppManager</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.app.application.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.html">labpyproject.apps.labpyrinthe.bus</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.commands.html">labpyproject.apps.labpyrinthe.bus.commands</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.commands.cmd_helper.html">cmd_helper</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.commands.cmd_helper.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.commands.cmd_helper.CommandHelper.html">CommandHelper</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.commands.cmd_helper.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.commands.cmd_manager.html">cmd_manager</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.commands.cmd_manager.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.commands.cmd_manager.CommandManager.html">CommandManager</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.commands.cmd_manager.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.commands.gamble_datas.html">gamble_datas</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.commands.gamble_datas.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.commands.gamble_datas.GambleDataSet.html">GambleDataSet</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.commands.gamble_datas.GambleDataObject.html">GambleDataObject</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.commands.gamble_datas.PseudoActions.html">PseudoActions</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.commands.gamble_datas.GambleSearch.html">GambleSearch</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.commands.gamble_datas.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.commands.targets.html">targets</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.commands.targets.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.commands.targets.TargetObject.html">TargetObject</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.commands.targets.TargetPath.html">TargetPath</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.commands.targets.TargetPathStep.html">TargetPathStep</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.commands.targets.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.helpers.html">labpyproject.apps.labpyrinthe.bus.helpers</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.helpers.exchange_helper.html">exchange_helper</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.helpers.exchange_helper.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.helpers.exchange_helper.ExchangeHelper.html">ExchangeHelper</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.helpers.exchange_helper.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.helpers.game_configuration.html">game_configuration</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.helpers.game_configuration.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.helpers.game_configuration.GameConfiguration.html">GameConfiguration</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.helpers.game_configuration.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.helpers.lab_generator.html">lab_generator</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.helpers.lab_generator.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.helpers.lab_generator.LabGenerator.html">LabGenerator</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.helpers.lab_generator.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.helpers.lab_manager.html">lab_manager</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.helpers.lab_manager.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.helpers.lab_manager.LabManager.html">LabManager</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.helpers.lab_manager.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.helpers.lab_parser.html">lab_parser</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.helpers.lab_parser.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.helpers.lab_parser.LabParser.html">LabParser</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.helpers.lab_parser.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.model.html">labpyproject.apps.labpyrinthe.bus.model</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.model.core_matrix.html">core_matrix</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.model.core_matrix.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.model.core_matrix.LabHelper.html">LabHelper</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.model.core_matrix.LabLevel.html">LabLevel</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.model.core_matrix.Matrice.html">Matrice</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.model.core_matrix.AnimatedLayer.html">AnimatedLayer</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.model.core_matrix.Case.html">Case</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.model.core_matrix.CaseRobot.html">CaseRobot</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.model.core_matrix.CaseDanger.html">CaseDanger</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.model.core_matrix.CaseGrenade.html">CaseGrenade</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.model.core_matrix.CaseAnimation.html">CaseAnimation</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.model.core_matrix.CaseBonus.html">CaseBonus</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.model.core_matrix.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.model.player.html">player</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.model.player.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.model.player.LabPlayer.html">LabPlayer</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.model.player.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.game_manager.html">game_manager</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.game_manager.html#classes">Classes</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.game_manager.GameManager.html">GameManager</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.bus.game_manager.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.html">labpyproject.apps.labpyrinthe.gui</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.html">labpyproject.apps.labpyrinthe.gui.skinBase</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.GUIBase.html">GUIBase</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.GUIBase.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinBase.GUIBase.GUIBase.html">GUIBase</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinBase.GUIBase.GUIBaseNoThread.html">GUIBaseNoThread</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinBase.GUIBase.GUIBaseThreaded.html">GUIBaseThreaded</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.GUIBase.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.colors.html">colors</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.colors.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinBase.colors.ColorHelper.html">ColorHelper</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.colors.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.interfaces.html">interfaces</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.interfaces.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinBase.interfaces.AbstractZoneCarte.html">AbstractZoneCarte</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinBase.interfaces.AbstractZoneCommand.html">AbstractZoneCommand</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinBase.interfaces.AbstractZonePartie.html">AbstractZonePartie</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinBase.interfaces.AbstractZoneBots.html">AbstractZoneBots</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinBase.interfaces.AbstractZoneMenu.html">AbstractZoneMenu</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinBase.interfaces.AbstractScreenContent.html">AbstractScreenContent</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinBase.interfaces.AbstractScreenWait.html">AbstractScreenWait</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinBase.interfaces.AbstractSwitch.html">AbstractSwitch</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinBase.interfaces.AbstractInput.html">AbstractInput</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.interfaces.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.screen_wait_base.html">screen_wait_base</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.screen_wait_base.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinBase.screen_wait_base.ScreenWaitBase.html">ScreenWaitBase</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.screen_wait_base.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.skin_base.html">skin_base</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.skin_base.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinBase.skin_base.SkinBase.html">SkinBase</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.skin_base.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.zone_bots_base.html">zone_bots_base</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.zone_bots_base.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinBase.zone_bots_base.ZoneBotsBase.html">ZoneBotsBase</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.zone_bots_base.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.zone_carte_base.html">zone_carte_base</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.zone_carte_base.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinBase.zone_carte_base.ZoneCarteBase.html">ZoneCarteBase</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinBase.zone_carte_base.ItemObjectBase.html">ItemObjectBase</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.zone_carte_base.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.zone_command_base.html">zone_command_base</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.zone_command_base.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinBase.zone_command_base.ZoneCommandBase.html">ZoneCommandBase</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.zone_command_base.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.zone_menu_base.html">zone_menu_base</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.zone_menu_base.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinBase.zone_menu_base.ZoneMenuBase.html">ZoneMenuBase</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.zone_menu_base.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.zone_partie_base.html">zone_partie_base</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.zone_partie_base.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinBase.zone_partie_base.ZonePartieBase.html">ZonePartieBase</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinBase.zone_partie_base.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinConsole.html">labpyproject.apps.labpyrinthe.gui.skinConsole</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinConsole.pub_helper.html">pub_helper</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinConsole.pub_helper.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinConsole.pub_helper.PublicationHelper.html">PublicationHelper</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinConsole.pub_helper.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.html">labpyproject.apps.labpyrinthe.gui.skinPygame</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.botview.html">botview</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.botview.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinPygame.botview.BotView.html">BotView</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.botview.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.footer.html">footer</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.footer.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinPygame.footer.Footer.html">Footer</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.footer.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.header.html">header</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.header.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinPygame.header.Header.html">Header</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.header.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.screen_wait.html">screen_wait</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.screen_wait.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinPygame.screen_wait.ScreenWait.html">ScreenWait</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinPygame.screen_wait.ScaledText.html">ScaledText</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinPygame.screen_wait.SimplePreloader.html">SimplePreloader</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.screen_wait.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.skinPygame.html">skinPygame</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.skinPygame.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinPygame.skinPygame.SkinPygame.html">SkinPygame</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.skinPygame.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.uitools.html">uitools</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.uitools.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinPygame.uitools.WImage.html">WImage</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinPygame.uitools.WText.html">WText</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinPygame.uitools.WEntry.html">WEntry</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinPygame.uitools.WButton.html">WButton</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinPygame.uitools.Spacer.html">Spacer</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.uitools.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.zone_bots.html">zone_bots</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.zone_bots.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinPygame.zone_bots.ZoneBots.html">ZoneBots</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinPygame.zone_bots.BotList.html">BotList</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinPygame.zone_bots.BotItem.html">BotItem</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.zone_bots.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.zone_carte.html">zone_carte</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.zone_carte.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinPygame.zone_carte.ZoneCarte.html">ZoneCarte</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinPygame.zone_carte.ItemObject.html">ItemObject</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinPygame.zone_carte.CaseView.html">CaseView</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinPygame.zone_carte.BotViewCarte.html">BotViewCarte</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinPygame.zone_carte.ZoneDangerRobot.html">ZoneDangerRobot</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.zone_carte.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.zone_command.html">zone_command</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.zone_command.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinPygame.zone_command.ZoneCommand.html">ZoneCommand</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.zone_command.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.zone_menu.html">zone_menu</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.zone_menu.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinPygame.zone_menu.ZoneMenu.html">ZoneMenu</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinPygame.zone_menu.MenuButton.html">MenuButton</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.zone_menu.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.zone_partie.html">zone_partie</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.zone_partie.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinPygame.zone_partie.ZonePartie.html">ZonePartie</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinPygame.zone_partie.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.html">labpyproject.apps.labpyrinthe.gui.skinTkinter</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.header.html">header</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.header.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinTkinter.header.Header.html">Header</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.header.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.screen_wait.html">screen_wait</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.screen_wait.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinTkinter.screen_wait.ScreenWait.html">ScreenWait</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.screen_wait.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.skinTkinter.html">skinTkinter</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.skinTkinter.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinTkinter.skinTkinter.SkinTkinter.html">SkinTkinter</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.skinTkinter.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.uitools.html">uitools</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.uitools.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinTkinter.uitools.CustomEntry.html">CustomEntry</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinTkinter.uitools.CanvasSwitch.html">CanvasSwitch</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinTkinter.uitools.CanvasImage.html">CanvasImage</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinTkinter.uitools.CanvasSpacer.html">CanvasSpacer</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinTkinter.uitools.CanvasSeparateur.html">CanvasSeparateur</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.uitools.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.zone_bots.html">zone_bots</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.zone_bots.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinTkinter.zone_bots.ZoneBots.html">ZoneBots</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.zone_bots.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.zone_carte.html">zone_carte</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.zone_carte.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinTkinter.zone_carte.ZoneCarte.html">ZoneCarte</a></li>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinTkinter.zone_carte.ItemObject.html">ItemObject</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.zone_carte.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.zone_command.html">zone_command</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.zone_command.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinTkinter.zone_command.ZoneCommand.html">ZoneCommand</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.zone_command.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.zone_menu.html">zone_menu</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.zone_menu.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinTkinter.zone_menu.ZoneMenu.html">ZoneMenu</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.zone_menu.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.zone_partie.html">zone_partie</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.zone_partie.html#classes">Classes</a><ul>
<li class="toctree-l8"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.skinTkinter.zone_partie.ZonePartie.html">ZonePartie</a></li>
</ul>
</li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.skinTkinter.zone_partie.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.GUIConsole.html">GUIConsole</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.GUIConsole.html#classes">Classes</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.GUIConsole.GUIConsole.html">GUIConsole</a></li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.GUIConsole.ThreadInput.html">ThreadInput</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.GUIConsole.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.GUIPygame.html">GUIPygame</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.GUIPygame.html#classes">Classes</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.GUIPygame.GUIPygame.html">GUIPygame</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.GUIPygame.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.GUITk.html">GUITk</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.GUITk.html#classes">Classes</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../api/labpyproject.apps.labpyrinthe.gui.GUITk.GUITk.html">GUITk</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.gui.GUITk.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.clientConsole.html">clientConsole</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.clientPygame.html">clientPygame</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.serverConsole.html">serverConsole</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.standaloneConsole.html">standaloneConsole</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.standalonePygame.html">standalonePygame</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../labpyproject.apps.labpyrinthe.standaloneTkinter.html">standaloneTkinter</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../../labpyproject.core.html">labpyproject.core</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../../../labpyproject.core.app.html">labpyproject.core.app</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../labpyproject.core.app.app_components.html">app_components</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.core.app.app_components.html#classes">Classes</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.app.app_components.ThreadableComp.html">ThreadableComp</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.app.app_components.APPComp.html">APPComp</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.app.app_components.SatelliteExchangeObject.html">SatelliteExchangeObject</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.app.app_components.AbstractSatelliteComp.html">AbstractSatelliteComp</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.app.app_components.DelayedAction.html">DelayedAction</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.app.app_components.SatelliteComp.html">SatelliteComp</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.app.app_components.SatelliteCompNoThread.html">SatelliteCompNoThread</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.app.app_components.GUIExchangeObject.html">GUIExchangeObject</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.app.app_components.AbstractGUIComp.html">AbstractGUIComp</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.app.app_components.GUIComp.html">GUIComp</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.app.app_components.GUICompNoThread.html">GUICompNoThread</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.app.app_components.NETExchangeObject.html">NETExchangeObject</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.app.app_components.NETComp.html">NETComp</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.app.app_components.BUSINESSComp.html">BUSINESSComp</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.core.app.app_components.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../../labpyproject.core.io.html">labpyproject.core.io</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../labpyproject.core.io.custom_IO.html">custom_IO</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.core.io.custom_IO.html#functions">Functions</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.io.custom_IO.get_file_list.html">get_file_list</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.io.custom_IO.load_obj_from_file.html">load_obj_from_file</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.io.custom_IO.load_text_file.html">load_text_file</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.io.custom_IO.save_obj_in_file.html">save_obj_in_file</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../../labpyproject.core.net.html">labpyproject.core.net</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../labpyproject.core.net.custom_TCP.html">custom_TCP</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.core.net.custom_TCP.html#classes">Classes</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.net.custom_TCP.CustomTCPServerContainer.html">CustomTCPServerContainer</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.net.custom_TCP.ThreadedTCPServer.html">ThreadedTCPServer</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.net.custom_TCP.CustomTCPRequestHandler.html">CustomTCPRequestHandler</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.net.custom_TCP.ParseDataError.html">ParseDataError</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.net.custom_TCP.CustomRequestHelper.html">CustomRequestHelper</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.net.custom_TCP.CustomTCPThreadedClient.html">CustomTCPThreadedClient</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.core.net.custom_TCP.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../../labpyproject.core.patterns.html">labpyproject.core.patterns</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../labpyproject.core.patterns.design_patterns.html">design_patterns</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.core.patterns.design_patterns.html#classes">Classes</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.patterns.design_patterns.Singleton.html">Singleton</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.core.patterns.design_patterns.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../../labpyproject.core.pygame.html">labpyproject.core.pygame</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../labpyproject.core.pygame.core.html">core</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.core.pygame.core.html#classes">Classes</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.core.BoxModelObject.html">BoxModelObject</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.core.MetricValue.html">MetricValue</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.core.BoundedMetricValue.html">BoundedMetricValue</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.core.VirtualItem.html">VirtualItem</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.core.VirtualContainer.html">VirtualContainer</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.core.CustomSprite.html">CustomSprite</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.core.RealContainer.html">RealContainer</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.core.RootContainer.html">RootContainer</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.core.LayerManager.html">LayerManager</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.core.LayerStack.html">LayerStack</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.core.LocalLayer.html">LocalLayer</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.core.pygame.core.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../labpyproject.core.pygame.events.html">events</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.core.pygame.events.html#classes">Classes</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.events.CustomEventManager.html">CustomEventManager</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.events.GUIEventManager.html">GUIEventManager</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.events.CustomBaseControl.html">CustomBaseControl</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.events.CustomBaseInput.html">CustomBaseInput</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.events.CustomBaseButton.html">CustomBaseButton</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.core.pygame.events.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../labpyproject.core.pygame.widgets.html">widgets</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.core.pygame.widgets.html#classes">Classes</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.widgets.Background.html">Background</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.widgets.Image.html">Image</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.widgets.Text.html">Text</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.widgets.Entry.html">Entry</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.widgets.TextButton.html">TextButton</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.widgets.Button.html">Button</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.widgets.Stack.html">Stack</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.widgets.HStack.html">HStack</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.widgets.VStack.html">VStack</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.widgets.Canvas.html">Canvas</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.widgets.HBox.html">HBox</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.widgets.VBox.html">VBox</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.pygame.widgets.Root.html">Root</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.core.pygame.widgets.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../../labpyproject.core.queue.html">labpyproject.core.queue</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../labpyproject.core.queue.queue_tools.html">queue_tools</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.core.queue.queue_tools.html#classes">Classes</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.queue.queue_tools.QueueManager.html">QueueManager</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.queue.queue_tools.QueueSimpleClient.html">QueueSimpleClient</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.queue.queue_tools.QueueSwitcher.html">QueueSwitcher</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.core.queue.queue_tools.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../../labpyproject.core.random.html">labpyproject.core.random</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../labpyproject.core.random.custom_random.html">custom_random</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.core.random.custom_random.html#classes">Classes</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../../../../../../api/labpyproject.core.random.custom_random.CustomRandom.html">CustomRandom</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="../../../../../../labpyproject.core.random.custom_random.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../index.html">labpyproject</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../../../index.html">Code du module</a> &raquo;</li>
        
      <li>labpyproject.apps.labpyrinthe.bus.commands.cmd_manager</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Code source de labpyproject.apps.labpyrinthe.bus.commands.cmd_manager</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">**CommandManager**, le gestionnaire de commandes du jeu, assurant les deux rôles suivants :</span>

<span class="sd">1. Garantit la validité des commandes utilisateurs</span>
<span class="sd">2. Pilote les joueurs automatiques</span>

<span class="sd">Principes généraux de pilotage des robots:</span>

<span class="sd">- les commandes dépendent du type du robot (Chasseur, Winner, ...) et de ses caractéristiques</span>
<span class="sd">  propres (intelligence, aggressivité...)</span>
<span class="sd">- les robots évoluent au moyen d&#39;une cible principale (la sortie pour un Winner, un adversaire </span>
<span class="sd">  pour un chasseur, ...) et d&#39;une cible temporaire représentant la prochaine étape à atteindre</span>
<span class="sd">- le choix d&#39;une commande suit la séquence suivante :</span>

<span class="sd">  1. analyse globale de l&#39;environnement (bonus à portée, dangers pouvant impacter le robot, </span>
<span class="sd">     est il en retard...), évaluation de la pertinence des cibles</span>
<span class="sd">  2. évaluation des options pouvant constituer la prochaine cible temporaire dans les 4 directions </span>
<span class="sd">     (mesures de densité, calculs de scores)</span>
<span class="sd">  3. sélection au besoin d&#39;une nouvelle cible temporaire (prise en compte du coût de parcours</span>
<span class="sd">     dans le choix)</span>
<span class="sd">  4. priorisation des objectifs en fonction des caractéristiques du robot (mouvement, </span>
<span class="sd">     attaque, défense, travail)</span>
<span class="sd">  5. choix de la prochaine commande (ou d&#39;une séquence de coups pour les robots les plus </span>
<span class="sd">     intelligents disposant de plusieurs coups consécutifs)</span>

<span class="sd">.. admonition:: Optimisations:</span>

<span class="sd">   - cache de très court terme (pour le coup en cours): combinaisons de grenade, chemins</span>
<span class="sd">   - cache de court terme (pour la série de coups en cours): objectifs, pseudo actions </span>
<span class="sd">     programmées, probabilité de risque associées aux cases atteignables</span>
<span class="sd">   - cache de moyen et long terme: portés par le gestionnaire de carte (LabLevel) et ses </span>
<span class="sd">     applats (Matrices).</span>
<span class="sd">   - utilisation de sets plutôt que de listes</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># imports :</span>
<span class="kn">import</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">itemgetter</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">attrgetter</span>
<span class="kn">import</span> <span class="nn">labpyproject.core.random.custom_random</span> <span class="k">as</span> <span class="nn">cr</span>
<span class="kn">from</span> <span class="nn">labpyproject.apps.labpyrinthe.bus.helpers.lab_generator</span> <span class="kn">import</span> <span class="n">LabGenerator</span>
<span class="kn">from</span> <span class="nn">labpyproject.apps.labpyrinthe.bus.model.core_matrix</span> <span class="kn">import</span> <span class="n">LabHelper</span>
<span class="kn">from</span> <span class="nn">labpyproject.apps.labpyrinthe.bus.model.core_matrix</span> <span class="kn">import</span> <span class="n">Case</span>
<span class="kn">from</span> <span class="nn">labpyproject.apps.labpyrinthe.bus.model.core_matrix</span> <span class="kn">import</span> <span class="n">CaseRobot</span>
<span class="kn">from</span> <span class="nn">labpyproject.apps.labpyrinthe.bus.model.core_matrix</span> <span class="kn">import</span> <span class="n">CaseDanger</span>
<span class="kn">from</span> <span class="nn">labpyproject.apps.labpyrinthe.bus.model.core_matrix</span> <span class="kn">import</span> <span class="n">CaseGrenade</span>
<span class="kn">from</span> <span class="nn">labpyproject.apps.labpyrinthe.bus.commands.cmd_helper</span> <span class="kn">import</span> <span class="n">CommandHelper</span>
<span class="kn">from</span> <span class="nn">labpyproject.apps.labpyrinthe.bus.commands.gamble_datas</span> <span class="kn">import</span> <span class="n">GambleDataSet</span>
<span class="kn">from</span> <span class="nn">labpyproject.apps.labpyrinthe.bus.commands.gamble_datas</span> <span class="kn">import</span> <span class="n">GambleDataObject</span>
<span class="kn">from</span> <span class="nn">labpyproject.apps.labpyrinthe.bus.commands.gamble_datas</span> <span class="kn">import</span> <span class="n">PseudoActions</span>
<span class="kn">from</span> <span class="nn">labpyproject.apps.labpyrinthe.bus.commands.targets</span> <span class="kn">import</span> <span class="n">TargetObject</span>
<span class="kn">from</span> <span class="nn">labpyproject.apps.labpyrinthe.bus.commands.targets</span> <span class="kn">import</span> <span class="n">TargetPath</span>
<span class="kn">from</span> <span class="nn">labpyproject.apps.labpyrinthe.bus.commands.targets</span> <span class="kn">import</span> <span class="n">TargetPathStep</span>

<span class="c1"># Evite l&#39;ajout non désiré de certains imports à la doc sphinx</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CommandManager&quot;</span><span class="p">]</span>
<span class="c1"># classes :</span>
<div class="viewcode-block" id="CommandManager"><a class="viewcode-back" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.commands.cmd_manager.CommandManager.html#labpyproject.apps.labpyrinthe.bus.commands.cmd_manager.CommandManager">[docs]</a><span class="k">class</span> <span class="nc">CommandManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    **Gestionnaire des commandes**</span>
<span class="sd">    </span>
<span class="sd">    1. validation des commandes entrées par les joueurs</span>
<span class="sd">    2. génération des commandes des joueurs automatiques</span>
<span class="sd">    </span>
<span class="sd">    .. note::</span>
<span class="sd">       Prototype fonctionnel. Classe trop lourde (&gt; 6500 lignes), à reconcevoir </span>
<span class="sd">       de façon plus générique dans une version de production.</span>
<span class="sd">    </span>
<span class="sd">    .. highlight:: none</span>
<span class="sd">    Plan du code source : ::</span>
<span class="sd">    </span>
<span class="sd">        A- Interface publique</span>
<span class="sd">        B- Méthodes privées d&#39;analyse et de décision</span>
<span class="sd">            B.1- Commande forcée en cas d&#39;échec des algos de décision</span>
<span class="sd">            B.2- Initialisations</span>
<span class="sd">                B.2.1- Cache de sets</span>
<span class="sd">                B.2.2- Initialisations (reconnaissance globale, évaluation des cibles, phase de jeu)</span>
<span class="sd">                B.2.3- Initialisations spécifiques</span>
<span class="sd">            B.3- Génération des données de choix de commande</span>
<span class="sd">            B.4- Evaluation des données de choix de commande</span>
<span class="sd">            B.5- Sélection de cible, recherche de chemins</span>
<span class="sd">                B.5.1- Cible temporaire</span>
<span class="sd">                B.5.2- Interface de recherche de chemins</span>
<span class="sd">                B.5.3- Recherche exhaustive de chemins</span>
<span class="sd">                B.5.4- Recherche optimisée sur de longues distances</span>
<span class="sd">                B.5.5- Approche finale de la cible principale</span>
<span class="sd">            B.6- Qualification des options adjacentes</span>
<span class="sd">            B.7- Anticipation de coups consécutifs</span>
<span class="sd">                B.7.1- Dédiée aux winners et hunters intelligents</span>
<span class="sd">                B.7.2- Recherche d&#39;une série de commandes : analyse et décisions</span>
<span class="sd">                B.7.3- Méthodes de recherche thématiques</span>
<span class="sd">                B.7.4- Schedule tools</span>
<span class="sd">                B.7.5- Application de commandes anticipées</span>
<span class="sd">            B.8- Recherche du prochain coup</span>
<span class="sd">            B.9- Outils communs aux recherches de commande</span>
<span class="sd">            B.10- Outils liés au comportement</span>
<span class="sd">            B.11- Gestion de lancer de grenade</span>
<span class="sd">            B.12- Utilitaires basiques</span>
<span class="sd">    .. highlight:: default   </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># phases de jeu</span>
    <span class="n">PHASIS_START</span> <span class="o">=</span> <span class="s2">&quot;PHASIS_START&quot;</span>  <span class="c1">#: début de partie</span>
    <span class="n">PHASIS_IN_PROGRESS</span> <span class="o">=</span> <span class="s2">&quot;PHASIS_IN_PROGRESS&quot;</span>  <span class="c1">#: partie en cours</span>
    <span class="n">PHASIS_APPROACH</span> <span class="o">=</span> <span class="s2">&quot;PHASIS_APPROACH&quot;</span>  <span class="c1">#: approche de la cible</span>
    <span class="n">PHASIS_FINAL</span> <span class="o">=</span> <span class="s2">&quot;PHASIS_FINAL&quot;</span>  <span class="c1">#: phase finale d&#39;approche</span>
    <span class="n">PHASIS_HUNT</span> <span class="o">=</span> <span class="s2">&quot;PHASIS_HUNT&quot;</span>  <span class="c1">#: force un chasseur à poursuivre sa cible</span>
    <span class="n">DIST_APPROACH</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1">#: distance à la cible caractérisant la phase finale</span>
    <span class="c1"># contexte de sélection des séries de coups</span>
    <span class="n">CTX_OPTIMAL</span> <span class="o">=</span> <span class="s2">&quot;CTX_OPTIMAL&quot;</span>  <span class="c1">#: contexte de recherche de coups multiples optimal</span>
    <span class="n">CTX_BY_OBJ</span> <span class="o">=</span> <span class="s2">&quot;CTX_BY_OBJ&quot;</span>  <span class="c1">#: contexte de recherche de coups multiples par objectifs</span>
    <span class="n">CTX_BONUS</span> <span class="o">=</span> <span class="s2">&quot;CTX_BONUS&quot;</span>  <span class="c1">#: contexte de recherche de coups multiples bonus</span>
    <span class="n">CTX_DESPERATE</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;CTX_DESPERATE&quot;</span>  
    <span class="p">)</span> <span class="c1">#: contexte de recherche de coups multiples désespéré</span>
    <span class="c1"># objectifs des robots :</span>
    <span class="n">OBJ_ATTACK</span> <span class="o">=</span> <span class="s2">&quot;OBJ_ATTACK&quot;</span>  <span class="c1">#: marque l&#39;objectif attaque</span>
    <span class="n">OBJ_DEFENSE</span> <span class="o">=</span> <span class="s2">&quot;OBJ_DEFENSE&quot;</span>  <span class="c1">#: marque l&#39;objectif défense</span>
    <span class="n">OBJ_MOVE</span> <span class="o">=</span> <span class="s2">&quot;OBJ_MOVE&quot;</span>  <span class="c1">#: marque l&#39;objectif mouvement</span>
    <span class="n">OBJ_WORK</span> <span class="o">=</span> <span class="s2">&quot;OBJ_WORK&quot;</span>  <span class="c1">#: marque l&#39;objectif travail</span>
    <span class="n">OBJ_RANDOM</span> <span class="o">=</span> <span class="s2">&quot;OBJ_RANDOM&quot;</span>  <span class="c1">#: marque l&#39;objectif aléatoire</span>
    <span class="c1"># types de PseudoActions (série d&#39;actions anticipées)</span>
    <span class="n">PA_OPTIMAL_MOVE</span> <span class="o">=</span> <span class="s2">&quot;PA_OPTIMAL_MOVE&quot;</span>  <span class="c1">#: pseudoaction de type mouvement</span>
    <span class="n">PA_FREE_EXIT</span> <span class="o">=</span> <span class="s2">&quot;PA_FREE_EXIT&quot;</span>  <span class="c1">#: pseudoaction de type libérer la sortie</span>
    <span class="n">PA_SAFE_MOVE</span> <span class="o">=</span> <span class="s2">&quot;PA_SAFE_MOVE&quot;</span>  <span class="c1">#: pseudoaction de type déplacement sans risques</span>
    <span class="n">PA_RISKED_MOVE</span> <span class="o">=</span> <span class="s2">&quot;PA_RISKED_MOVE&quot;</span>  <span class="c1">#: pseudoaction de type déplacement risqué</span>
    <span class="n">PA_STAY_IN_PLACE</span> <span class="o">=</span> <span class="s2">&quot;PA_STAY_IN_PLACE&quot;</span>  <span class="c1">#: pseudoaction de type ne pas bouger</span>
    <span class="n">PA_TERRAFORM</span> <span class="o">=</span> <span class="s2">&quot;PA_TERRAFORM&quot;</span>  <span class="c1">#: pseudoaction de type dégager le chemin</span>
    <span class="n">PA_ATTACK</span> <span class="o">=</span> <span class="s2">&quot;PA_ATTACK&quot;</span>  <span class="c1">#: pseudoaction de type attaque</span>
    <span class="n">PA_BONUS</span> <span class="o">=</span> <span class="s2">&quot;PA_BONUS&quot;</span>  <span class="c1">#: pseudoaction de type prise de bonus</span>
    <span class="n">PA_DANGERS</span> <span class="o">=</span> <span class="s2">&quot;PA_DANGERS&quot;</span>  <span class="c1">#: pseudoaction de type destruction de dangers (pour rebattre les cartes)</span>
    <span class="n">PA_ESCAPE</span> <span class="o">=</span> <span class="s2">&quot;PA_ESCAPE&quot;</span>  <span class="c1">#: pseudoaction de type fuite</span>
    <span class="n">PA_TYPES</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">PA_OPTIMAL_MOVE</span><span class="p">,</span>
        <span class="n">PA_FREE_EXIT</span><span class="p">,</span>
        <span class="n">PA_SAFE_MOVE</span><span class="p">,</span>
        <span class="n">PA_RISKED_MOVE</span><span class="p">,</span>
        <span class="n">PA_STAY_IN_PLACE</span><span class="p">,</span>
        <span class="n">PA_TERRAFORM</span><span class="p">,</span>
        <span class="n">PA_ATTACK</span><span class="p">,</span>
        <span class="n">PA_BONUS</span><span class="p">,</span>
        <span class="n">PA_DANGERS</span><span class="p">,</span>
        <span class="n">PA_ESCAPE</span><span class="p">,</span>
    <span class="p">]</span>  <span class="c1">#: liste des types de pseudoactions supportées</span>
    <span class="c1"># méthodes</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructeur</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Niveau (couches de matrices) :</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Liste des cases associées aux robots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_liste_robots</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Sets remis à jour avant chaque coup :</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">case_sets_updated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alive_bots</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">human_alive</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">winner_alive</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hunter_alive</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">winner_human_alive</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">winner_human_hunter_alive</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dangers_set</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dangers_set_1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dangers_set_plus1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonus_set</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">play_set</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># enregistrement temporaire des blocages de chemins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pathblocklist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># id du coup en cours</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_currentgambleid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># enregistrement des commandes invalides : k=gambleid, v=cmd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_discardedcmddict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="c1">#-----&gt; A- Interface publique</span>
<div class="viewcode-block" id="CommandManager.re_initialise"><a class="viewcode-back" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.commands.cmd_manager.CommandManager.html#labpyproject.apps.labpyrinthe.bus.commands.cmd_manager.CommandManager.re_initialise">[docs]</a>    <span class="k">def</span> <span class="nf">re_initialise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ré initialisation avant une nouvelle partie</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Niveau (couches de matrices) :</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Liste des cases associées aux robots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_liste_robots</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Sets remis à jour avant chaque coup :</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">case_sets_updated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alive_bots</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">human_alive</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">winner_alive</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hunter_alive</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">winner_human_alive</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">winner_human_hunter_alive</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dangers_set</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dangers_set_1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dangers_set_plus1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonus_set</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">play_set</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># enregistrement temporaire des blocages de chemins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pathblocklist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># id du coup en cours</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_currentgambleid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># enregistrement des commandes invalides : k=gambleid, v=cmd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_discardedcmddict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span></div>

<div class="viewcode-block" id="CommandManager.set_labLevel"><a class="viewcode-back" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.commands.cmd_manager.CommandManager.html#labpyproject.apps.labpyrinthe.bus.commands.cmd_manager.CommandManager.set_labLevel">[docs]</a>    <span class="k">def</span> <span class="nf">set_labLevel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lablevel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Définit ou re définit l&#39;objet LabLevel associé</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span> <span class="o">=</span> <span class="n">lablevel</span></div>

<div class="viewcode-block" id="CommandManager.set_liste_robot"><a class="viewcode-back" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.commands.cmd_manager.CommandManager.html#labpyproject.apps.labpyrinthe.bus.commands.cmd_manager.CommandManager.set_liste_robot">[docs]</a>    <span class="k">def</span> <span class="nf">set_liste_robot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">listrobot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Définit la liste des robots</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_liste_robots</span> <span class="o">=</span> <span class="n">listrobot</span></div>

    <span class="c1">#-----&gt; Validation / application</span>
<div class="viewcode-block" id="CommandManager.analyse_cmd_for_robot"><a class="viewcode-back" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.commands.cmd_manager.CommandManager.html#labpyproject.apps.labpyrinthe.bus.commands.cmd_manager.CommandManager.analyse_cmd_for_robot">[docs]</a>    <span class="k">def</span> <span class="nf">analyse_cmd_for_robot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyse une commande</span>
<span class="sd">        </span>
<span class="sd">        Retourne un tuple avec :</span>
<span class="sd">        </span>
<span class="sd">        * un boolean indiquant si la commande a apporté un changement</span>
<span class="sd">        * le dict généré par CommandHelper.translate_cmd</span>
<span class="sd">        * une liste décrivant les conséquences (bonus gagné, danger activé, robot tué, </span>
<span class="sd">          grenade à lancer, case à ajouter)</span>
<span class="sd">        * la case visée par le coup        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dictcmd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">action</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">consequences</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">next_case</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dictcmd</span> <span class="o">=</span> <span class="n">CommandHelper</span><span class="o">.</span><span class="n">translate_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">consequences</span><span class="p">,</span> <span class="n">next_case</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">dictcmd</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">consequences</span><span class="p">,</span> <span class="n">next_case</span>
        <span class="c1"># cas particuliers :</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_HELP</span><span class="p">,</span>
            <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_QUIT</span><span class="p">,</span>
            <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_START</span><span class="p">,</span>
            <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_RESET_QUEUE</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="c1"># aucune validation à faire :</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dictcmd</span><span class="p">,</span> <span class="n">consequences</span><span class="p">,</span> <span class="n">next_case</span>
        <span class="c1"># cas général :</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">direct</span> <span class="o">=</span> <span class="n">dictcmd</span><span class="p">[</span><span class="s2">&quot;direct&quot;</span><span class="p">]</span>
        <span class="n">x_r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="n">y_r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">x_s</span><span class="p">,</span> <span class="n">y_s</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x_r</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y_r</span><span class="p">)</span>
        <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
        <span class="n">casesadj</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_cases_adjacentes</span><span class="p">(</span><span class="n">x_r</span><span class="p">,</span> <span class="n">y_r</span><span class="p">)</span>
        <span class="c1"># déplacement :</span>
        <span class="n">pas</span> <span class="o">=</span> <span class="n">dictcmd</span><span class="p">[</span><span class="s2">&quot;pas&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_MOVE</span><span class="p">:</span>
            <span class="n">pas</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">direct</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">LEFT</span><span class="p">:</span>
                <span class="n">next_case</span> <span class="o">=</span> <span class="n">casesadj</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span>
                <span class="n">x_r</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">direct</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">:</span>
                <span class="n">next_case</span> <span class="o">=</span> <span class="n">casesadj</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span>
                <span class="n">x_r</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">direct</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">TOP</span><span class="p">:</span>
                <span class="n">next_case</span> <span class="o">=</span> <span class="n">casesadj</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span>
                <span class="n">y_r</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">direct</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">BOTTOM</span><span class="p">:</span>
                <span class="n">next_case</span> <span class="o">=</span> <span class="n">casesadj</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span>
                <span class="n">y_r</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">possible</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_possible_todo_ACTION_on_case</span><span class="p">(</span><span class="n">next_case</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">possible</span><span class="p">:</span>
                <span class="c1"># déplacement possible</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># caractérisation :</span>
                <span class="n">nb_cases</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">x_r</span> <span class="o">-</span> <span class="n">x_s</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">y_r</span> <span class="o">-</span> <span class="n">y_s</span><span class="p">))</span>
                <span class="n">consequences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bot_move&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;robot&quot;</span><span class="p">:</span> <span class="n">robot</span><span class="p">,</span>
                        <span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">next_case</span><span class="p">,</span>
                        <span class="s2">&quot;coords1&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">x_s</span><span class="p">,</span> <span class="n">y_s</span><span class="p">),</span>
                        <span class="s2">&quot;coords2&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">x_r</span><span class="p">,</span> <span class="n">y_r</span><span class="p">),</span>
                        <span class="s2">&quot;nb_cases&quot;</span><span class="p">:</span> <span class="n">nb_cases</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="c1"># cas particuliers :</span>
                <span class="k">if</span> <span class="n">next_case</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_BONUS</span><span class="p">:</span>
                    <span class="n">consequences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bonus_win&quot;</span><span class="p">,</span> <span class="s2">&quot;robot&quot;</span><span class="p">:</span> <span class="n">robot</span><span class="p">,</span> <span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">next_case</span><span class="p">}</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">next_case</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_DANGER</span><span class="p">:</span>
                    <span class="n">consequences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;danger_activated&quot;</span><span class="p">,</span> <span class="s2">&quot;robot&quot;</span><span class="p">:</span> <span class="n">robot</span><span class="p">,</span> <span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">next_case</span><span class="p">}</span>
                    <span class="p">)</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_GRENADE</span><span class="p">:</span>
            <span class="n">puissance</span> <span class="o">=</span> <span class="n">dictcmd</span><span class="p">[</span><span class="s2">&quot;puissance&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">portee_grenade</span> <span class="o">&gt;=</span> <span class="n">pas</span> <span class="ow">and</span> <span class="n">robot</span><span class="o">.</span><span class="n">puissance_grenade</span> <span class="o">&gt;=</span> <span class="n">puissance</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_case_for_dir_and_pas</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">direct</span><span class="p">,</span> <span class="n">pas</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">target</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">target</span><span class="o">.</span><span class="n">type_case</span> <span class="ow">in</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_GRENADE</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">gdict</span> <span class="o">=</span> <span class="n">CaseGrenade</span><span class="o">.</span><span class="n">get_default_dict</span><span class="p">()</span>
                    <span class="n">gdict</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">x</span>
                    <span class="n">gdict</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">y</span>
                    <span class="n">gdict</span><span class="p">[</span><span class="s2">&quot;danger_impact&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">puissance</span>
                    <span class="n">gdict</span><span class="p">[</span><span class="s2">&quot;x_start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">x</span>
                    <span class="n">gdict</span><span class="p">[</span><span class="s2">&quot;y_start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span>
                    <span class="n">caseG</span> <span class="o">=</span> <span class="n">CaseGrenade</span><span class="p">(</span><span class="n">gdict</span><span class="p">)</span>
                    <span class="n">nb_cases</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_s</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_s</span><span class="p">))</span>
                    <span class="n">consequences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;launch_grenade&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;grenade&quot;</span><span class="p">:</span> <span class="n">caseG</span><span class="p">,</span>
                            <span class="s2">&quot;coords1&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">x_s</span><span class="p">,</span> <span class="n">y_s</span><span class="p">),</span>
                            <span class="s2">&quot;coords2&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">y</span><span class="p">),</span>
                            <span class="s2">&quot;nb_cases&quot;</span><span class="p">:</span> <span class="n">nb_cases</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># case visée</span>
            <span class="k">if</span> <span class="n">direct</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">LEFT</span><span class="p">:</span>
                <span class="n">next_case</span> <span class="o">=</span> <span class="n">casesadj</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">direct</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">:</span>
                <span class="n">next_case</span> <span class="o">=</span> <span class="n">casesadj</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">direct</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">TOP</span><span class="p">:</span>
                <span class="n">next_case</span> <span class="o">=</span> <span class="n">casesadj</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">direct</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">BOTTOM</span><span class="p">:</span>
                <span class="n">next_case</span> <span class="o">=</span> <span class="n">casesadj</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span>
            <span class="n">possible</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_possible_todo_ACTION_on_case</span><span class="p">(</span><span class="n">next_case</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">possible</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_CREATE_DOOR</span><span class="p">:</span>
                    <span class="c1"># on modifie le type de la case</span>
                    <span class="n">role</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_PORTE</span>
                    <span class="n">face</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">get_repr_for_role</span><span class="p">(</span><span class="n">role</span><span class="p">)</span>
                    <span class="n">case</span> <span class="o">=</span> <span class="n">Case</span><span class="p">(</span><span class="n">next_case</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">next_case</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">face</span><span class="p">)</span>
                    <span class="n">consequences</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;case_to_add&quot;</span><span class="p">,</span> <span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">case</span><span class="p">})</span>
                    <span class="k">if</span> <span class="n">next_case</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_DANGER</span><span class="p">:</span>
                        <span class="n">consequences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;danger_activated&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;robot&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">next_case</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
                <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_CREATE_WALL</span><span class="p">:</span>
                    <span class="n">role</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_MUR</span>
                    <span class="n">face</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">get_repr_for_role</span><span class="p">(</span><span class="n">role</span><span class="p">)</span>
                    <span class="n">case</span> <span class="o">=</span> <span class="n">Case</span><span class="p">(</span><span class="n">next_case</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">next_case</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">face</span><span class="p">)</span>
                    <span class="n">consequences</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;case_to_add&quot;</span><span class="p">,</span> <span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">case</span><span class="p">})</span>
                    <span class="k">if</span> <span class="n">next_case</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_DANGER</span><span class="p">:</span>
                        <span class="n">consequences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;danger_activated&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;robot&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">next_case</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
                <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_KILL</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">robot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_liste_robots</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">next_case</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">next_case</span><span class="o">.</span><span class="n">y</span><span class="p">):</span>
                            <span class="n">consequences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;robot_killed&quot;</span><span class="p">,</span> <span class="s2">&quot;robot&quot;</span><span class="p">:</span> <span class="n">next_case</span><span class="p">}</span>
                            <span class="p">)</span>
                            <span class="k">break</span>
                <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_MINE</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;puissance&quot;</span> <span class="ow">in</span> <span class="n">dictcmd</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">puissance</span> <span class="o">=</span> <span class="n">dictcmd</span><span class="p">[</span><span class="s2">&quot;puissance&quot;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">puissance</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">puissance_mine</span>
                    <span class="n">dictdanger</span> <span class="o">=</span> <span class="n">CaseDanger</span><span class="o">.</span><span class="n">get_default_dict</span><span class="p">()</span>
                    <span class="n">dictdanger</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_case</span><span class="o">.</span><span class="n">x</span>
                    <span class="n">dictdanger</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_case</span><span class="o">.</span><span class="n">y</span>
                    <span class="n">dictdanger</span><span class="p">[</span><span class="s2">&quot;danger_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CaseDanger</span><span class="o">.</span><span class="n">DANGER_MINE</span>
                    <span class="n">dictdanger</span><span class="p">[</span><span class="s2">&quot;danger_impact&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">puissance</span>
                    <span class="n">case</span> <span class="o">=</span> <span class="n">CaseDanger</span><span class="p">(</span><span class="n">dictdanger</span><span class="p">)</span>
                    <span class="n">consequences</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;case_to_add&quot;</span><span class="p">,</span> <span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">case</span><span class="p">})</span>
                    <span class="k">if</span> <span class="n">next_case</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_DANGER</span><span class="p">:</span>
                        <span class="n">consequences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;danger_activated&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;robot&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">next_case</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
        <span class="c1"># mémorisation des cmds invalides :</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_discard_cmd_for_gambleid</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">dictcmd</span><span class="p">,</span> <span class="n">consequences</span><span class="p">,</span> <span class="n">next_case</span></div>

    <span class="k">def</span> <span class="nf">_discard_cmd_for_gambleid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Invalide la cmd passée en paramètre</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_currentgambleid</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_discardedcmddict</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_pre_analyse_cmd_for_robot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Vérifie que la commande est ni nulle, ni mémorisée comme invalide.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valide</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">valide</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_currentgambleid</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_discardedcmddict</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">valide</span> <span class="o">=</span> <span class="n">cmd</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span>
        <span class="k">return</span> <span class="n">valide</span>

<div class="viewcode-block" id="CommandManager.validate_action_for_robot"><a class="viewcode-back" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.commands.cmd_manager.CommandManager.html#labpyproject.apps.labpyrinthe.bus.commands.cmd_manager.CommandManager.validate_action_for_robot">[docs]</a>    <span class="k">def</span> <span class="nf">validate_action_for_robot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">nextcase</span><span class="p">,</span> <span class="n">botskilled</span><span class="p">,</span> <span class="n">gambleid</span><span class="p">,</span> <span class="n">gamblenumber</span><span class="p">,</span> <span class="n">gamblecount</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialisations après application d&#39;une commande</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># enregistrement de l&#39;action :</span>
        <span class="n">robot</span><span class="o">.</span><span class="n">totalgamblecount</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># inc du nb de coups unitaires joués</span>
        <span class="n">robot</span><span class="o">.</span><span class="n">register_action</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">gambleid</span><span class="p">)</span>
        <span class="c1"># ... de la case</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_MOVE</span><span class="p">:</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">register_case</span><span class="p">(</span><span class="n">nextcase</span><span class="p">,</span> <span class="n">gambleid</span><span class="p">)</span>
        <span class="c1"># ... des bots éliminés</span>
        <span class="n">robot</span><span class="o">.</span><span class="n">register_bots_killed</span><span class="p">(</span><span class="n">botskilled</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gamblenumber</span> <span class="o">==</span> <span class="n">gamblecount</span><span class="p">:</span>
            <span class="c1"># ré init gdSet</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">register_current_gdSet</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="c1"># ré init vitesse courante</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">current_vitesse</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">vitesse</span>
            <span class="c1"># ... et zones :</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">update_bot_action_zones</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span></div>

    <span class="c1">#-----&gt; Initialisation du robot avant un coup</span>
<div class="viewcode-block" id="CommandManager.init_robot_before_gamble"><a class="viewcode-back" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.commands.cmd_manager.CommandManager.html#labpyproject.apps.labpyrinthe.bus.commands.cmd_manager.CommandManager.init_robot_before_gamble">[docs]</a>    <span class="k">def</span> <span class="nf">init_robot_before_gamble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">gamblenumber</span><span class="p">,</span> <span class="n">gamblecount</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Met à jour la vitesse actuelle du robot ainsi que ses zones de déplacement</span>
<span class="sd">        et d&#39;attaque</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">robot</span><span class="o">.</span><span class="n">current_vitesse</span> <span class="o">=</span> <span class="n">gamblecount</span> <span class="o">-</span> <span class="n">gamblenumber</span>
        <span class="n">robot</span><span class="o">.</span><span class="n">current_gamble_count</span> <span class="o">=</span> <span class="n">gamblecount</span>
        <span class="n">robot</span><span class="o">.</span><span class="n">current_gamble_number</span> <span class="o">=</span> <span class="n">gamblenumber</span>
        <span class="k">if</span> <span class="n">gamblenumber</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">create_gamble_coords_entry</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">update_bot_action_zones</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">nextgamble</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">case_sets_updated</span> <span class="o">=</span> <span class="kc">False</span></div>

    <span class="c1">#-----&gt; Calcul de commande pour Bots</span>
<div class="viewcode-block" id="CommandManager.compute_cmd_for_autobot"><a class="viewcode-back" href="../../../../../../api/labpyproject.apps.labpyrinthe.bus.commands.cmd_manager.CommandManager.html#labpyproject.apps.labpyrinthe.bus.commands.cmd_manager.CommandManager.compute_cmd_for_autobot">[docs]</a>    <span class="k">def</span> <span class="nf">compute_cmd_for_autobot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">gamblenumber</span><span class="p">,</span> <span class="n">gamblecount</span><span class="p">,</span> <span class="n">gambleid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Définit la cmd à appliquer à un robot automatique suivant son comportement</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            robot</span>
<span class="sd">            gamblenumber : numéro du coup (à partir de 1)</span>
<span class="sd">            gamblecount : nombre de coups consécutifs du joueur</span>
<span class="sd">            gambleid : id unique d&#39;un coup de la partie</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            cmd</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1- Initialisations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_currentgambleid</span> <span class="o">=</span> <span class="n">gambleid</span>
        <span class="c1"># - maj des listes ré utilisées :</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_usefull_sets</span><span class="p">()</span>
        <span class="c1"># - structure de données</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">gdmemory</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">gdSet</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gdmemory</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_GD_memory</span><span class="p">()</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">GambleDataSet</span><span class="p">(</span>
            <span class="n">gamblenumber</span><span class="o">=</span><span class="n">gamblenumber</span><span class="p">,</span>
            <span class="n">gamblecount</span><span class="o">=</span><span class="n">gamblecount</span><span class="p">,</span>
            <span class="n">gambleid</span><span class="o">=</span><span class="n">gambleid</span><span class="p">,</span>
            <span class="n">gdmemory</span><span class="o">=</span><span class="n">gdmemory</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">robot</span><span class="o">.</span><span class="n">register_current_gdSet</span><span class="p">(</span><span class="n">gdSet</span><span class="p">)</span>
        <span class="c1"># - initialisation du contexte</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_gamble_context</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="c1"># 2- Recueil de données :</span>
        <span class="n">do_compute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_need_to_compute_gamble_datas</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_compute</span><span class="p">:</span>
            <span class="c1"># - recueil de données maximal :</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_gamble_datas_for_bot</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
            <span class="c1"># - calculs de scores :</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_scores_to_gamble_datas</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
            <span class="c1"># - indique que l&#39;alimentation en données est effectuée :</span>
            <span class="n">gdSet</span><span class="o">.</span><span class="n">datas_computed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># 3- Ciblage:</span>
        <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">game_phasis</span> <span class="o">==</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PHASIS_FINAL</span><span class="p">:</span>
            <span class="c1"># - le chemin vers la cible est il valable?</span>
            <span class="n">mainTarget</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_main_target</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">mainTarget</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">maintp</span> <span class="o">=</span> <span class="n">mainTarget</span><span class="o">.</span><span class="n">targetpath</span>
                <span class="n">dodiscard</span><span class="p">,</span> <span class="n">newtp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_or_discard_TargetPath</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">maintp</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dodiscard</span><span class="p">:</span>
                    <span class="c1"># recherche du chemin vers la cible principale</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_search_final_TargetPath</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># mise à jour du chemin</span>
                    <span class="n">mainTarget</span><span class="o">.</span><span class="n">targetpath</span> <span class="o">=</span> <span class="n">newtp</span>
                    <span class="k">if</span> <span class="n">newtp</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">mainTarget</span><span class="o">.</span><span class="n">pathcost</span> <span class="o">=</span> <span class="n">newtp</span><span class="o">.</span><span class="n">cost</span>
        <span class="k">if</span> <span class="n">do_compute</span><span class="p">:</span>
            <span class="c1"># - redéfinition de la cible temporaire</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_select_new_temp_target</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="c1"># 4- Classement des options adjacentes</span>
        <span class="n">by_gdSet</span> <span class="o">=</span> <span class="n">do_compute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_adjacent_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">by_gdSet</span><span class="p">)</span>
        <span class="c1"># 5- Recherche d&#39;une série de coups?</span>
        <span class="n">do_schedule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_can_schedule_gambles</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_schedule</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_next_gambles</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="c1"># 6- Choix de la commande à appliquer :</span>
        <span class="c1"># - via une pseudo action anticipée ?</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cmd_for_next_pseudoaction</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="c1"># - choix de commande à l&#39;instant t :</span>
        <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_next_command</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="c1"># 7- ALT / Choix par défaut :</span>
        <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_force_cmd_choice_for_autobot</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cmd</span></div>

    <span class="k">def</span> <span class="nf">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Vérifie que la commande n&#39;a pas été invalidée auparavant, retourne</span>
<span class="sd">        None le cas échéant.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pré validation</span>
        <span class="n">valide</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_analyse_cmd_for_robot</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valide</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">cmd</span>

    <span class="c1">#-----&gt; B- Méthodes privées d&#39;analyse et de décision</span>
    <span class="c1">#-----&gt; B.1- Commande forcée en cas d&#39;échec des algos de décision</span>
    <span class="k">def</span> <span class="nf">_force_cmd_choice_for_autobot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Force le choix d&#39;une commande lorsqu&#39;aucun choix rationnel n&#39;a pu être</span>
<span class="sd">        établi.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">caseadj</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;all_adj&quot;</span><span class="p">)</span>
        <span class="c1"># on distingue cases libres, robots et cases dangers :</span>
        <span class="c1"># Rq : une case libre peut avoir été exclue car elle expose à un</span>
        <span class="c1"># adversaire dangereux</span>
        <span class="n">freelist</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">caseadj</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">type_case</span> <span class="ow">in</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_CASES_LIBRES</span><span class="p">]</span>
        <span class="n">murlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">caseadj</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_MUR</span><span class="p">]</span>
        <span class="n">botlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">caseadj</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_ROBOT</span><span class="p">]</span>
        <span class="n">dgrlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">caseadj</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_DANGER</span><span class="p">]</span>
        <span class="c1"># en fonction de l&#39;instinct de survie :</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">midSUR</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;instinct_survie&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">freelist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># on se déplace sur une case libre :</span>
            <span class="k">for</span> <span class="n">free</span> <span class="ow">in</span> <span class="n">freelist</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_simple_action</span><span class="p">(</span>
                    <span class="n">robot</span><span class="p">,</span>
                    <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_MOVE</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">},</span>
                    <span class="n">free</span><span class="p">,</span>
                    <span class="n">handlebehavior</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="c1"># on crée une porte:</span>
            <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">murlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">mur</span> <span class="ow">in</span> <span class="n">murlist</span><span class="p">:</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_simple_action</span><span class="p">(</span>
                        <span class="n">robot</span><span class="p">,</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_CREATE_DOOR</span><span class="p">,</span>
                            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_PORTE</span><span class="p">,</span>
                        <span class="p">},</span>
                        <span class="n">mur</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">break</span>
        <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># lancer de grenade?</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_random_launch_grenade</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">cmd</span> <span class="o">==</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">instinct_survie</span> <span class="o">&gt;</span> <span class="n">midSUR</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">botlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">freelist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dgrlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="c1"># on élimine un robot au hasard :</span>
            <span class="n">victim</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">CustomRandom</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">botlist</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_simple_action</span><span class="p">(</span>
                <span class="n">robot</span><span class="p">,</span>
                <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_KILL</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_KILL</span><span class="p">},</span>
                <span class="n">victim</span><span class="p">,</span>
                <span class="n">handlebehavior</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dgrlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># on se déplace sur une mine :</span>
            <span class="n">mine</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">CustomRandom</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">dgrlist</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_simple_action</span><span class="p">(</span>
                <span class="n">robot</span><span class="p">,</span>
                <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_MOVE</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">},</span>
                <span class="n">mine</span><span class="p">,</span>
                <span class="n">handlebehavior</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cmd</span>

    <span class="c1">#-----&gt; B.2- Initialisations</span>
    <span class="c1">#-----&gt; B.2.1- Cache de sets</span>
    <span class="k">def</span> <span class="nf">_update_usefull_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recalcul de listes (sets) ré utilisées pendant les calculs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1- Sets de robots</span>
        <span class="c1"># robots en activité</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alive_bots</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_liste_robots</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">alive</span><span class="p">])</span>
        <span class="c1"># et humains</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">human_alive</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alive_bots</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">human</span><span class="p">])</span>
        <span class="c1"># et winners</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">winner_alive</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alive_bots</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_WINNER</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># et hunters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hunter_alive</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alive_bots</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_HUNTER</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># humains et winners</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">winner_human_alive</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">r</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alive_bots</span>
                <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_WINNER</span> <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">human</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># les trois</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">winner_human_hunter_alive</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">r</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alive_bots</span>
                <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_WINNER</span>
                <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_HUNTER</span>
                <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">human</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># 2- Sets de cases :</span>
        <span class="c1"># cases dangers :</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dangers_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_typecase_set</span><span class="p">(</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_DANGER</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dangers_set_1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dangers_set</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">danger_impact</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dangers_set_plus1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dangers_set</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dangers_set_1</span><span class="p">)</span>
        <span class="c1"># cases bonus :</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonus_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_typecase_set</span><span class="p">(</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_BONUS</span><span class="p">)</span>
        <span class="c1"># cases &quot;jouables&quot; (ie hors murs extérieurs)</span>
        <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
        <span class="n">full_set</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_set_cases</span><span class="p">()</span>
        <span class="n">murs_ext_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_typecase_set</span><span class="p">(</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_MUR_PERIMETRE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">play_set</span> <span class="o">=</span> <span class="n">full_set</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">murs_ext_set</span><span class="p">)</span>
        <span class="c1"># 3- marqueur</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">case_sets_updated</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1">#-----&gt; B.2.2- Initialisations (reconnaissance globale, évaluation des cibles, phase de jeu)</span>
    <span class="k">def</span> <span class="nf">_init_gamble_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise les cibles avant le processus de choix de commande</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># repérage de l&#39;environnement</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_recognize_area</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="c1"># mise à jour des références :</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_target_ref</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_temp_target</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_target_ref</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_main_target</span><span class="p">())</span>
        <span class="c1"># cible principale :</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_define_mainTarget</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="c1"># cible temporaire :</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_temp_target</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="n">tempTarget</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_temp_target</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tempTarget</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tempTarget</span><span class="o">.</span><span class="n">discarded</span><span class="p">:</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">set_temp_target</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="c1"># phase de jeu :</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_robot_gamePhasis</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="c1"># winners et hunters : besoin de bonus ?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bot_need_to_earn_bonus</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="c1"># winners : des concurrents sont ils proches de la sortie?</span>
        <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_WINNER</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_are_adversaires_in_advance</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_recognize_area</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Repère :</span>
<span class="sd">        </span>
<span class="sd">        * les robots contre lesquels se défendre</span>
<span class="sd">        * ceux que l&#39;on peut toucher</span>
<span class="sd">        * les cases &quot;safe&quot;</span>
<span class="sd">        * les dangers pouvant nous atteindre en cas d&#39;explosion</span>
<span class="sd">        * les bonus à portée            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># paramètres :</span>
        <span class="n">rlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alive_bots</span> <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="n">robot</span><span class="p">]</span>
        <span class="n">move_zone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_caseset_for_coordset</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">move_zone</span><span class="p">)</span>
        <span class="n">attack_zone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_caseset_for_coordset</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">attack_zone</span><span class="p">)</span>
        <span class="c1"># analyse :</span>
        <span class="n">rdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;attaque&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(),</span>
            <span class="s2">&quot;defense&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(),</span>
            <span class="s2">&quot;safezone&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(),</span>
            <span class="s2">&quot;realsafezone&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(),</span>  <span class="c1"># cases de safezone hors de portée d&#39;une mine</span>
            <span class="s2">&quot;dangers&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(),</span>
            <span class="s2">&quot;bonus&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(),</span>
            <span class="s2">&quot;attaque_all&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(),</span>
            <span class="s2">&quot;defense_all&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(),</span>
            <span class="s2">&quot;extendedunsafezone&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(),</span>
            <span class="s2">&quot;kill_all&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(),</span>
        <span class="p">}</span>
        <span class="c1"># défense et attaque :</span>
        <span class="n">safe_set</span> <span class="o">=</span> <span class="n">move_zone</span>  <span class="c1"># cases sûres / coups directs</span>
        <span class="n">ext_unsafe_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># zone étendue des cases attaquables</span>
        <span class="k">for</span> <span class="n">bot</span> <span class="ow">in</span> <span class="n">rlist</span><span class="p">:</span>
            <span class="c1"># attaque :</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_may_firstbot_attack_otherbot</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">bot</span><span class="p">):</span>
                <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;attaque_all&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bot</span><span class="p">)</span>
                <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;kill_all&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bot</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bot</span> <span class="ow">in</span> <span class="n">attack_zone</span><span class="p">:</span>
                    <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;attaque&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bot</span><span class="p">)</span>
            <span class="c1"># défense :</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_may_firstbot_attack_otherbot</span><span class="p">(</span><span class="n">bot</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
                <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;defense_all&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bot</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;kill_all&quot;</span><span class="p">]:</span>
                    <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;kill_all&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bot</span><span class="p">)</span>
                <span class="n">bot_attaque</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_caseset_for_coordset</span><span class="p">(</span><span class="n">bot</span><span class="o">.</span><span class="n">attack_zone</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">robot</span> <span class="ow">in</span> <span class="n">bot_attaque</span><span class="p">:</span>
                    <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;defense&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bot</span><span class="p">)</span>
                <span class="n">safe_set</span> <span class="o">=</span> <span class="n">safe_set</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">bot_attaque</span><span class="p">)</span>
                <span class="n">ext_unsafe_set</span> <span class="o">=</span> <span class="n">ext_unsafe_set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">bot_attaque</span><span class="p">)</span>
        <span class="c1"># zone safe et realsafezone :</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ext_unsafe_set</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">safe_set</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># si il y a des adversaires dangereux et des cases à priori sûres</span>
            <span class="n">t_h</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">THRES_HIGH</span>
            <span class="n">instinct_survie</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">instinct_survie</span>
            <span class="n">intelligence</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">intelligence</span>
            <span class="k">if</span> <span class="n">instinct_survie</span> <span class="o">&gt;=</span> <span class="n">t_h</span> <span class="ow">or</span> <span class="n">intelligence</span> <span class="o">&gt;=</span> <span class="n">t_h</span><span class="p">:</span>
                <span class="c1"># on prend en compte l&#39;exposition des cases aux mines</span>
                <span class="n">real_safe_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">safe_set</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_case_surrounded_by_mine</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                        <span class="n">real_safe_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;realsafezone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">real_safe_list</span>
        <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;safezone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">safe_set</span><span class="p">)</span>
        <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;extendedunsafezone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ext_unsafe_set</span><span class="p">)</span>
        <span class="c1"># trie :</span>
        <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;defense&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;aggressivite&quot;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;attaque&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;aggressivite&quot;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
        <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;attaque_all&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">dfunc</span><span class="p">)</span>
        <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;defense_all&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">dfunc</span><span class="p">)</span>
        <span class="c1"># dangers :</span>
        <span class="c1"># les dangers dans la sous matrice 5*5 centrée sur robot</span>
        <span class="n">dgr_set</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_minelist_arround_case</span><span class="p">(</span><span class="n">robot</span><span class="p">))</span>
        <span class="c1"># sélection des dangers pouvant impacter le robot (sans récursivité) :</span>
        <span class="k">for</span> <span class="n">dgr</span> <span class="ow">in</span> <span class="n">dgr_set</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_does_mine_impact_case</span><span class="p">(</span><span class="n">dgr</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
                <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;dangers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dgr</span><span class="p">)</span>
        <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;dangers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;danger_impact&quot;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># bonus : à portée</span>
        <span class="n">bonus_set</span> <span class="o">=</span> <span class="n">move_zone</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonus_set</span><span class="p">)</span>
        <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;bonus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bonus_set</span><span class="p">)</span>
        <span class="c1"># enregistrement :</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">gdSet</span><span class="o">.</span><span class="n">register_list_case</span><span class="p">(</span><span class="s2">&quot;defense&quot;</span><span class="p">,</span> <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;defense&quot;</span><span class="p">])</span>
        <span class="n">gdSet</span><span class="o">.</span><span class="n">register_list_case</span><span class="p">(</span><span class="s2">&quot;defense_all&quot;</span><span class="p">,</span> <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;defense_all&quot;</span><span class="p">])</span>
        <span class="n">gdSet</span><span class="o">.</span><span class="n">register_list_case</span><span class="p">(</span><span class="s2">&quot;attaque&quot;</span><span class="p">,</span> <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;attaque&quot;</span><span class="p">])</span>
        <span class="n">gdSet</span><span class="o">.</span><span class="n">register_list_case</span><span class="p">(</span><span class="s2">&quot;attaque_all&quot;</span><span class="p">,</span> <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;attaque_all&quot;</span><span class="p">])</span>
        <span class="n">gdSet</span><span class="o">.</span><span class="n">register_list_case</span><span class="p">(</span><span class="s2">&quot;kill_all&quot;</span><span class="p">,</span> <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;kill_all&quot;</span><span class="p">])</span>
        <span class="n">gdSet</span><span class="o">.</span><span class="n">register_list_case</span><span class="p">(</span><span class="s2">&quot;safezone&quot;</span><span class="p">,</span> <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;safezone&quot;</span><span class="p">])</span>
        <span class="n">gdSet</span><span class="o">.</span><span class="n">register_list_case</span><span class="p">(</span><span class="s2">&quot;realsafezone&quot;</span><span class="p">,</span> <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;realsafezone&quot;</span><span class="p">])</span>
        <span class="n">gdSet</span><span class="o">.</span><span class="n">register_list_case</span><span class="p">(</span><span class="s2">&quot;extendedunsafezone&quot;</span><span class="p">,</span> <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;extendedunsafezone&quot;</span><span class="p">])</span>
        <span class="n">gdSet</span><span class="o">.</span><span class="n">register_list_case</span><span class="p">(</span><span class="s2">&quot;dangers&quot;</span><span class="p">,</span> <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;dangers&quot;</span><span class="p">])</span>
        <span class="n">gdSet</span><span class="o">.</span><span class="n">register_list_case</span><span class="p">(</span><span class="s2">&quot;bonus&quot;</span><span class="p">,</span> <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;bonus&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_update_target_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Met à jour les références aux cases des cibles</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">target</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">oldcase</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">case</span>
            <span class="k">if</span> <span class="n">oldcase</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_ROBOT</span><span class="p">:</span>
                <span class="n">target</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">oldcase</span><span class="o">.</span><span class="n">x</span>
                <span class="n">target</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">oldcase</span><span class="o">.</span><span class="n">y</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
                <span class="n">newcase</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">oldcase</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">oldcase</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
                <span class="n">target</span><span class="o">.</span><span class="n">case</span> <span class="o">=</span> <span class="n">newcase</span>

    <span class="k">def</span> <span class="nf">_define_mainTarget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Affecte une cible principale au robot en fonction de son comportement</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
        <span class="n">mainTarget</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_main_target</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mainTarget</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">maincase</span> <span class="o">=</span> <span class="n">mainTarget</span><span class="o">.</span><span class="n">case</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">maincase</span><span class="p">,</span> <span class="n">CaseRobot</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">maincase</span><span class="o">.</span><span class="n">alive</span><span class="p">:</span>
                <span class="n">robot</span><span class="o">.</span><span class="n">set_main_target</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">mainTarget</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">case_sortie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_case_sortie</span><span class="p">()</span>
        <span class="n">targetsortie</span> <span class="o">=</span> <span class="n">TargetObject</span><span class="p">(</span><span class="n">TargetObject</span><span class="o">.</span><span class="n">TARGET_MAIN</span><span class="p">,</span> <span class="n">case_sortie</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_WINNER</span><span class="p">:</span>
            <span class="c1"># la sortie</span>
            <span class="k">if</span> <span class="n">mainTarget</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">robot</span><span class="o">.</span><span class="n">set_main_target</span><span class="p">(</span><span class="n">targetsortie</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_HUNTER</span><span class="p">:</span>
            <span class="c1"># un robot à éliminer (huamin ou winner &gt; autres)</span>
            <span class="n">casehunt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_bot_for_hunter</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">casehunt</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># par défaut on se rapproche de la sortie</span>
                <span class="n">robot</span><span class="o">.</span><span class="n">set_main_target</span><span class="p">(</span><span class="n">targetsortie</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">targethunt</span> <span class="o">=</span> <span class="n">TargetObject</span><span class="p">(</span><span class="n">TargetObject</span><span class="o">.</span><span class="n">TARGET_MAIN</span><span class="p">,</span> <span class="n">casehunt</span><span class="p">)</span>
                <span class="n">robot</span><span class="o">.</span><span class="n">set_main_target</span><span class="p">(</span><span class="n">targethunt</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_SAPPER</span><span class="p">:</span>
            <span class="c1"># le barycentre d&#39;une zone à faible densité de mines</span>
            <span class="c1"># dès la zone atteinte on redéfinit une nouvelle cible</span>
            <span class="k">if</span> <span class="n">mainTarget</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_bot_on_work_area</span><span class="p">(</span><span class="n">robot</span><span class="p">):</span>
                <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_density_area</span><span class="p">([</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_DANGER</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">casemain</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span>
                    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">targetmain</span> <span class="o">=</span> <span class="n">TargetObject</span><span class="p">(</span><span class="n">TargetObject</span><span class="o">.</span><span class="n">TARGET_MAIN</span><span class="p">,</span> <span class="n">casemain</span><span class="p">)</span>
                <span class="n">robot</span><span class="o">.</span><span class="n">set_main_target</span><span class="p">(</span><span class="n">targetmain</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_BUILDER</span><span class="p">:</span>
            <span class="c1"># le barycentre d&#39;une zone à faible densité de murs</span>
            <span class="c1"># dès la zone atteinte on redéfinit une nouvelle cible</span>
            <span class="k">if</span> <span class="n">mainTarget</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_bot_on_work_area</span><span class="p">(</span><span class="n">robot</span><span class="p">):</span>
                <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_density_area</span><span class="p">([</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_MUR</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">casemain</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span>
                    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">targetmain</span> <span class="o">=</span> <span class="n">TargetObject</span><span class="p">(</span><span class="n">TargetObject</span><span class="o">.</span><span class="n">TARGET_MAIN</span><span class="p">,</span> <span class="n">casemain</span><span class="p">)</span>
                <span class="n">robot</span><span class="o">.</span><span class="n">set_main_target</span><span class="p">(</span><span class="n">targetmain</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span> <span class="ow">in</span> <span class="p">[</span><span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_TOURIST</span><span class="p">,</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_RANDOM</span><span class="p">]:</span>
            <span class="c1"># une case au hasard :</span>
            <span class="k">if</span> <span class="n">mainTarget</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_bot_on_work_area</span><span class="p">(</span><span class="n">robot</span><span class="p">):</span>
                <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_dimensions</span><span class="p">()</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">CustomRandom</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">CustomRandom</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">casemain</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                <span class="n">targetmain</span> <span class="o">=</span> <span class="n">TargetObject</span><span class="p">(</span><span class="n">TargetObject</span><span class="o">.</span><span class="n">TARGET_MAIN</span><span class="p">,</span> <span class="n">casemain</span><span class="p">)</span>
                <span class="n">robot</span><span class="o">.</span><span class="n">set_main_target</span><span class="p">(</span><span class="n">targetmain</span><span class="p">)</span>
        <span class="c1"># directions vers la cible principale (ou None)</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">gdSet</span><span class="o">.</span><span class="n">maintarget_directions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dirs_to_mainTarget</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_evaluate_temp_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evalue la validité de la précédente cible temporaire, mise à jour</span>
<span class="sd">        éventuelle du chemin pour y parvenir</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tempTarget</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_temp_target</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tempTarget</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dodiscard</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">case</span> <span class="o">=</span> <span class="n">tempTarget</span><span class="o">.</span><span class="n">case</span>
            <span class="c1"># cas particuliers</span>
            <span class="n">maintarget</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_main_target</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">maintarget</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">distmain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">maintarget</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">distmain</span> <span class="o">&lt;</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">DIST_APPROACH</span><span class="p">:</span>
                    <span class="n">tempTarget</span><span class="o">.</span><span class="n">discarded</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">return</span>
            <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_last_action</span><span class="p">()</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_GRENADE</span><span class="p">:</span>
                <span class="n">tempTarget</span><span class="o">.</span><span class="n">discarded</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span>
            <span class="c1"># 1- cible atteinte ?</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">case</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">case</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span><span class="p">):</span>
                <span class="c1"># cible atteinte :</span>
                <span class="n">dodiscard</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 2- test sur la nature de la cible :</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">case</span><span class="o">.</span><span class="n">type_case</span> <span class="ow">in</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_TARGET</span><span class="p">:</span>
                    <span class="c1"># la cible a changé de nature, on invalide :</span>
                    <span class="n">dodiscard</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># 3- test du parcours précédent :</span>
                    <span class="n">targetpath</span> <span class="o">=</span> <span class="n">tempTarget</span><span class="o">.</span><span class="n">targetpath</span>
                    <span class="n">dodiscard</span><span class="p">,</span> <span class="n">newpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_or_discard_TargetPath</span><span class="p">(</span>
                        <span class="n">robot</span><span class="p">,</span> <span class="n">targetpath</span>
                    <span class="p">)</span>
                    <span class="n">tempTarget</span><span class="o">.</span><span class="n">targetpath</span> <span class="o">=</span> <span class="n">newpath</span>
                    <span class="k">if</span> <span class="n">newpath</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">tempTarget</span><span class="o">.</span><span class="n">pathcost</span> <span class="o">=</span> <span class="n">newpath</span><span class="o">.</span><span class="n">cost</span>
            <span class="c1"># si la cible reste valable, on met à jour la liste de cases :</span>
            <span class="c1"># (leur nature a pu changer)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dodiscard</span><span class="p">:</span>
                <span class="n">prevlistcases</span> <span class="o">=</span> <span class="n">tempTarget</span><span class="o">.</span><span class="n">listcases</span>
                <span class="n">prevcoords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">prevlistcases</span><span class="p">]</span>
                <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
                <span class="n">newlistcases</span> <span class="o">=</span> <span class="p">[</span><span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="o">*</span><span class="n">coords</span><span class="p">)</span> <span class="k">for</span> <span class="n">coords</span> <span class="ow">in</span> <span class="n">prevcoords</span><span class="p">]</span>
                <span class="n">tempTarget</span><span class="o">.</span><span class="n">listcases</span> <span class="o">=</span> <span class="n">newlistcases</span>
            <span class="c1"># validation de la cible temporaire :</span>
            <span class="n">tempTarget</span><span class="o">.</span><span class="n">discarded</span> <span class="o">=</span> <span class="n">dodiscard</span>

    <span class="k">def</span> <span class="nf">_update_robot_gamePhasis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mise à jour de la phase de jeu du robot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phasis</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_WINNER</span><span class="p">:</span>
            <span class="n">phasis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_winner_game_phasis</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_HUNTER</span><span class="p">:</span>
            <span class="n">phasis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_hunter_game_phasis</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># phase standard par défaut</span>
            <span class="n">phasis</span> <span class="o">=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PHASIS_IN_PROGRESS</span>
        <span class="c1"># enregistrement</span>
        <span class="n">robot</span><span class="o">.</span><span class="n">game_phasis</span> <span class="o">=</span> <span class="n">phasis</span>

    <span class="k">def</span> <span class="nf">_is_bot_on_work_area</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Indique si le robot est dans sa zone de travail</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mainparams</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_main_target_params</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mainparams</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_TOURIST</span><span class="p">,</span>
                <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_RANDOM</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="c1"># est on proche de la cible ?</span>
                <span class="n">maintarget</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_main_target</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">maintarget</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">distmain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span>
                        <span class="n">robot</span><span class="p">,</span> <span class="n">maintarget</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">distmain</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="n">zone</span> <span class="o">=</span> <span class="n">mainparams</span><span class="p">[</span><span class="s2">&quot;submatrice&quot;</span><span class="p">]</span>
        <span class="n">ltpt</span> <span class="o">=</span> <span class="n">zone</span><span class="o">.</span><span class="n">get_lefttop_point</span><span class="p">()</span>
        <span class="n">ws</span><span class="p">,</span> <span class="n">hs</span> <span class="o">=</span> <span class="n">zone</span><span class="o">.</span><span class="n">get_dimensions</span><span class="p">()</span>
        <span class="n">x_r</span><span class="p">,</span> <span class="n">y_r</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ltpt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x_r</span> <span class="o">&lt;=</span> <span class="n">ltpt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ws</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ltpt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">y_r</span> <span class="o">&lt;=</span> <span class="n">ltpt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">hs</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_find_density_area</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">listtypecase</span><span class="p">,</span> <span class="n">lowdensity</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retourne la zone de plus faible/forte densité en cases de type typecase</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">h</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wm</span><span class="p">,</span> <span class="n">hm</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_dimensions</span><span class="p">()</span>
            <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">wm</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">hm</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">listsm</span> <span class="o">=</span> <span class="n">LabGenerator</span><span class="o">.</span><span class="n">sample_submatrices</span><span class="p">(</span><span class="n">flatmatrice</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
        <span class="n">listres</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sm</span> <span class="ow">in</span> <span class="n">listsm</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sm</span><span class="o">.</span><span class="n">get_dimensions</span><span class="p">()</span> <span class="o">==</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
                <span class="n">dens</span> <span class="o">=</span> <span class="n">LabGenerator</span><span class="o">.</span><span class="n">estime_densite</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">listtypecase</span><span class="p">)</span>
                <span class="n">listres</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;submatrice&quot;</span><span class="p">:</span> <span class="n">sm</span><span class="p">,</span> <span class="s2">&quot;densite&quot;</span><span class="p">:</span> <span class="n">dens</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">lowdensity</span><span class="p">:</span>
            <span class="n">listres</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;densite&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">listres</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;densite&quot;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">submatrice</span> <span class="o">=</span> <span class="n">listres</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;submatrice&quot;</span><span class="p">]</span>
        <span class="n">initial_densite</span> <span class="o">=</span> <span class="n">listres</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;densite&quot;</span><span class="p">]</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">submatrice</span><span class="o">.</span><span class="n">get_lefttop_point</span><span class="p">()</span>
        <span class="n">ws</span><span class="p">,</span> <span class="n">hs</span> <span class="o">=</span> <span class="n">submatrice</span><span class="o">.</span><span class="n">get_dimensions</span><span class="p">()</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ws</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">hs</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;submatrice&quot;</span><span class="p">:</span> <span class="n">submatrice</span><span class="p">,</span>
            <span class="s2">&quot;center&quot;</span><span class="p">:</span> <span class="n">center</span><span class="p">,</span>
            <span class="s2">&quot;initial_densite&quot;</span><span class="p">:</span> <span class="n">initial_densite</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="c1">#-----&gt; B.2.3- Initialisations spécifiques</span>
    <span class="k">def</span> <span class="nf">_bot_need_to_earn_bonus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Indique si le bot devrait obtenir des bonus.</span>
<span class="sd">        Retourne un boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">behavior</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span>
        <span class="n">do_need</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">behavior</span> <span class="ow">in</span> <span class="p">[</span><span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_WINNER</span><span class="p">,</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_HUNTER</span><span class="p">]:</span>
            <span class="n">highQI</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;intelligence&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">)</span>
            <span class="n">midEFF</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;efficacite&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
            <span class="n">midAMB</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;ambition&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
            <span class="n">winhum</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">winner_human_alive</span> <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="n">robot</span><span class="p">]</span>
            <span class="n">nb_winhum</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">winhum</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">robot</span><span class="o">.</span><span class="n">intelligence</span> <span class="o">&gt;</span> <span class="n">highQI</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">efficacite</span> <span class="o">+</span> <span class="n">robot</span><span class="o">.</span><span class="n">ambition</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">midEFF</span> <span class="o">+</span> <span class="n">midAMB</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">intelligence</span> <span class="o">&gt;</span> <span class="n">highQI</span> <span class="ow">and</span> <span class="n">robot</span><span class="o">.</span><span class="n">vitesse</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">do_need</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">robot</span><span class="o">.</span><span class="n">game_phasis</span> <span class="o">==</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PHASIS_START</span><span class="p">:</span>
                    <span class="n">do_need</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">listebots</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">winner_human_hunter_alive</span> <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="n">robot</span>
                    <span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">listebots</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># capacités moyennes et max (humains, winners, hunters)</span>
                        <span class="n">nb_bonus_moy</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">nb_bonus_max</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">vit_moy</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">vit_max</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">listebots</span><span class="p">:</span>
                            <span class="n">vit_moy</span> <span class="o">+=</span> <span class="n">r</span><span class="o">.</span><span class="n">vitesse</span>
                            <span class="n">vit_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">vit_max</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">vitesse</span><span class="p">)</span>
                            <span class="n">nb_bonus_moy</span> <span class="o">+=</span> <span class="n">r</span><span class="o">.</span><span class="n">earned_bonus</span>
                            <span class="n">nb_bonus_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">nb_bonus_max</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">earned_bonus</span><span class="p">)</span>
                        <span class="n">vit_moy</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">listebots</span><span class="p">)</span>
                        <span class="n">nb_bonus_moy</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">listebots</span><span class="p">)</span>
                        <span class="c1"># comparaison</span>
                        <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">intelligence</span> <span class="o">&gt;</span> <span class="n">robot</span><span class="o">.</span><span class="n">ambition</span><span class="p">:</span>
                            <span class="n">fact</span> <span class="o">=</span> <span class="mf">0.5</span>
                            <span class="n">op</span> <span class="o">=</span> <span class="nb">min</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fact</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">ambition</span>
                            <span class="n">op</span> <span class="o">=</span> <span class="nb">max</span>
                        <span class="n">comp_vitesse</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">vitesse</span> <span class="o">&lt;</span> <span class="n">op</span><span class="p">(</span><span class="n">vit_moy</span><span class="p">,</span> <span class="n">vit_max</span> <span class="o">*</span> <span class="n">fact</span><span class="p">)</span>
                        <span class="n">comp_bonus</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">earned_bonus</span> <span class="o">&lt;</span> <span class="n">op</span><span class="p">(</span>
                            <span class="n">nb_bonus_moy</span><span class="p">,</span> <span class="n">nb_bonus_max</span> <span class="o">*</span> <span class="n">fact</span>
                        <span class="p">)</span>
                        <span class="n">do_need</span> <span class="o">=</span> <span class="n">comp_vitesse</span> <span class="ow">or</span> <span class="n">comp_bonus</span>
            <span class="c1"># si il n&#39;y a plus de winners ou d&#39;humains :</span>
            <span class="k">if</span> <span class="n">nb_winhum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">do_need</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># maj robot</span>
        <span class="n">robot</span><span class="o">.</span><span class="n">need_bonus</span> <span class="o">=</span> <span class="n">do_need</span>
        <span class="c1"># stratégie de recherche de bonus :</span>
        <span class="c1"># Rq : pour un winner, fonction de l&#39;avance des adversaire,</span>
        <span class="c1"># paramètre défini dans _are_adversaires_in_advance</span>
        <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">need_bonus</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_HUNTER</span><span class="p">:</span>
                <span class="c1"># en fonction de la phase de jeu :</span>
                <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">game_phasis</span> <span class="o">==</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PHASIS_HUNT</span><span class="p">:</span>
                    <span class="c1"># le robot doit suivre sa cible, on limite la recherche</span>
                    <span class="n">robot</span><span class="o">.</span><span class="n">bonus_strategy</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">STRAT_BONUS_TARGET</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># recherche de bonus tous azimuts</span>
                    <span class="n">robot</span><span class="o">.</span><span class="n">bonus_strategy</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">STRAT_BONUS_ALL</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">bonus_strategy</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#-----&gt; Winner</span>
    <span class="k">def</span> <span class="nf">_update_winner_game_phasis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Met à jour la phase de jeu d&#39;un Winner</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phasis</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># données carto</span>
        <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
        <span class="n">diag</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_diagonale_len</span><span class="p">()</span>
        <span class="n">case_sortie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_case_sortie</span><span class="p">()</span>
        <span class="c1"># nombre total de coups unitaires joués :</span>
        <span class="n">totalgamblecount</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">totalgamblecount</span>
        <span class="c1"># nombre de coups décrivant la phase de début de partie :</span>
        <span class="n">startgamblecount</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">diag</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">totalgamblecount</span> <span class="o">&lt;</span> <span class="n">startgamblecount</span><span class="p">:</span>
            <span class="c1"># phase de démarrage</span>
            <span class="n">phasis</span> <span class="o">=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PHASIS_START</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dist_sortie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_path_length_between_cases</span><span class="p">(</span>
                <span class="n">robot</span><span class="p">,</span> <span class="n">case_sortie</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">dist_sortie</span> <span class="o">&lt;=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">DIST_APPROACH</span><span class="p">:</span>
                <span class="c1"># phase finale d&#39;approche de la cible</span>
                <span class="n">phasis</span> <span class="o">=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PHASIS_FINAL</span>
            <span class="k">elif</span> <span class="n">dist_sortie</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">DIST_APPROACH</span><span class="p">:</span>
                <span class="c1"># phase initiale d&#39;approche de la cible</span>
                <span class="n">phasis</span> <span class="o">=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PHASIS_APPROACH</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># phase standard</span>
                <span class="n">phasis</span> <span class="o">=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PHASIS_IN_PROGRESS</span>
        <span class="k">return</span> <span class="n">phasis</span>

    <span class="k">def</span> <span class="nf">_are_adversaires_in_advance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recherche les winners et humains proches de gagner. Enregistre les</span>
<span class="sd">        résultats dans le gdSet du robot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># données carto</span>
        <span class="n">case_sortie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_case_sortie</span><span class="p">()</span>
        <span class="c1"># adversaires humains ou winners :</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">kill_all</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;kill_all&quot;</span><span class="p">)</span>
        <span class="n">advlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">winner_human_alive</span> <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="n">robot</span> <span class="ow">and</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">kill_all</span><span class="p">]</span>
        <span class="c1"># mesures de proximité, enregistrement des adversaires en phases</span>
        <span class="c1"># d&#39;approche et en phase finale et update de leur ppté game_phasis</span>
        <span class="n">adv_in_approach</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">adv_in_final</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">approach_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">final_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
        <span class="n">mindist</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_diagonale_len</span><span class="p">()</span>
        <span class="n">complist</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">winner_human_alive</span> <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="n">robot</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">complist</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">complist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">complist</span><span class="p">:</span>
                <span class="n">drs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_path_length_between_cases</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">case_sortie</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">drs</span> <span class="o">&lt;=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">DIST_APPROACH</span> <span class="ow">and</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">advlist</span><span class="p">:</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">game_phasis</span> <span class="o">=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PHASIS_FINAL</span>
                    <span class="n">final_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">drs</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">DIST_APPROACH</span> <span class="ow">and</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">advlist</span><span class="p">:</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">game_phasis</span> <span class="o">=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PHASIS_APPROACH</span>
                    <span class="n">approach_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">game_phasis</span> <span class="o">=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PHASIS_IN_PROGRESS</span>
                <span class="n">mindist</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">mindist</span><span class="p">,</span> <span class="n">drs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">adv_in_final</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">approach_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">adv_in_approach</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># position du robot</span>
        <span class="n">drs_robot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_path_length_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">case_sortie</span><span class="p">)</span>
        <span class="c1"># qualification du retard :</span>
        <span class="n">delta_bot_min</span> <span class="o">=</span> <span class="n">drs_robot</span> <span class="o">-</span> <span class="n">mindist</span>
        <span class="k">if</span> <span class="n">delta_bot_min</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">retard</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">elif</span> <span class="n">delta_bot_min</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">retard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">delta_bot_min</span> <span class="o">&lt;</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">DIST_APPROACH</span><span class="p">:</span>
            <span class="n">retard</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">delta_bot_min</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">DIST_APPROACH</span><span class="p">:</span>
            <span class="n">retard</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">retard</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="c1"># stratégie de recherche de bonus :</span>
        <span class="n">strategy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">need_bonus</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">retard</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span>
                <span class="c1"># le robot est en avance</span>
                <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">game_phasis</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="n">CommandManager</span><span class="o">.</span><span class="n">PHASIS_APPROACH</span><span class="p">,</span>
                    <span class="n">CommandManager</span><span class="o">.</span><span class="n">PHASIS_FINAL</span><span class="p">,</span>
                <span class="p">]:</span>
                    <span class="c1"># il est presque arrivé, on suit la cible</span>
                    <span class="n">strategy</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">STRAT_BONUS_TARGET</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># il peut chercher n&#39;importe quel bonus</span>
                    <span class="n">strategy</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">STRAT_BONUS_ALL</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">adv_in_final</span> <span class="ow">or</span> <span class="n">adv_in_approach</span><span class="p">:</span>
                    <span class="c1"># le robot doit suivre sa cible, on limite la recherche</span>
                    <span class="n">strategy</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">STRAT_BONUS_TARGET</span>
                <span class="k">elif</span> <span class="n">retard</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># le robot n&#39;a pas beaucoup de retard, les adversaires</span>
                    <span class="c1"># sont loin de la sortie</span>
                    <span class="n">strategy</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">STRAT_BONUS_ALL</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># le robot est vraiment en retard</span>
                    <span class="n">strategy</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">STRAT_BONUS_TARGET</span>
        <span class="n">robot</span><span class="o">.</span><span class="n">bonus_strategy</span> <span class="o">=</span> <span class="n">strategy</span>
        <span class="c1"># résultat</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;adv_in_final&quot;</span><span class="p">:</span> <span class="n">adv_in_final</span><span class="p">,</span>
            <span class="s2">&quot;adv_in_approach&quot;</span><span class="p">:</span> <span class="n">adv_in_approach</span><span class="p">,</span>
            <span class="s2">&quot;final_list&quot;</span><span class="p">:</span> <span class="n">final_list</span><span class="p">,</span>
            <span class="s2">&quot;approach_list&quot;</span><span class="p">:</span> <span class="n">approach_list</span><span class="p">,</span>
            <span class="s2">&quot;retard&quot;</span><span class="p">:</span> <span class="n">retard</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c1"># enregistrement dans le gdSet</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">gdSet</span><span class="o">.</span><span class="n">set_adversaires_avance</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="c1">#-----&gt; Hunter</span>
    <span class="k">def</span> <span class="nf">_find_bot_for_hunter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Définit la cible principale d&#39;un bot chasseur</span>
<span class="sd">        De préférence un humain ou un winner.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">huntbot</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># robots déja ciblés par d&#39;autres chasseurs</span>
        <span class="n">hlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hunter_alive</span> <span class="k">if</span> <span class="n">b</span> <span class="o">!=</span> <span class="n">robot</span><span class="p">]</span>
        <span class="n">targetedset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hlist</span><span class="p">:</span>
            <span class="n">maintarget</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">get_main_target</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">maintarget</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">casetarget</span> <span class="o">=</span> <span class="n">maintarget</span><span class="o">.</span><span class="n">case</span>
                <span class="k">if</span> <span class="n">casetarget</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_ROBOT</span><span class="p">:</span>
                    <span class="n">targetedset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">casetarget</span><span class="p">)</span>
        <span class="c1"># s&#39;ils le sont déja tous, on peut choisir un robot déja ciblé</span>
        <span class="n">diffset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">winner_human_alive</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">targetedset</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">winner_human_alive</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">diffset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">targetedset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="c1"># humains et winners :</span>
        <span class="n">hwlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">winner_human_alive</span> <span class="k">if</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">targetedset</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hwlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">choicelist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">hwlist</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get_danger_factor_for_bot</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
                <span class="n">case_sortie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_case_sortie</span><span class="p">()</span>
                <span class="n">dist_sortie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">case_sortie</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
                <span class="n">choicelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;bot&quot;</span><span class="p">:</span> <span class="n">b</span><span class="p">,</span> <span class="s2">&quot;df&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">,</span> <span class="s2">&quot;dist&quot;</span><span class="p">:</span> <span class="n">dist</span><span class="p">,</span> <span class="s2">&quot;dist_sortie&quot;</span><span class="p">:</span> <span class="n">dist_sortie</span><span class="p">}</span>
                <span class="p">)</span>
                <span class="c1"># trie :</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">choicelist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">choicelist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;dist_sortie&quot;</span><span class="p">,</span> <span class="s2">&quot;dist&quot;</span><span class="p">))</span>
                    <span class="n">huntbot</span> <span class="o">=</span> <span class="n">choicelist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;bot&quot;</span><span class="p">]</span>
        <span class="c1"># autres :</span>
        <span class="k">if</span> <span class="n">huntbot</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">olist</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">b</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alive_bots</span>
                <span class="k">if</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">winner_human_hunter_alive</span> <span class="ow">and</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">targetedset</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">olist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># on prend en compte les bots déja ciblés</span>
                <span class="n">olist</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">b</span>
                    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alive_bots</span>
                    <span class="k">if</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">winner_human_hunter_alive</span>
                <span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">olist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">choicelist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">olist</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get_danger_factor_for_bot</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
                    <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
                    <span class="n">choicelist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;bot&quot;</span><span class="p">:</span> <span class="n">b</span><span class="p">,</span> <span class="s2">&quot;df&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">,</span> <span class="s2">&quot;dist&quot;</span><span class="p">:</span> <span class="n">dist</span><span class="p">})</span>
                    <span class="c1"># trie par proximité puis facteur de danger desc:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">choicelist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">choicelist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;dist&quot;</span><span class="p">))</span>
                        <span class="n">choicelist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;df&quot;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">huntbot</span> <span class="o">=</span> <span class="n">choicelist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;bot&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">huntbot</span>

    <span class="k">def</span> <span class="nf">_update_hunter_game_phasis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Met à jour la phase de jeu d&#39;un Winner</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># phase standard par défaut</span>
        <span class="n">phasis</span> <span class="o">=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PHASIS_IN_PROGRESS</span>
        <span class="c1"># sortie du labyrinthe en cas de victoire :</span>
        <span class="n">case_sortie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_case_sortie</span><span class="p">()</span>
        <span class="n">maintarget</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_main_target</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">maintarget</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">maintarget</span><span class="o">.</span><span class="n">case</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alive_bots</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">maintarget</span><span class="o">.</span><span class="n">case</span><span class="o">.</span><span class="n">game_phasis</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="n">CommandManager</span><span class="o">.</span><span class="n">PHASIS_APPROACH</span><span class="p">,</span>
                    <span class="n">CommandManager</span><span class="o">.</span><span class="n">PHASIS_FINAL</span><span class="p">,</span>
                <span class="p">]:</span>
                    <span class="c1"># chasse forcée</span>
                    <span class="n">phasis</span> <span class="o">=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PHASIS_HUNT</span>
            <span class="k">elif</span> <span class="n">maintarget</span><span class="o">.</span><span class="n">case</span> <span class="o">==</span> <span class="n">case_sortie</span><span class="p">:</span>
                <span class="c1"># le robot est le dernier joueur</span>
                <span class="n">dist_sortie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span>
                    <span class="n">robot</span><span class="p">,</span> <span class="n">case_sortie</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">dist_sortie</span> <span class="o">&lt;=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">DIST_APPROACH</span><span class="p">:</span>
                    <span class="c1"># phase finale d&#39;approche de la sortie</span>
                    <span class="n">phasis</span> <span class="o">=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PHASIS_FINAL</span>
        <span class="k">return</span> <span class="n">phasis</span>

    <span class="c1">#-----&gt; B.3- Génération des données de choix de commande</span>
    <span class="k">def</span> <span class="nf">_need_to_compute_gamble_datas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Indique si l&#39;on doit recueillir le maximum de données</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">do_need</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># en fonction de la validité de la cible temporaires</span>
        <span class="n">temptarget</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_temp_target</span><span class="p">()</span>
        <span class="n">temp_valide</span> <span class="o">=</span> <span class="n">temptarget</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">temptarget</span><span class="o">.</span><span class="n">discarded</span>
        <span class="k">if</span> <span class="n">temp_valide</span><span class="p">:</span>
            <span class="n">do_need</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># cas particulier des winners et hunters en phase finale d&#39;approche</span>
        <span class="c1"># de la sortie : approche via le targetpath de maintarget</span>
        <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span> <span class="ow">in</span> <span class="p">[</span><span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_WINNER</span><span class="p">,</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_HUNTER</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">game_phasis</span> <span class="o">==</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PHASIS_FINAL</span><span class="p">:</span>
                <span class="n">do_need</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># retour :</span>
        <span class="k">return</span> <span class="n">do_need</span>

    <span class="k">def</span> <span class="nf">_get_gamble_datas_for_bot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collecte les données permettant de choisir le coup à jouer</span>
<span class="sd">        Complète le dictionnaire GambleDataSet gdSet : de mesures (nombre de</span>
<span class="sd">        types de cases, nombre de cases immédiatement libres, ...) dans</span>
<span class="sd">        les 4 directions :</span>
<span class="sd">        </span>
<span class="sd">        * gdSet[LabHelper.TOP] : liste d&#39;objets GambleDataObject</span>
<span class="sd">        * gdSet[LabHelper.BOTTOM] : liste d&#39;objets GambleDataObject</span>
<span class="sd">        * gdSet[LabHelper.LEFT] : liste d&#39;objets GambleDataObject</span>
<span class="sd">        * gdSet[LabHelper.RIGHT] : liste d&#39;objets GambleDataObject</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># paramètres :</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">maindirs</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">maintarget_directions</span>
        <span class="c1"># types de cases à mesurer</span>
        <span class="n">dict_typescases</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c1"># - dans tous les cas :</span>
        <span class="n">dict_typescases</span><span class="p">[</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">TYPE_CASES_LIBRES</span><span class="p">]</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_CASES_LIBRES</span>
        <span class="c1"># - hors recherche de bonus tous azimuts :</span>
        <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">bonus_strategy</span> <span class="o">!=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">STRAT_BONUS_ALL</span><span class="p">:</span>
            <span class="n">dict_typescases</span><span class="p">[</span>
                <span class="n">LabHelper</span><span class="o">.</span><span class="n">TYPE_CASES_DANGERS</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_CASES_DANGERS</span>
            <span class="n">dict_typescases</span><span class="p">[</span>
                <span class="n">LabHelper</span><span class="o">.</span><span class="n">TYPE_CASES_ADVERSAIRES</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_CASES_ADVERSAIRES</span>
            <span class="n">dict_typescases</span><span class="p">[</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">TYPE_CASES_BONUS</span><span class="p">]</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_CASES_BONUS</span>
            <span class="n">dict_typescases</span><span class="p">[</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">TYPE_CASES_MURS</span><span class="p">]</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_CASES_MURS</span>
            <span class="n">dict_typescases</span><span class="p">[</span>
                <span class="n">LabHelper</span><span class="o">.</span><span class="n">TYPE_CASES_NO_ACTION</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_CASES_NO_ACTION</span>
        <span class="c1"># création des sous matrices de mesure :</span>
        <span class="n">dict_submat</span><span class="p">,</span> <span class="n">dictsample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_scan_dict</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="n">gdSet</span><span class="o">.</span><span class="n">largeurX</span> <span class="o">=</span> <span class="n">dictsample</span><span class="p">[</span><span class="s2">&quot;largeurX&quot;</span><span class="p">]</span>
        <span class="n">gdSet</span><span class="o">.</span><span class="n">largeurY</span> <span class="o">=</span> <span class="n">dictsample</span><span class="p">[</span><span class="s2">&quot;largeurY&quot;</span><span class="p">]</span>
        <span class="n">gdSet</span><span class="o">.</span><span class="n">profondeur_max</span> <span class="o">=</span> <span class="n">dictsample</span><span class="p">[</span><span class="s2">&quot;profondeur_max&quot;</span><span class="p">]</span>
        <span class="n">max_sample_size</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">profondeur_max</span>
        <span class="c1"># coords du robot :</span>
        <span class="n">x_r</span><span class="p">,</span> <span class="n">y_r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="c1"># Recueil de données :</span>
        <span class="n">dict_datas</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># structure intermédiaire</span>
        <span class="n">dict_datas</span><span class="p">[</span><span class="s2">&quot;gdObjects&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># objets de mesure finaux</span>
        <span class="k">for</span> <span class="n">direct</span><span class="p">,</span> <span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">axe</span><span class="p">,</span> <span class="n">sens</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dict_submat</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># 1- Objets de mesure :</span>
            <span class="c1"># - points de mesure :</span>
            <span class="k">if</span> <span class="n">axe</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">AXIS_X</span><span class="p">:</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x_r</span> <span class="o">+</span> <span class="n">sens</span><span class="p">,</span> <span class="n">case</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">sm</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="p">[(</span><span class="n">case</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">y_r</span> <span class="o">+</span> <span class="n">sens</span><span class="p">)</span> <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">sm</span><span class="o">.</span><span class="n">get_line</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>
            <span class="c1"># - dicts de mesure réutilisés</span>
            <span class="n">reuseddict</span><span class="p">,</span> <span class="n">sample_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_setsdict_for_axis_and_sens</span><span class="p">(</span>
                <span class="n">sm</span><span class="p">,</span> <span class="n">axe</span><span class="p">,</span> <span class="n">sens</span>
            <span class="p">)</span>
            <span class="c1"># - objets de mesure finaux</span>
            <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                <span class="n">gdobj</span> <span class="o">=</span> <span class="n">GambleDataObject</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">direct</span><span class="p">,</span> <span class="n">axe</span><span class="p">,</span> <span class="n">sens</span><span class="p">)</span>
                <span class="n">gdSet</span><span class="o">.</span><span class="n">add_GDObj</span><span class="p">(</span><span class="n">gdobj</span><span class="p">)</span>
                <span class="n">dict_datas</span><span class="p">[</span><span class="s2">&quot;gdObjects&quot;</span><span class="p">][</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdobj</span>
            <span class="c1"># 2- Collecte principale de données</span>
            <span class="c1"># - la direction pointe t&#39;elle vers la cible principale ?</span>
            <span class="n">is_main_direct</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">maindirs</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">direct</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">maindirs</span><span class="p">:</span>
                <span class="n">is_main_direct</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># - mesures sur l&#39;ensemble des points de la direction :</span>
            <span class="n">dict_datas</span><span class="p">[</span><span class="n">direct</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="c1"># - Dénombrement par type de cases</span>
            <span class="k">for</span> <span class="n">typecase</span><span class="p">,</span> <span class="n">list_tc</span> <span class="ow">in</span> <span class="n">dict_typescases</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">dict_datas</span><span class="p">[</span><span class="n">direct</span><span class="p">][</span><span class="n">typecase</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_typecase_on_set</span><span class="p">(</span>
                    <span class="n">reuseddict</span><span class="p">,</span> <span class="n">list_tc</span>
                <span class="p">)</span>
            <span class="c1"># - impacts cumulés :</span>
            <span class="n">dict_datas</span><span class="p">[</span><span class="n">direct</span><span class="p">][</span><span class="s2">&quot;impact_cumul&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cumul_typecase_on_set</span><span class="p">(</span>
                <span class="n">robot</span><span class="p">,</span> <span class="n">reuseddict</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_CASES_DANGERS</span>
            <span class="p">)</span>
            <span class="c1"># - En fonction de la stratégie de recherche de bonus :</span>
            <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">bonus_strategy</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># cumul pondéré des bonus par la distance au robot</span>
                <span class="n">dict_datas</span><span class="p">[</span><span class="n">direct</span><span class="p">][</span>
                    <span class="n">LabHelper</span><span class="o">.</span><span class="n">TYPE_CASES_BONUS</span>
                <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cumul_typecase_on_set</span><span class="p">(</span>
                    <span class="n">robot</span><span class="p">,</span> <span class="n">reuseddict</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_CASES_BONUS</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">bonus_strategy</span> <span class="o">!=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">STRAT_BONUS_ALL</span><span class="p">:</span>
                <span class="c1"># cases libres &amp; delta de rapprochement / cible principale</span>
                <span class="n">dict_datas</span><span class="p">[</span><span class="n">direct</span><span class="p">][</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">NOMBRE_CASES_LIBRES</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">dict_datas</span><span class="p">[</span><span class="n">direct</span><span class="p">][</span><span class="s2">&quot;last_free_case&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">dict_datas</span><span class="p">[</span><span class="n">direct</span><span class="p">][</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">DELTA_MAIN</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                    <span class="c1"># Nombre de cases immédiatement libres &amp; dernière case libre</span>
                    <span class="n">nbl</span><span class="p">,</span> <span class="n">last_free</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_free_cases_from_point</span><span class="p">(</span>
                        <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axe</span><span class="p">,</span> <span class="n">sens</span>
                    <span class="p">)</span>
                    <span class="n">dict_datas</span><span class="p">[</span><span class="n">direct</span><span class="p">][</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">NOMBRE_CASES_LIBRES</span><span class="p">][</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="n">nbl</span>
                    <span class="n">dict_datas</span><span class="p">[</span><span class="n">direct</span><span class="p">][</span><span class="s2">&quot;last_free_case&quot;</span><span class="p">][</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_free</span>
                    <span class="c1"># Delta de rapprochement : un éloignement négatif rapproche de la</span>
                    <span class="c1"># cible principale</span>
                    <span class="n">gdo</span> <span class="o">=</span> <span class="n">dict_datas</span><span class="p">[</span><span class="s2">&quot;gdObjects&quot;</span><span class="p">][</span><span class="n">pt</span><span class="p">]</span>
                    <span class="n">delta_main</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_delta_main</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">gdo</span><span class="p">)</span>
                    <span class="n">dict_datas</span><span class="p">[</span><span class="n">direct</span><span class="p">][</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">DELTA_MAIN</span><span class="p">][</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta_main</span>
            <span class="c1"># 3- Maj objets de mesure</span>
            <span class="n">defset</span> <span class="o">=</span> <span class="n">attset</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">gdobj</span> <span class="ow">in</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_GDObj_list_by_dir</span><span class="p">(</span><span class="n">direct</span><span class="p">):</span>
                <span class="c1"># - données déja calculées :</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="n">gdobj</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">gdobj</span><span class="o">.</span><span class="n">y</span>
                <span class="n">gdobj</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">=</span> <span class="n">sample_size</span>
                <span class="n">gdobj</span><span class="o">.</span><span class="n">is_in_maindir</span> <span class="o">=</span> <span class="n">is_main_direct</span>
                <span class="n">gdobj</span><span class="o">.</span><span class="n">count_cases_libres</span> <span class="o">=</span> <span class="n">dict_datas</span><span class="p">[</span><span class="n">direct</span><span class="p">][</span>
                    <span class="n">LabHelper</span><span class="o">.</span><span class="n">TYPE_CASES_LIBRES</span>
                <span class="p">][</span><span class="n">pt</span><span class="p">]</span>
                <span class="n">gdobj</span><span class="o">.</span><span class="n">count_cases_bonus</span> <span class="o">=</span> <span class="n">dict_datas</span><span class="p">[</span><span class="n">direct</span><span class="p">][</span>
                    <span class="n">LabHelper</span><span class="o">.</span><span class="n">TYPE_CASES_BONUS</span>
                <span class="p">][</span><span class="n">pt</span><span class="p">]</span>
                <span class="n">gdobj</span><span class="o">.</span><span class="n">impact_cumule</span> <span class="o">=</span> <span class="n">dict_datas</span><span class="p">[</span><span class="n">direct</span><span class="p">][</span><span class="s2">&quot;impact_cumul&quot;</span><span class="p">][</span><span class="n">pt</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">bonus_strategy</span> <span class="o">!=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">STRAT_BONUS_ALL</span><span class="p">:</span>
                    <span class="n">gdobj</span><span class="o">.</span><span class="n">count_cases_dangers</span> <span class="o">=</span> <span class="n">dict_datas</span><span class="p">[</span><span class="n">direct</span><span class="p">][</span>
                        <span class="n">LabHelper</span><span class="o">.</span><span class="n">TYPE_CASES_DANGERS</span>
                    <span class="p">][</span><span class="n">pt</span><span class="p">]</span>
                    <span class="n">gdobj</span><span class="o">.</span><span class="n">count_cases_adversaires</span> <span class="o">=</span> <span class="n">dict_datas</span><span class="p">[</span><span class="n">direct</span><span class="p">][</span>
                        <span class="n">LabHelper</span><span class="o">.</span><span class="n">TYPE_CASES_ADVERSAIRES</span>
                    <span class="p">][</span><span class="n">pt</span><span class="p">]</span>
                    <span class="n">gdobj</span><span class="o">.</span><span class="n">count_cases_murs</span> <span class="o">=</span> <span class="n">dict_datas</span><span class="p">[</span><span class="n">direct</span><span class="p">][</span>
                        <span class="n">LabHelper</span><span class="o">.</span><span class="n">TYPE_CASES_MURS</span>
                    <span class="p">][</span><span class="n">pt</span><span class="p">]</span>
                    <span class="n">gdobj</span><span class="o">.</span><span class="n">count_cases_no_action</span> <span class="o">=</span> <span class="n">dict_datas</span><span class="p">[</span><span class="n">direct</span><span class="p">][</span>
                        <span class="n">LabHelper</span><span class="o">.</span><span class="n">TYPE_CASES_NO_ACTION</span>
                    <span class="p">][</span><span class="n">pt</span><span class="p">]</span>
                    <span class="n">gdobj</span><span class="o">.</span><span class="n">count_consecutive_libres</span> <span class="o">=</span> <span class="n">dict_datas</span><span class="p">[</span><span class="n">direct</span><span class="p">][</span>
                        <span class="n">LabHelper</span><span class="o">.</span><span class="n">NOMBRE_CASES_LIBRES</span>
                    <span class="p">][</span><span class="n">pt</span><span class="p">]</span>
                    <span class="n">gdobj</span><span class="o">.</span><span class="n">last_free_case</span> <span class="o">=</span> <span class="n">dict_datas</span><span class="p">[</span><span class="n">direct</span><span class="p">][</span><span class="s2">&quot;last_free_case&quot;</span><span class="p">][</span><span class="n">pt</span><span class="p">]</span>
                    <span class="n">gdobj</span><span class="o">.</span><span class="n">delta_main</span> <span class="o">=</span> <span class="n">dict_datas</span><span class="p">[</span><span class="n">direct</span><span class="p">][</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">DELTA_MAIN</span><span class="p">][</span><span class="n">pt</span><span class="p">]</span>
                <span class="c1"># - données complémentaires :</span>
                <span class="n">samplelistcases</span><span class="p">,</span> <span class="n">first_impact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_gdo_sample_list_case</span><span class="p">(</span><span class="n">gdobj</span><span class="p">)</span>
                <span class="c1">#   * liste des cases de l&#39;échantillon</span>
                <span class="n">gdobj</span><span class="o">.</span><span class="n">listcases</span> <span class="o">=</span> <span class="n">samplelistcases</span>
                <span class="c1">#   * premier impact</span>
                <span class="n">gdobj</span><span class="o">.</span><span class="n">first_impact</span> <span class="o">=</span> <span class="n">first_impact</span>
                <span class="c1">#   * dist au robot</span>
                <span class="n">gdobj</span><span class="o">.</span><span class="n">dist_to_bot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span>
                    <span class="n">robot</span><span class="p">,</span> <span class="n">gdobj</span>
                <span class="p">)</span>
                <span class="c1">#   * facteur d&#39;échantillonnage</span>
                <span class="n">gdobj</span><span class="o">.</span><span class="n">fact_sample</span> <span class="o">=</span> <span class="n">gdobj</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">/</span> <span class="n">max_sample_size</span>
                <span class="c1">#   * bots contre lesquels se défendre :</span>
                <span class="n">caseset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">samplelistcases</span><span class="p">)</span>
                <span class="n">defset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;defense_all&quot;</span><span class="p">))</span>
                <span class="n">gdobj</span><span class="o">.</span><span class="n">count_bot_defense</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">caseset</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">defset</span><span class="p">))</span>
                <span class="c1">#   * bots à attaquer :</span>
                <span class="n">attset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;attaque_all&quot;</span><span class="p">))</span>
                <span class="n">gdobj</span><span class="o">.</span><span class="n">count_bot_attaque</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">caseset</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">attset</span><span class="p">))</span>
            <span class="c1"># 4- Direction : valeurs cumulées pondérées par la distance au robot :</span>
            <span class="n">cumuldict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">matset</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">get_set_cases</span><span class="p">()</span>
            <span class="c1"># - dans tous les cas :</span>
            <span class="n">bnsset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_typecase_set</span><span class="p">(</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_CASES_BONUS</span><span class="p">)</span>
            <span class="n">cumuldict</span><span class="p">[</span><span class="s2">&quot;bonus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_pondered_cumul</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">matset</span><span class="p">,</span> <span class="n">bnsset</span><span class="p">)</span>
            <span class="n">freeset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_typecase_set</span><span class="p">(</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_CASES_LIBRES</span><span class="p">)</span>
            <span class="n">cumuldict</span><span class="p">[</span><span class="s2">&quot;libres&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_pondered_cumul</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">matset</span><span class="p">,</span> <span class="n">freeset</span><span class="p">)</span>
            <span class="c1"># hors recherche de bonus tous azimuts</span>
            <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">bonus_strategy</span> <span class="o">!=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">STRAT_BONUS_ALL</span><span class="p">:</span>
                <span class="n">cumuldict</span><span class="p">[</span><span class="s2">&quot;defense&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_pondered_cumul</span><span class="p">(</span>
                    <span class="n">robot</span><span class="p">,</span> <span class="n">matset</span><span class="p">,</span> <span class="n">defset</span>
                <span class="p">)</span>
                <span class="n">cumuldict</span><span class="p">[</span><span class="s2">&quot;attaque&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_pondered_cumul</span><span class="p">(</span>
                    <span class="n">robot</span><span class="p">,</span> <span class="n">matset</span><span class="p">,</span> <span class="n">attset</span>
                <span class="p">)</span>
                <span class="n">dgrset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_typecase_set</span><span class="p">(</span>
                    <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_CASES_DANGERS</span>
                <span class="p">)</span>
                <span class="n">cumuldict</span><span class="p">[</span><span class="s2">&quot;dangers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_pondered_cumul</span><span class="p">(</span>
                    <span class="n">robot</span><span class="p">,</span> <span class="n">matset</span><span class="p">,</span> <span class="n">dgrset</span>
                <span class="p">)</span>
            <span class="c1"># enregistrement des cumuls sur la direction :</span>
            <span class="n">gdSet</span><span class="o">.</span><span class="n">register_cumul_by_dir</span><span class="p">(</span><span class="n">direct</span><span class="p">,</span> <span class="n">cumuldict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_scan_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retourne le dict contenant les sous matrices de mesures dans les 4 directions </span>
<span class="sd">        ainsi qu&#39;un dictionnaire décrivant les largeurs d&#39;échantillons et la profondeur </span>
<span class="sd">        max.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dict_submat</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">LabHelper</span><span class="o">.</span><span class="n">TOP</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">AXIS_Y</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">DIR_NEG</span><span class="p">),</span>
            <span class="n">LabHelper</span><span class="o">.</span><span class="n">BOTTOM</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">AXIS_Y</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">DIR_POS</span><span class="p">),</span>
            <span class="n">LabHelper</span><span class="o">.</span><span class="n">LEFT</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">AXIS_X</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">DIR_NEG</span><span class="p">),</span>
            <span class="n">LabHelper</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">AXIS_X</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">DIR_POS</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="c1"># 1- Echantillonage asymétrique (un axe peu avoir 2 profondeurs différentes)</span>
        <span class="c1"># largeur, profondeur des échantillons :</span>
        <span class="n">l</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sample_size_for_bot</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="c1"># sous matrices d&#39;échantillonnage</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">rect</span><span class="p">[</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">TOP</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_scan_submatrice_rectangle</span><span class="p">(</span>
            <span class="n">robot</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">AXIS_Y</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">DIR_NEG</span><span class="p">,</span> <span class="n">largeur</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">profondeur</span><span class="o">=</span><span class="n">p</span>
        <span class="p">)</span>
        <span class="n">rect</span><span class="p">[</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">BOTTOM</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_scan_submatrice_rectangle</span><span class="p">(</span>
            <span class="n">robot</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">AXIS_Y</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">DIR_POS</span><span class="p">,</span> <span class="n">largeur</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">profondeur</span><span class="o">=</span><span class="n">p</span>
        <span class="p">)</span>
        <span class="n">rect</span><span class="p">[</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">LEFT</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_scan_submatrice_rectangle</span><span class="p">(</span>
            <span class="n">robot</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">AXIS_X</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">DIR_NEG</span><span class="p">,</span> <span class="n">largeur</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">profondeur</span><span class="o">=</span><span class="n">p</span>
        <span class="p">)</span>
        <span class="n">rect</span><span class="p">[</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_scan_submatrice_rectangle</span><span class="p">(</span>
            <span class="n">robot</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">AXIS_X</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">DIR_POS</span><span class="p">,</span> <span class="n">largeur</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">profondeur</span><span class="o">=</span><span class="n">p</span>
        <span class="p">)</span>
        <span class="c1"># 2- Création des sous matrices</span>
        <span class="k">for</span> <span class="n">direct</span><span class="p">,</span> <span class="n">tupsm</span> <span class="ow">in</span> <span class="n">dict_submat</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_scan_submatrice</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">tupsm</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tupsm</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rect</span><span class="p">[</span><span class="n">direct</span><span class="p">])</span>
            <span class="n">dict_submat</span><span class="p">[</span><span class="n">direct</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">tupsm</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tupsm</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="c1"># 3- Tailles d&#39;échantillons</span>
        <span class="n">largeurX</span> <span class="o">=</span> <span class="n">largeurY</span> <span class="o">=</span> <span class="n">l</span>
        <span class="n">profondeur_max</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">direct</span><span class="p">,</span> <span class="n">dictrect</span> <span class="ow">in</span> <span class="n">rect</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">direct</span> <span class="ow">in</span> <span class="p">[</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">TOP</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">BOTTOM</span><span class="p">]:</span>
                <span class="n">lY</span><span class="p">,</span> <span class="n">pY</span> <span class="o">=</span> <span class="n">dictrect</span><span class="p">[</span><span class="s2">&quot;ws&quot;</span><span class="p">],</span> <span class="n">dictrect</span><span class="p">[</span><span class="s2">&quot;hs&quot;</span><span class="p">]</span>
                <span class="n">largeurY</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">largeurY</span><span class="p">,</span> <span class="n">lY</span><span class="p">)</span>
                <span class="n">profondeur_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">profondeur_max</span><span class="p">,</span> <span class="n">pY</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lX</span><span class="p">,</span> <span class="n">pX</span> <span class="o">=</span> <span class="n">dictrect</span><span class="p">[</span><span class="s2">&quot;hs&quot;</span><span class="p">],</span> <span class="n">dictrect</span><span class="p">[</span><span class="s2">&quot;ws&quot;</span><span class="p">]</span>
                <span class="n">largeurX</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">largeurX</span><span class="p">,</span> <span class="n">lX</span><span class="p">)</span>
                <span class="n">profondeur_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">profondeur_max</span><span class="p">,</span> <span class="n">pX</span><span class="p">)</span>
        <span class="c1"># Retour :</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">dict_submat</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;largeurX&quot;</span><span class="p">:</span> <span class="n">largeurX</span><span class="p">,</span>
                <span class="s2">&quot;largeurY&quot;</span><span class="p">:</span> <span class="n">largeurY</span><span class="p">,</span>
                <span class="s2">&quot;profondeur_max&quot;</span><span class="p">:</span> <span class="n">profondeur_max</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_scan_submatrice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">axe</span><span class="p">,</span> <span class="n">sens</span><span class="p">,</span> <span class="n">rectdict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retourne une sous matrice pour les mesures de densité sur l&#39;axe, selon le sens</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">rectdict</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rectdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_scan_submatrice_rectangle</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">axe</span><span class="p">,</span> <span class="n">sens</span><span class="p">)</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ws</span><span class="p">,</span> <span class="n">hs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">rectdict</span><span class="p">[</span><span class="s2">&quot;xmin&quot;</span><span class="p">],</span>
            <span class="n">rectdict</span><span class="p">[</span><span class="s2">&quot;ymin&quot;</span><span class="p">],</span>
            <span class="n">rectdict</span><span class="p">[</span><span class="s2">&quot;ws&quot;</span><span class="p">],</span>
            <span class="n">rectdict</span><span class="p">[</span><span class="s2">&quot;hs&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_submatrice</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ws</span><span class="p">,</span> <span class="n">hs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sm</span>

    <span class="k">def</span> <span class="nf">_get_scan_submatrice_rectangle</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">axe</span><span class="p">,</span> <span class="n">sens</span><span class="p">,</span> <span class="n">largeur</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">profondeur</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retourne le rectangle réel de la sous matrice</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x_r</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">x</span>
        <span class="n">y_r</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span>
        <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_dimensions</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">largeur</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">largeur</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">DENSITE_LARGEUR</span>
        <span class="k">if</span> <span class="n">profondeur</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">profondeur</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">DENSITE_PROFONDEUR</span>
        <span class="c1"># rectangle de mesure :</span>
        <span class="k">if</span> <span class="n">axe</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">AXIS_X</span><span class="p">:</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">profondeur</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">largeur</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_r</span> <span class="o">-</span> <span class="n">dy</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">ymax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_r</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sens</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">DIR_POS</span><span class="p">:</span>
                <span class="n">xmin</span> <span class="o">=</span> <span class="n">x_r</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">xmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x_r</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_r</span> <span class="o">-</span> <span class="n">dx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">xmax</span> <span class="o">=</span> <span class="n">x_r</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">largeur</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">profondeur</span>
            <span class="n">xmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_r</span> <span class="o">-</span> <span class="n">dx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">xmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x_r</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sens</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">DIR_POS</span><span class="p">:</span>
                <span class="n">ymin</span> <span class="o">=</span> <span class="n">y_r</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">ymax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_r</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ymin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_r</span> <span class="o">-</span> <span class="n">dy</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">ymax</span> <span class="o">=</span> <span class="n">y_r</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">ws</span> <span class="o">=</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">hs</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;xmin&quot;</span><span class="p">:</span> <span class="n">xmin</span><span class="p">,</span> <span class="s2">&quot;ymin&quot;</span><span class="p">:</span> <span class="n">ymin</span><span class="p">,</span> <span class="s2">&quot;ws&quot;</span><span class="p">:</span> <span class="n">ws</span><span class="p">,</span> <span class="s2">&quot;hs&quot;</span><span class="p">:</span> <span class="n">hs</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_get_sample_size_for_bot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retourne les dimensions (largeur, profondeur) d&#39;échantillonnage en fonction des</span>
<span class="sd">        caractéristiques du robot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># par défaut :</span>
        <span class="n">l</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">DENSITE_LARGEUR</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">DENSITE_PROFONDEUR</span>
        <span class="c1"># En fonction de l&#39;intelligence :</span>
        <span class="n">intelligence</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">intelligence</span>
        <span class="n">highQI</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;intelligence&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">)</span>
        <span class="n">midQI</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;intelligence&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">intelligence</span> <span class="o">&gt;=</span> <span class="n">highQI</span><span class="p">:</span>
            <span class="n">l</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span>
        <span class="k">elif</span> <span class="n">intelligence</span> <span class="o">&gt;=</span> <span class="n">midQI</span><span class="p">:</span>
            <span class="n">l</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span>
        <span class="k">return</span> <span class="n">l</span><span class="p">,</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">_count_typecase_on_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictset</span><span class="p">,</span> <span class="n">listtypescases</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prend pour entrée un dict ayant pour clefs des points de mesure et</span>
<span class="sd">        pour valeurs des sets de cases.</span>
<span class="sd">        Retourne un dict associant aux clefs le nombre de cases de type compris</span>
<span class="sd">        dans listtypescases</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># set de référence :</span>
        <span class="n">refset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_typecase_set</span><span class="p">(</span><span class="n">listtypescases</span><span class="p">)</span>
        <span class="c1"># mesures :</span>
        <span class="n">dsm</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pt</span><span class="p">,</span> <span class="n">caseset</span> <span class="ow">in</span> <span class="n">dictset</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">dsm</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">refset</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">caseset</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">dsm</span>

    <span class="k">def</span> <span class="nf">_cumul_typecase_on_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">dictset</span><span class="p">,</span> <span class="n">listtypescases</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prend pour entrée un dict ayant pour clefs des points de mesure et</span>
<span class="sd">        pour valeurs des sets de cases.</span>
<span class="sd">        Retourne un dict associant aux clefsle cumul pondéré par la distance</span>
<span class="sd">        au robot des cases de type compris danslisttypescases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># set de référence :</span>
        <span class="n">refset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_typecase_set</span><span class="p">(</span><span class="n">listtypescases</span><span class="p">)</span>
        <span class="c1"># mesures :</span>
        <span class="n">dsm</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pt</span><span class="p">,</span> <span class="n">caseset</span> <span class="ow">in</span> <span class="n">dictset</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">dsm</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_pondered_cumul</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">caseset</span><span class="p">,</span> <span class="n">refset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dsm</span>

    <span class="k">def</span> <span class="nf">_get_setsdict_for_axis_and_sens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrice</span><span class="p">,</span> <span class="n">axe</span><span class="p">,</span> <span class="n">sens</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retourne un dict ayant pour</span>
<span class="sd">        </span>
<span class="sd">        * clefs : un point de mesure (x, y)</span>
<span class="sd">        * valeur : un set de cases correspondant à une ligne ou une colonne</span>
<span class="sd">          de la matrice          </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span> <span class="o">=</span> <span class="n">matrice</span><span class="o">.</span><span class="n">get_lefttop_point</span><span class="p">()</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">matrice</span><span class="o">.</span><span class="n">get_dimensions</span><span class="p">()</span>
        <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">xmin</span> <span class="o">+</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ymin</span> <span class="o">+</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">x_r</span> <span class="o">=</span> <span class="n">y_r</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dsm</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">axe</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">AXIS_X</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sens</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">DIR_POS</span><span class="p">:</span>
                <span class="n">x_r</span> <span class="o">=</span> <span class="n">xmin</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x_r</span> <span class="o">=</span> <span class="n">xmax</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">h</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">ly</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">ymin</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">ly</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">matrice</span><span class="o">.</span><span class="n">get_line</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">dy</span><span class="p">)</span>
                <span class="n">dsm</span><span class="p">[(</span><span class="n">x_r</span><span class="p">,</span> <span class="n">y</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sens</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">DIR_POS</span><span class="p">:</span>
                <span class="n">y_r</span> <span class="o">=</span> <span class="n">ymin</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y_r</span> <span class="o">=</span> <span class="n">ymax</span>
            <span class="n">w</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">lx</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">xmin</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lx</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">matrice</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">dx</span><span class="p">)</span>
                <span class="n">dsm</span><span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_r</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">sample_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dsm</span><span class="p">,</span> <span class="n">sample_size</span>

    <span class="k">def</span> <span class="nf">_compute_free_cases_from_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">axe</span><span class="p">,</span> <span class="n">sens</span><span class="p">,</span> <span class="n">samplesize</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calcule le nombre de cases libres consécutives à partir du point sur</span>
<span class="sd">        l&#39;axe axe, dans le sens sens</span>
<span class="sd">        samplesize : limite le calcul à un nombre de cases donné</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbl</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">last_free</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
        <span class="n">case</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">listcases</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">axe</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">AXIS_X</span><span class="p">:</span>
            <span class="n">listcases</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_line</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">listcases</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">listcases</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">AXIS_X</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">sens</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">DIR_POS</span><span class="p">:</span>
                <span class="n">listcases</span> <span class="o">=</span> <span class="n">listcases</span><span class="p">[</span><span class="n">x</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">listcases</span> <span class="o">=</span> <span class="n">listcases</span><span class="p">[:</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">listcases</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="n">listcases</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">AXIS_X</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">listcases</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">listcases</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">listcases</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">AXIS_Y</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">sens</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">DIR_POS</span><span class="p">:</span>
                <span class="n">listcases</span> <span class="o">=</span> <span class="n">listcases</span><span class="p">[</span><span class="n">y</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">listcases</span> <span class="o">=</span> <span class="n">listcases</span><span class="p">[:</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">listcases</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="n">listcases</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">AXIS_Y</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">samplesize</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">listcases</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">samplesize</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">listcases</span> <span class="o">=</span> <span class="n">listcases</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">s</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">listcases</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">case</span><span class="o">.</span><span class="n">type_case</span> <span class="ow">in</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_CASES_LIBRES</span><span class="p">:</span>
                <span class="n">nbl</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">last_free</span> <span class="o">=</span> <span class="n">case</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">nbl</span><span class="p">,</span> <span class="n">last_free</span>

    <span class="k">def</span> <span class="nf">_compute_pondered_cumul</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">mesuredset</span><span class="p">,</span> <span class="n">refset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calcul le cumul pondéré par la distance au robot des cases comprises</span>
<span class="sd">        dans les deux sets passés en paramètres.</span>
<span class="sd">        refset : set de référence à croiser avec mesuredset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># interssection :</span>
        <span class="n">interset</span> <span class="o">=</span> <span class="n">refset</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">mesuredset</span><span class="p">)</span>
        <span class="c1"># cumul pondéré par la distance :</span>
        <span class="n">pondval</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">interset</span><span class="p">:</span>
            <span class="c1"># plus la case est éloignée, moins elle a de poids</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_DANGER</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">danger_impact</span><span class="p">)</span>
            <span class="n">pondval</span> <span class="o">+=</span> <span class="n">val</span> <span class="o">/</span> <span class="n">d</span>
        <span class="k">return</span> <span class="n">pondval</span>

    <span class="k">def</span> <span class="nf">_compute_delta_main</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">gdo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calcul le facteur d&#39;éloignement par rapport à la cible principale</span>
<span class="sd">        d&#39;un GambleDataObject</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">delta_main</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">maindirs</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">maintarget_directions</span>
        <span class="n">mainTarget</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_main_target</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mainTarget</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># distance à la cible principale</span>
            <span class="n">dist_bot_main</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">mainTarget</span><span class="p">)</span>
            <span class="n">delta_orth</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">delta_dist</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># delta de rapprochement sur l&#39;axe orthogonal :</span>
            <span class="n">orth_sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">axe</span> <span class="o">=</span> <span class="n">gdo</span><span class="o">.</span><span class="n">axe</span>
            <span class="k">if</span> <span class="n">axe</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">AXIS_X</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">TOP</span> <span class="ow">in</span> <span class="n">maindirs</span><span class="p">:</span>
                    <span class="n">orth_sign</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">delta_orth</span> <span class="o">=</span> <span class="n">orth_sign</span> <span class="o">*</span> <span class="p">(</span><span class="n">gdo</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">LEFT</span> <span class="ow">in</span> <span class="n">maindirs</span><span class="p">:</span>
                    <span class="n">orth_sign</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">delta_orth</span> <span class="o">=</span> <span class="n">orth_sign</span> <span class="o">*</span> <span class="p">(</span><span class="n">gdo</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="c1"># delta en distance / cible principale :</span>
            <span class="n">dist_gdo_main</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">gdo</span><span class="p">,</span> <span class="n">mainTarget</span><span class="p">)</span>
            <span class="n">delta_dist</span> <span class="o">=</span> <span class="n">dist_gdo_main</span> <span class="o">-</span> <span class="n">dist_bot_main</span>
            <span class="c1"># somme :</span>
            <span class="n">delta_main</span> <span class="o">=</span> <span class="n">delta_orth</span> <span class="o">+</span> <span class="n">delta_dist</span>
        <span class="k">return</span> <span class="n">delta_main</span>

    <span class="k">def</span> <span class="nf">_get_gdo_sample_list_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gdo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retourne la liste de cases échantillonnées pour gdo, ainsi que la</span>
<span class="sd">        valeur de first impact</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
        <span class="n">case</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">gdo</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">gdo</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">fulllistcases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_next_cases_in_dir</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="n">gdo</span><span class="o">.</span><span class="n">direct</span><span class="p">)</span>
        <span class="n">sample_size</span> <span class="o">=</span> <span class="n">gdo</span><span class="o">.</span><span class="n">sample_size</span>
        <span class="n">samplelistcases</span> <span class="o">=</span> <span class="n">fulllistcases</span><span class="p">[:</span><span class="n">sample_size</span><span class="p">]</span>
        <span class="n">first_impact</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">case</span><span class="o">.</span><span class="n">type_case</span> <span class="ow">in</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_CASES_DANGERS</span><span class="p">:</span>
            <span class="n">first_impact</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">danger_impact</span>
        <span class="k">return</span> <span class="n">samplelistcases</span><span class="p">,</span> <span class="n">first_impact</span>

    <span class="c1">#-----&gt; B.4- Evaluation des données de choix de commande</span>
    <span class="k">def</span> <span class="nf">_add_scores_to_gamble_datas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Note les options présentes dans le GambleDataSet gdSet pour les 4 directions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="c1"># méthode de scoring propre au robot :</span>
        <span class="n">gdo_score_method</span> <span class="o">=</span> <span class="n">dir_score_method</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">bonus_strategy</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dir_score_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bonus_direction_score_method</span>
            <span class="n">gdo_score_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bonus_score_method</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dir_score_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_direction_score_method</span>
            <span class="n">gdo_score_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_score_method</span>
        <span class="c1"># distance à la cible :</span>
        <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
        <span class="n">diag</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_diagonale_len</span><span class="p">()</span>
        <span class="n">mainTarget</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_main_target</span><span class="p">()</span>
        <span class="n">dist_ref</span> <span class="o">=</span> <span class="n">diag</span>
        <span class="k">if</span> <span class="n">mainTarget</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dist_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">mainTarget</span><span class="p">)</span>
        <span class="c1"># évaluations :</span>
        <span class="k">for</span> <span class="n">direct</span> <span class="ow">in</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">LIST_DIRECTIONS</span><span class="p">:</span>
            <span class="n">listegdo</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_GDObj_list_by_dir</span><span class="p">(</span><span class="n">direct</span><span class="p">)</span>
            <span class="c1"># score de la direction :</span>
            <span class="n">dir_score_method</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">direct</span><span class="p">)</span>
            <span class="c1"># évaluations individuelles :</span>
            <span class="k">for</span> <span class="n">gdo</span> <span class="ow">in</span> <span class="n">listegdo</span><span class="p">:</span>
                <span class="c1"># avance :</span>
                <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">bonus_strategy</span> <span class="o">!=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">STRAT_BONUS_ALL</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_compute_GDObj_avance</span><span class="p">(</span><span class="n">gdo</span><span class="p">,</span> <span class="n">dist_ref</span><span class="p">)</span>
                <span class="c1"># score :</span>
                <span class="n">gdo_score_method</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">gdo</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_default_direction_score_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">direct</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calcul le score d&#39;une direction à partir des valeurs cumulées pondérées</span>
<span class="sd">        par la distance au robot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="c1"># paramètres propres au robot :</span>
        <span class="n">ambition</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">ambition</span>
        <span class="n">instinct_survie</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">instinct_survie</span>
        <span class="n">aggressivite</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">aggressivite</span>
        <span class="n">curiosite</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">curiosite</span>
        <span class="n">efficacite</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">efficacite</span>
        <span class="n">intelligence</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">intelligence</span>
        <span class="c1"># valeurs cumulées dans la direction, pondérées par la distance au robot</span>
        <span class="n">cumuldict</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_cumul_by_dir</span><span class="p">(</span><span class="n">direct</span><span class="p">)</span>
        <span class="n">val_defense</span> <span class="o">=</span> <span class="n">cumuldict</span><span class="p">[</span><span class="s2">&quot;defense&quot;</span><span class="p">]</span>
        <span class="n">val_attaque</span> <span class="o">=</span> <span class="n">cumuldict</span><span class="p">[</span><span class="s2">&quot;attaque&quot;</span><span class="p">]</span>
        <span class="n">val_dangers</span> <span class="o">=</span> <span class="n">cumuldict</span><span class="p">[</span><span class="s2">&quot;dangers&quot;</span><span class="p">]</span>
        <span class="n">val_bonus</span> <span class="o">=</span> <span class="n">cumuldict</span><span class="p">[</span><span class="s2">&quot;bonus&quot;</span><span class="p">]</span>
        <span class="n">val_libres</span> <span class="o">=</span> <span class="n">cumuldict</span><span class="p">[</span><span class="s2">&quot;libres&quot;</span><span class="p">]</span>
        <span class="c1"># scores par paramètres :</span>
        <span class="n">score_mvt</span> <span class="o">=</span> <span class="n">efficacite</span> <span class="o">*</span> <span class="n">val_libres</span>
        <span class="n">score_dangers</span> <span class="o">=</span> <span class="o">-</span><span class="n">instinct_survie</span> <span class="o">*</span> <span class="n">val_dangers</span>
        <span class="n">score_defense</span> <span class="o">=</span> <span class="o">-</span><span class="n">instinct_survie</span> <span class="o">*</span> <span class="n">val_defense</span>
        <span class="n">score_attaque</span> <span class="o">=</span> <span class="n">aggressivite</span> <span class="o">*</span> <span class="n">val_attaque</span>
        <span class="n">score_ambition</span> <span class="o">=</span> <span class="n">ambition</span> <span class="o">*</span> <span class="p">(</span><span class="n">val_bonus</span> <span class="o">+</span> <span class="n">val_libres</span><span class="p">)</span>
        <span class="n">score_curiosite</span> <span class="o">=</span> <span class="n">curiosite</span> <span class="o">*</span> <span class="p">(</span><span class="n">val_bonus</span> <span class="o">+</span> <span class="n">val_defense</span> <span class="o">+</span> <span class="n">val_attaque</span><span class="p">)</span>
        <span class="n">score_intelligence</span> <span class="o">=</span> <span class="n">intelligence</span> <span class="o">*</span> <span class="p">(</span><span class="n">val_bonus</span> <span class="o">+</span> <span class="n">val_libres</span> <span class="o">-</span> <span class="n">val_defense</span><span class="p">)</span>
        <span class="c1"># score global</span>
        <span class="n">score</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">score_mvt</span>
            <span class="o">+</span> <span class="n">score_dangers</span>
            <span class="o">+</span> <span class="n">score_defense</span>
            <span class="o">+</span> <span class="n">score_attaque</span>
            <span class="o">+</span> <span class="n">score_ambition</span>
            <span class="o">+</span> <span class="n">score_curiosite</span>
            <span class="o">+</span> <span class="n">score_intelligence</span>
        <span class="p">)</span>
        <span class="c1"># enregistrement dans le dict associé :</span>
        <span class="n">cumuldict</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>

    <span class="k">def</span> <span class="nf">_bonus_direction_score_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">direct</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calcul le score d&#39;une direction à partir des valeurs cumulées pondérées</span>
<span class="sd">        par la distance au robot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="c1"># paramètres propres au robot :</span>
        <span class="n">ambition</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">ambition</span>
        <span class="n">efficacite</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">efficacite</span>
        <span class="n">intelligence</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">intelligence</span>
        <span class="c1"># valeurs cumulées dans la direction, pondérées par la distance au robot</span>
        <span class="n">cumuldict</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_cumul_by_dir</span><span class="p">(</span><span class="n">direct</span><span class="p">)</span>
        <span class="n">val_bonus</span> <span class="o">=</span> <span class="n">cumuldict</span><span class="p">[</span><span class="s2">&quot;bonus&quot;</span><span class="p">]</span>
        <span class="n">val_libres</span> <span class="o">=</span> <span class="n">cumuldict</span><span class="p">[</span><span class="s2">&quot;libres&quot;</span><span class="p">]</span>
        <span class="c1"># scores par paramètres :</span>
        <span class="n">score_mvt</span> <span class="o">=</span> <span class="n">efficacite</span> <span class="o">*</span> <span class="n">val_libres</span>
        <span class="n">score_bonus</span> <span class="o">=</span> <span class="p">(</span><span class="n">ambition</span> <span class="o">+</span> <span class="n">efficacite</span> <span class="o">+</span> <span class="n">intelligence</span><span class="p">)</span> <span class="o">*</span> <span class="n">val_bonus</span>
        <span class="c1"># score global</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">score_mvt</span> <span class="o">+</span> <span class="n">score_bonus</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="c1"># enregistrement dans le dict associé :</span>
        <span class="n">cumuldict</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>

    <span class="k">def</span> <span class="nf">_compute_GDObj_avance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gdo</span><span class="p">,</span> <span class="n">dist_ref</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calcul de l&#39;avance associée à un objet GambleDataObject.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># paramètres de la case évaluée</span>
        <span class="n">c_libres</span> <span class="o">=</span> <span class="n">gdo</span><span class="o">.</span><span class="n">count_cases_libres</span>
        <span class="n">c_no_action</span> <span class="o">=</span> <span class="n">gdo</span><span class="o">.</span><span class="n">count_cases_no_action</span>
        <span class="n">nb_libre</span> <span class="o">=</span> <span class="n">gdo</span><span class="o">.</span><span class="n">count_consecutive_libres</span>
        <span class="n">delta_main</span> <span class="o">=</span> <span class="n">gdo</span><span class="o">.</span><span class="n">delta_main</span>
        <span class="c1"># calcul de l&#39;avance associée</span>
        <span class="n">ouverture</span> <span class="o">=</span> <span class="n">nb_libre</span> <span class="o">+</span> <span class="n">c_libres</span> <span class="o">-</span> <span class="n">c_no_action</span>
        <span class="n">eloignement</span> <span class="o">=</span> <span class="n">delta_main</span>
        <span class="n">avance</span> <span class="o">=</span> <span class="n">ouverture</span> <span class="o">-</span> <span class="n">eloignement</span>
        <span class="c1"># enregistrement</span>
        <span class="n">gdo</span><span class="o">.</span><span class="n">avance</span> <span class="o">=</span> <span class="n">avance</span>

    <span class="k">def</span> <span class="nf">_default_score_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">gdo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calcul de score par défaut d&#39;un objet GambleDataObject.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># paramètres propres au robot :</span>
        <span class="n">ambition</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">ambition</span>
        <span class="n">instinct_survie</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">instinct_survie</span>
        <span class="n">aggressivite</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">aggressivite</span>
        <span class="n">curiosite</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">curiosite</span>
        <span class="n">efficacite</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">efficacite</span>
        <span class="n">intelligence</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">intelligence</span>
        <span class="c1"># paramètres de la case évaluée</span>
        <span class="n">c_adversaires</span> <span class="o">=</span> <span class="n">gdo</span><span class="o">.</span><span class="n">count_cases_adversaires</span>
        <span class="n">c_defense</span> <span class="o">=</span> <span class="n">gdo</span><span class="o">.</span><span class="n">count_bot_defense</span>
        <span class="n">c_attaque</span> <span class="o">=</span> <span class="n">gdo</span><span class="o">.</span><span class="n">count_bot_attaque</span>
        <span class="n">c_bonus</span> <span class="o">=</span> <span class="n">gdo</span><span class="o">.</span><span class="n">count_cases_bonus</span>
        <span class="n">c_libres</span> <span class="o">=</span> <span class="n">gdo</span><span class="o">.</span><span class="n">count_cases_libres</span>
        <span class="n">first_impact</span> <span class="o">=</span> <span class="n">gdo</span><span class="o">.</span><span class="n">first_impact</span>
        <span class="n">impact_cumule</span> <span class="o">=</span> <span class="n">gdo</span><span class="o">.</span><span class="n">impact_cumule</span>
        <span class="n">avance</span> <span class="o">=</span> <span class="n">gdo</span><span class="o">.</span><span class="n">avance</span>
        <span class="c1"># scores par paramètres :</span>
        <span class="n">score_mvt</span> <span class="o">=</span> <span class="n">efficacite</span> <span class="o">*</span> <span class="n">avance</span>
        <span class="n">score_dangers</span> <span class="o">=</span> <span class="o">-</span><span class="n">instinct_survie</span> <span class="o">*</span> <span class="p">(</span><span class="n">first_impact</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">impact_cumule</span><span class="p">))</span>
        <span class="n">score_defense</span> <span class="o">=</span> <span class="o">-</span><span class="n">instinct_survie</span> <span class="o">*</span> <span class="n">c_defense</span>
        <span class="n">score_attaque</span> <span class="o">=</span> <span class="n">aggressivite</span> <span class="o">*</span> <span class="n">c_attaque</span>
        <span class="n">score_ambition</span> <span class="o">=</span> <span class="n">ambition</span> <span class="o">*</span> <span class="p">(</span><span class="n">avance</span> <span class="o">+</span> <span class="n">c_bonus</span><span class="p">)</span>
        <span class="n">score_curiosite</span> <span class="o">=</span> <span class="n">curiosite</span> <span class="o">*</span> <span class="p">(</span><span class="n">c_bonus</span> <span class="o">+</span> <span class="n">c_adversaires</span><span class="p">)</span>
        <span class="n">score_intelligence</span> <span class="o">=</span> <span class="n">intelligence</span> <span class="o">*</span> <span class="p">(</span><span class="n">c_bonus</span> <span class="o">+</span> <span class="n">c_libres</span> <span class="o">-</span> <span class="n">c_defense</span><span class="p">)</span>
        <span class="c1"># score global</span>
        <span class="n">score</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">score_mvt</span>
            <span class="o">+</span> <span class="n">score_dangers</span>
            <span class="o">+</span> <span class="n">score_defense</span>
            <span class="o">+</span> <span class="n">score_attaque</span>
            <span class="o">+</span> <span class="n">score_ambition</span>
            <span class="o">+</span> <span class="n">score_curiosite</span>
            <span class="o">+</span> <span class="n">score_intelligence</span>
        <span class="p">)</span>
        <span class="c1"># enregistrements :</span>
        <span class="n">gdo</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">score</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>

    <span class="k">def</span> <span class="nf">_bonus_score_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">gdo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calcul de score privilégiant les bonus.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># paramètres propres au robot :</span>
        <span class="n">ambition</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">ambition</span>
        <span class="n">instinct_survie</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">instinct_survie</span>
        <span class="n">efficacite</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">efficacite</span>
        <span class="n">intelligence</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">intelligence</span>
        <span class="c1"># paramètres de la case évaluée</span>
        <span class="n">c_bonus</span> <span class="o">=</span> <span class="n">gdo</span><span class="o">.</span><span class="n">count_cases_bonus</span>
        <span class="n">first_impact</span> <span class="o">=</span> <span class="n">gdo</span><span class="o">.</span><span class="n">first_impact</span>
        <span class="n">impact_cumule</span> <span class="o">=</span> <span class="n">gdo</span><span class="o">.</span><span class="n">impact_cumule</span>
        <span class="n">avance</span> <span class="o">=</span> <span class="n">gdo</span><span class="o">.</span><span class="n">avance</span>
        <span class="c1"># scores limités à certains paramètres :</span>
        <span class="n">score_dangers</span> <span class="o">=</span> <span class="o">-</span><span class="n">instinct_survie</span> <span class="o">*</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">first_impact</span><span class="p">)</span> <span class="o">+</span> <span class="n">impact_cumule</span><span class="p">)</span>
        <span class="n">score_bonus</span> <span class="o">=</span> <span class="p">(</span><span class="n">ambition</span> <span class="o">+</span> <span class="n">efficacite</span> <span class="o">+</span> <span class="n">intelligence</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">c_bonus</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="c1"># score global :</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">score_bonus</span> <span class="o">+</span> <span class="n">score_dangers</span>
        <span class="c1"># en fonction de la stratégie de recherche de bonus</span>
        <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">bonus_strategy</span> <span class="o">!=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">STRAT_BONUS_ALL</span><span class="p">:</span>
            <span class="n">score_mvt</span> <span class="o">=</span> <span class="n">efficacite</span> <span class="o">*</span> <span class="n">avance</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="n">score_mvt</span>
        <span class="c1"># enregistrements :</span>
        <span class="n">gdo</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">score</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>

    <span class="c1">#-----&gt; B.5- Sélection de cible, recherche de chemins</span>
    <span class="c1">#-----&gt; B.5.1- Cible temporaire</span>
    <span class="k">def</span> <span class="nf">_select_new_temp_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyse les données, détermine la cible temporaire et le chemin pour y parvenir.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
        <span class="c1"># Séparation des options en fonction des directions</span>
        <span class="c1"># - prioritaires:</span>
        <span class="n">bestdirs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_best_directions</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="n">priorgdolist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">direct</span> <span class="ow">in</span> <span class="n">bestdirs</span><span class="p">:</span>
            <span class="n">priorgdolist</span> <span class="o">+=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_GDObj_list_by_dir</span><span class="p">(</span><span class="n">direct</span><span class="p">)</span>
        <span class="c1"># - autres</span>
        <span class="n">otherdirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">LIST_DIRECTIONS</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bestdirs</span><span class="p">]</span>
        <span class="n">othergdolist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">direct</span> <span class="ow">in</span> <span class="n">otherdirs</span><span class="p">:</span>
            <span class="n">othergdolist</span> <span class="o">+=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_GDObj_list_by_dir</span><span class="p">(</span><span class="n">direct</span><span class="p">)</span>
        <span class="c1"># Clefs de trie :</span>
        <span class="n">descsortkey</span> <span class="o">=</span> <span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">)</span>  <span class="c1"># par défaut</span>
        <span class="n">ascsortkey</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_BUILDER</span><span class="p">:</span>
            <span class="n">ascsortkey</span> <span class="o">=</span> <span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;count_cases_murs&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_SAPPER</span><span class="p">:</span>
            <span class="n">ascsortkey</span> <span class="o">=</span> <span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;count_cases_dangers&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">midSUR</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;instinct_survie&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">need_bonus</span><span class="p">:</span>
                <span class="n">descsortkey</span> <span class="o">=</span> <span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">,</span> <span class="s2">&quot;count_cases_bonus&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">robot</span><span class="o">.</span><span class="n">instinct_survie</span> <span class="o">&gt;</span> <span class="n">midSUR</span><span class="p">:</span>
                <span class="n">ascsortkey</span> <span class="o">=</span> <span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;count_bot_defense&quot;</span><span class="p">,</span> <span class="s2">&quot;count_cases_dangers&quot;</span><span class="p">)</span>
        <span class="c1"># Recherche de la meilleure option :</span>
        <span class="n">bestopt</span><span class="p">,</span> <span class="n">bestopt_dir</span><span class="p">,</span> <span class="n">finaleopt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="c1"># 1- Recherche dans les directions principales :</span>
        <span class="k">if</span> <span class="n">priorgdolist</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># trie des options</span>
            <span class="k">if</span> <span class="n">ascsortkey</span><span class="p">:</span>
                <span class="n">priorgdolist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">ascsortkey</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">descsortkey</span><span class="p">:</span>
                <span class="n">priorgdolist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">descsortkey</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">gdo</span> <span class="ow">in</span> <span class="n">priorgdolist</span><span class="p">:</span>
                <span class="n">selected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_GambleDataObject</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">gdo</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">selected</span><span class="p">:</span>
                    <span class="n">bestopt_dir</span> <span class="o">=</span> <span class="n">gdo</span>
                    <span class="k">break</span>
        <span class="c1"># 2- Recherche dans les autres directions :</span>
        <span class="k">if</span> <span class="n">bestopt_dir</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ascsortkey</span><span class="p">:</span>
                <span class="n">othergdolist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">ascsortkey</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">descsortkey</span><span class="p">:</span>
                <span class="n">othergdolist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">descsortkey</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">gdo</span> <span class="ow">in</span> <span class="n">othergdolist</span><span class="p">:</span>
                <span class="n">selected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_GambleDataObject</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">gdo</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">selected</span><span class="p">:</span>
                    <span class="n">bestopt</span> <span class="o">=</span> <span class="n">gdo</span>
                    <span class="k">break</span>
        <span class="c1"># 3- Choix de l&#39;option finale :</span>
        <span class="k">if</span> <span class="n">bestopt_dir</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">finaleopt</span> <span class="o">=</span> <span class="n">bestopt_dir</span>
        <span class="k">elif</span> <span class="n">bestopt</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">finaleopt</span> <span class="o">=</span> <span class="n">bestopt</span>
        <span class="c1"># Affectation de la nouvelle cible temporaire :</span>
        <span class="k">if</span> <span class="n">finaleopt</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># point d&#39;entrée de la cible</span>
            <span class="n">target_case</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">finaleopt</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">finaleopt</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="n">newtarget</span> <span class="o">=</span> <span class="n">TargetObject</span><span class="p">(</span>
                <span class="n">TargetObject</span><span class="o">.</span><span class="n">TARGET_TEMP</span><span class="p">,</span>
                <span class="n">target_case</span><span class="p">,</span>
                <span class="n">finaleopt</span><span class="o">.</span><span class="n">direct</span><span class="p">,</span>
                <span class="n">finaleopt</span><span class="o">.</span><span class="n">axe</span><span class="p">,</span>
                <span class="n">finaleopt</span><span class="o">.</span><span class="n">sens</span><span class="p">,</span>
                <span class="n">finaleopt</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">newtarget</span><span class="o">.</span><span class="n">targetpath</span> <span class="o">=</span> <span class="n">finaleopt</span><span class="o">.</span><span class="n">targetpath</span>
            <span class="n">newtarget</span><span class="o">.</span><span class="n">pathcost</span> <span class="o">=</span> <span class="n">finaleopt</span><span class="o">.</span><span class="n">pathcost</span>
            <span class="c1"># dernière case libre</span>
            <span class="n">last_free_case</span> <span class="o">=</span> <span class="n">finaleopt</span><span class="o">.</span><span class="n">last_free_case</span>
            <span class="n">newtarget</span><span class="o">.</span><span class="n">last_free_case</span> <span class="o">=</span> <span class="n">last_free_case</span>
            <span class="c1"># liste des cases associées</span>
            <span class="n">newtarget</span><span class="o">.</span><span class="n">listcases</span> <span class="o">=</span> <span class="n">finaleopt</span><span class="o">.</span><span class="n">listcases</span>
            <span class="c1"># affectation</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">set_temp_target</span><span class="p">(</span><span class="n">newtarget</span><span class="p">)</span>
            <span class="n">gdSet</span><span class="o">.</span><span class="n">finaleoption</span> <span class="o">=</span> <span class="n">finaleopt</span>

    <span class="k">def</span> <span class="nf">_select_best_directions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sélectionne les meilleures directions de recherche de cible.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">listdirect</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="c1"># directions vers la cible principale</span>
        <span class="n">maindirs</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">maintarget_directions</span>
        <span class="n">choose_main</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Cas particulier : recherche de bonus tous azimuts ou absence de</span>
        <span class="c1"># cible principale</span>
        <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">bonus_strategy</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">STRAT_BONUS_ALL</span> <span class="ow">or</span> <span class="n">maindirs</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">choose_main</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># cas standard : directions principales</span>
        <span class="k">if</span> <span class="n">choose_main</span><span class="p">:</span>
            <span class="n">listdirect</span> <span class="o">+=</span> <span class="n">maindirs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Sélection via le score des directions</span>
            <span class="c1"># Calcul du score de ref (50% du max)</span>
            <span class="n">refscore</span> <span class="o">=</span> <span class="n">maxscore</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">direct</span> <span class="ow">in</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">LIST_DIRECTIONS</span><span class="p">:</span>
                <span class="n">cumuldict</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_cumul_by_dir</span><span class="p">(</span><span class="n">direct</span><span class="p">)</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">cumuldict</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span>
                <span class="n">maxscore</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">maxscore</span><span class="p">)</span>
            <span class="n">refscore</span> <span class="o">=</span> <span class="n">maxscore</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="c1"># Sélection des directions les plus performantes</span>
            <span class="k">for</span> <span class="n">direct</span> <span class="ow">in</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">LIST_DIRECTIONS</span><span class="p">:</span>
                <span class="n">cumuldict</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_cumul_by_dir</span><span class="p">(</span><span class="n">direct</span><span class="p">)</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">cumuldict</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">direct</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">listdirect</span> <span class="ow">and</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="n">refscore</span><span class="p">:</span>
                    <span class="n">listdirect</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">direct</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">listdirect</span>

    <span class="k">def</span> <span class="nf">_select_GambleDataObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">gdo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Peut on retenir gdo comme future cible temporaire?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Evaluation de l&#39;accessibilité</span>
        <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
        <span class="n">case</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">gdo</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">gdo</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">case</span><span class="o">.</span><span class="n">type_case</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_NO_TARGET</span><span class="p">:</span>
            <span class="c1"># Accessibilité ?</span>
            <span class="n">gdo</span><span class="o">.</span><span class="n">targetpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_TargetPath</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">gdo</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">gdo</span><span class="o">.</span><span class="n">targetpath</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">gdo</span><span class="o">.</span><span class="n">pathcost</span> <span class="o">=</span> <span class="n">gdo</span><span class="o">.</span><span class="n">targetpath</span><span class="o">.</span><span class="n">cost</span>
                <span class="c1"># cible accessible on peut la sélectionner</span>
                <span class="n">selected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># retour :</span>
        <span class="k">return</span> <span class="n">selected</span>

    <span class="c1">#-----&gt; B.5.2- Interface de recherche de chemins</span>
    <span class="k">def</span> <span class="nf">_search_TargetPath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">baseObj</span><span class="p">,</span> <span class="n">ecomode</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recherche le meilleur chemin allant du robot à la case associée au baseObj</span>
<span class="sd">        </span>
<span class="sd">        * baseObj : un objet GambleDataObject, TargetObject ou Case</span>
<span class="sd">        * ecomode : limite la charge de calcul en limitant la recherche de</span>
<span class="sd">          combinaisons de lancers de grenade aux jets directs</span>
<span class="sd">          </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># enregistrement temporaire des dangers bloquants</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pathblocklist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="c1"># en fonction de l&#39;objet passé en paramètre</span>
        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_case_for_baseObj</span><span class="p">(</span><span class="n">baseObj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pathblocklist</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># coordonnées :</span>
        <span class="n">xr</span><span class="p">,</span> <span class="n">yr</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span>
        <span class="n">xt</span><span class="p">,</span> <span class="n">yt</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">case</span><span class="o">.</span><span class="n">y</span>
        <span class="c1"># cache ?</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">xt</span><span class="p">,</span> <span class="n">yt</span><span class="p">,</span> <span class="n">ecomode</span><span class="p">)</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">cachedresult</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_TargetPath_in_cache</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cachedresult</span> <span class="o">!=</span> <span class="s2">&quot;not in cache&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cachedresult</span>
        <span class="c1"># enregistrement temporaire des dangers bloquants</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pathblocklist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="c1"># Recherche : en fonction de la longueur du chemin</span>
        <span class="n">finalpath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">pathlength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_path_length_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pathlength</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># recherche exhaustive :</span>
            <span class="n">finalpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_short_TargetPath</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">ecomode</span><span class="o">=</span><span class="n">ecomode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># recherche optimisée</span>
            <span class="n">finalpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_long_TargetPath</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">ecomode</span><span class="o">=</span><span class="n">ecomode</span><span class="p">)</span>
        <span class="c1"># mise en cache :</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">finalpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pathblocklist</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">gdSet</span><span class="o">.</span><span class="n">cache_TargetPath</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="c1"># retour</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_get_case_for_baseObj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">baseObj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recherche la case associée à l&#39;objet</span>
<span class="sd">        baseObj : un objet GambleDataObject, TargetObject ou Case</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
        <span class="c1"># en fonction de l&#39;objet passé en paramètre</span>
        <span class="n">case</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">baseObj</span><span class="p">)</span> <span class="ow">is</span> <span class="n">GambleDataObject</span><span class="p">:</span>
            <span class="n">case</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">baseObj</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">baseObj</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">baseObj</span><span class="p">)</span> <span class="ow">is</span> <span class="n">TargetObject</span><span class="p">:</span>
            <span class="n">case</span> <span class="o">=</span> <span class="n">baseObj</span><span class="o">.</span><span class="n">case</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">baseObj</span><span class="p">,</span> <span class="n">Case</span><span class="p">):</span>
            <span class="n">case</span> <span class="o">=</span> <span class="n">baseObj</span>
        <span class="k">return</span> <span class="n">case</span>

    <span class="k">def</span> <span class="nf">_update_or_discard_TargetPath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">tp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retourne un boolean indiquant si le chemin est encore valable et le</span>
<span class="sd">        chemin mis à jour ou None</span>
<span class="sd">        Si c&#39;est le cas, les étape du chemin sont mises à jour.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tp</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">dodiscard</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">newpath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
        <span class="n">oldsteplist</span> <span class="o">=</span> <span class="n">tp</span><span class="o">.</span><span class="n">get_steps_list</span><span class="p">()</span>
        <span class="c1"># coûts de parcours</span>
        <span class="n">oldcost</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">newcost</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">oldsteplist</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="n">botinpath</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">newtpslist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">oldstep</span> <span class="ow">in</span> <span class="n">oldsteplist</span><span class="p">:</span>
            <span class="n">oldcase</span> <span class="o">=</span> <span class="n">oldstep</span><span class="o">.</span><span class="n">case</span>
            <span class="n">newcase</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">oldstep</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">oldstep</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="n">newtps</span> <span class="o">=</span> <span class="n">TargetPathStep</span><span class="p">(</span><span class="n">newcase</span><span class="p">)</span>
            <span class="n">newtpslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newtps</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">newcase</span> <span class="o">==</span> <span class="n">robot</span><span class="p">:</span>
                <span class="n">botinpath</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="n">oldcost</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_case_cost</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">oldcase</span><span class="p">)</span>
            <span class="n">newcost</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_case_cost</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">newcase</span><span class="p">)</span>
        <span class="n">oldsteplist</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">newcost</span> <span class="o">&gt;</span> <span class="n">oldcost</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">botinpath</span><span class="p">:</span>
            <span class="c1"># le coût de parcours augmente ou le bot est sorti du chemin</span>
            <span class="n">dodiscard</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># cible conservée, mise à jour du parcours:</span>
            <span class="n">newtpslist</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="n">newpath</span> <span class="o">=</span> <span class="n">TargetPath</span><span class="p">(</span><span class="n">steplist</span><span class="o">=</span><span class="n">newtpslist</span><span class="p">)</span>
            <span class="n">newpath</span><span class="o">.</span><span class="n">cost</span> <span class="o">=</span> <span class="n">newcost</span>
        <span class="k">return</span> <span class="n">dodiscard</span><span class="p">,</span> <span class="n">newpath</span>

    <span class="c1">#-----&gt; B.5.3- Recherche exhaustive de chemins</span>
    <span class="k">def</span> <span class="nf">_search_short_TargetPath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">ecomode</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recherche exhaustive du meilleur chemin allant du robot à la case</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># coordonnées :</span>
        <span class="n">xr</span><span class="p">,</span> <span class="n">yr</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span>
        <span class="n">xt</span><span class="p">,</span> <span class="n">yt</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">case</span><span class="o">.</span><span class="n">y</span>
        <span class="c1"># cache ?</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">xt</span><span class="p">,</span> <span class="n">yt</span><span class="p">,</span> <span class="n">ecomode</span><span class="p">)</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">cachedresult</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_TargetPath_in_cache</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cachedresult</span> <span class="o">!=</span> <span class="s2">&quot;not in cache&quot;</span><span class="p">:</span>
            <span class="n">cachedpath</span> <span class="o">=</span> <span class="n">cachedresult</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">cachedpath</span>
        <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
        <span class="c1"># sous matrice :</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">xt</span><span class="p">)</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="n">yt</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">xr</span> <span class="o">-</span> <span class="n">xt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">yr</span> <span class="o">-</span> <span class="n">yt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_submatrice</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
        <span class="c1"># directions de parcours :</span>
        <span class="n">maindir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dir_for_case</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maindir</span> <span class="ow">in</span> <span class="p">[</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">]:</span>
            <span class="n">dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">maindir</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">TOP</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">BOTTOM</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">maindir</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">]</span>
        <span class="c1"># Arbre de parcours :</span>
        <span class="n">pathtree</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">robot</span><span class="p">,</span> <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;pathlist&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xlook_for_steps</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">pathtree</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">ecomode</span><span class="o">=</span><span class="n">ecomode</span><span class="p">)</span>
        <span class="c1"># TargetPath associés :</span>
        <span class="n">listtargetpath</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="c1"># cas particulier des simulations, le robot n&#39;est pas forcément la</span>
        <span class="c1"># première case</span>
        <span class="n">firstcase</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">inittgtpath</span> <span class="o">=</span> <span class="n">TargetPath</span><span class="p">([</span><span class="n">TargetPathStep</span><span class="p">(</span><span class="n">firstcase</span><span class="p">)])</span>
        <span class="n">listtargetpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xcreate_TargetPaths</span><span class="p">(</span>
            <span class="n">listtargetpath</span><span class="p">,</span> <span class="n">pathtree</span><span class="p">,</span> <span class="n">inittgtpath</span>
        <span class="p">)</span>
        <span class="c1"># sélection des chemins complets :</span>
        <span class="n">completelist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="n">listtargetpath</span><span class="p">:</span>
            <span class="n">lasttps</span> <span class="o">=</span> <span class="n">tp</span><span class="o">.</span><span class="n">get_last_step</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">lasttps</span><span class="o">.</span><span class="n">case</span> <span class="o">==</span> <span class="n">case</span><span class="p">:</span>
                <span class="n">completelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
        <span class="c1"># évaluations :</span>
        <span class="n">finalpath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">completelist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="n">completelist</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">tps</span> <span class="ow">in</span> <span class="n">tp</span><span class="o">.</span><span class="n">get_steps_list</span><span class="p">():</span>
                    <span class="n">tp</span><span class="o">.</span><span class="n">cost</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_case_cost</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">tps</span><span class="o">.</span><span class="n">case</span><span class="p">)</span>
                <span class="n">tp</span><span class="o">.</span><span class="n">cost</span> <span class="o">-=</span> <span class="mi">2</span>  <span class="c1"># robot compté pour 2</span>
            <span class="c1"># trie par coût croissant :</span>
            <span class="n">completelist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;cost&quot;</span><span class="p">))</span>
            <span class="n">finalpath</span> <span class="o">=</span> <span class="n">completelist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># mise en cache :</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">finalpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pathblocklist</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">gdSet</span><span class="o">.</span><span class="n">cache_TargetPath</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="c1"># retour</span>
        <span class="k">return</span> <span class="n">finalpath</span>

    <span class="k">def</span> <span class="nf">_compute_case_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calcul du coût de parcours d&#39;une case</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">tc</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">type_case</span>
        <span class="k">if</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_CASES_BONUS</span><span class="p">:</span>
            <span class="n">cost</span> <span class="o">-=</span> <span class="nb">int</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">need_bonus</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_CASES_LIBRES</span><span class="p">:</span>
            <span class="n">cost</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">tc</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_DANGER</span><span class="p">:</span>
            <span class="n">cost</span> <span class="o">+=</span> <span class="n">case</span><span class="o">.</span><span class="n">danger_impact</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cost</span> <span class="o">+=</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">cost</span>

    <span class="k">def</span> <span class="nf">_xcreate_TargetPaths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">listtargetpath</span><span class="p">,</span> <span class="n">pathtree</span><span class="p">,</span> <span class="n">tgtpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Génère les objets TargetPath à partir de l&#39;arbre de parcours</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pathlist</span> <span class="o">=</span> <span class="n">pathtree</span><span class="p">[</span><span class="s2">&quot;pathlist&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pathlist</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ptree</span> <span class="ow">in</span> <span class="n">pathlist</span><span class="p">:</span>
                <span class="n">case</span> <span class="o">=</span> <span class="n">ptree</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span>
                <span class="n">tps</span> <span class="o">=</span> <span class="n">TargetPathStep</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>
                <span class="n">tp</span> <span class="o">=</span> <span class="n">tgtpath</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">tp</span><span class="o">.</span><span class="n">add_pathstep</span><span class="p">(</span><span class="n">tps</span><span class="p">)</span>
                <span class="n">listtargetpath</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
                <span class="c1"># récursivité :</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_xcreate_TargetPaths</span><span class="p">(</span><span class="n">listtargetpath</span><span class="p">,</span> <span class="n">ptree</span><span class="p">,</span> <span class="n">tp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">listtargetpath</span>

    <span class="k">def</span> <span class="nf">_xlook_for_steps</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">pathtree</span><span class="p">,</span> <span class="n">submat</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">xcoords</span><span class="o">=</span><span class="nb">list</span><span class="p">(),</span> <span class="n">ecomode</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recherche récursive de l&#39;arbre de parcours</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">case</span> <span class="o">=</span> <span class="n">pathtree</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">pathtree</span><span class="p">[</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span>
        <span class="n">newxcoords</span> <span class="o">=</span> <span class="p">[</span><span class="n">coord</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">xcoords</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xp</span><span class="p">,</span> <span class="n">yp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="n">newxcoords</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">xp</span><span class="p">,</span> <span class="n">yp</span><span class="p">))</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">case</span><span class="o">.</span><span class="n">y</span>
        <span class="k">for</span> <span class="n">direct</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
            <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">direct</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">TOP</span><span class="p">:</span>
                <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">direct</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">BOTTOM</span><span class="p">:</span>
                <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">direct</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">LEFT</span><span class="p">:</span>
                <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">y</span>
            <span class="k">elif</span> <span class="n">direct</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">:</span>
                <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">y</span>
            <span class="n">childcase</span> <span class="o">=</span> <span class="n">submat</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">childcase</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">newxcoords</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valide_path_step</span><span class="p">(</span><span class="n">childcase</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">ecomode</span><span class="o">=</span><span class="n">ecomode</span><span class="p">):</span>
                    <span class="n">childpathtree</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">childcase</span><span class="p">,</span>
                        <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="n">case</span><span class="p">,</span>
                        <span class="s2">&quot;pathlist&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(),</span>
                    <span class="p">}</span>
                    <span class="n">pathtree</span><span class="p">[</span><span class="s2">&quot;pathlist&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">childpathtree</span><span class="p">)</span>
                    <span class="c1"># récursivité :</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_xlook_for_steps</span><span class="p">(</span>
                        <span class="n">robot</span><span class="p">,</span> <span class="n">childpathtree</span><span class="p">,</span> <span class="n">submat</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">xcoords</span><span class="o">=</span><span class="n">newxcoords</span>
                    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_valide_path_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">ecomode</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Indique si la case peut constituer une étape de chemin</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valide</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">case</span><span class="o">.</span><span class="n">type_case</span> <span class="ow">in</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_TARGET</span><span class="p">:</span>
            <span class="n">valide</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">case</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_ROBOT</span><span class="p">:</span>
            <span class="n">kill_all</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;kill_all&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">kill_all</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># action kill possible</span>
                    <span class="n">valide</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">robot</span><span class="o">.</span><span class="n">has_grenade</span><span class="p">:</span>
                    <span class="c1"># recherche de combinaisons de lancers de grenade</span>
                    <span class="c1"># (directes par défaut - ecomode=True)</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_params_for_grenade</span><span class="p">(</span>
                        <span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">directonly</span><span class="o">=</span><span class="n">ecomode</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">params</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">valide</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">case</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_DANGER</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">has_grenade</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">case</span><span class="o">.</span><span class="n">danger_impact</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">valide</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># en fonction de la distance :</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
                    <span class="n">dgr_radius</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">get_danger_radius</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">dgr_radius</span> <span class="o">&gt;=</span> <span class="n">d</span><span class="p">:</span>
                        <span class="c1"># optimisation : on écarte l&#39;étape, même si le rayon réel</span>
                        <span class="c1"># peut être inférieur (cas des impacts = 5, 13, 17, en</span>
                        <span class="c1"># fonction de l&#39;angle du vecteur robot / danger)</span>
                        <span class="n">valide</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># recherche de combinaisons de lancers de grenade</span>
                        <span class="c1"># (directes par défaut - ecomode=True)</span>
                        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_params_for_grenade</span><span class="p">(</span>
                            <span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">directonly</span><span class="o">=</span><span class="n">ecomode</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">params</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">valide</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valide</span><span class="p">:</span>
            <span class="c1"># enregistrement temporaire du blocage</span>
            <span class="k">if</span> <span class="n">case</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_DANGER</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pathblocklist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">valide</span>

    <span class="c1">#-----&gt; B.5.4- Recherche optimisée sur de longues distances</span>
    <span class="k">def</span> <span class="nf">_search_long_TargetPath</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">ecomode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subtargetpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">excludedpoints</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Version optimisée de _search_TargetPath pour des parcours longs.</span>
<span class="sd">        Résultat non assuré : le déplacement du robot le long des sous chemins</span>
<span class="sd">        est simulé. Pour l&#39;un de ces sous chemins, l&#39;étape de validation peut</span>
<span class="sd">        considérer que le robot est trop près d&#39;un danger alors qu&#39;il a la</span>
<span class="sd">        possibilité de terraformer bien en amont.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">targetpath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">valide</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># mémorisation des coords initiales du robot :</span>
        <span class="n">xref</span><span class="p">,</span> <span class="n">yref</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="c1"># liste des TargetPath à concaténer, points à exclure des échantillons</span>
        <span class="k">if</span> <span class="n">subtargetpath</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># démarrage du process de recherche</span>
            <span class="n">subtargetpath</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">excludedpoints</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="c1"># case constituant le départ du nouveau sous chemin</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subtargetpath</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">prevcase</span> <span class="o">=</span> <span class="n">robot</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># reprise du process de recherche après un échec</span>
            <span class="n">lastsubtp</span> <span class="o">=</span> <span class="n">subtargetpath</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">lasttps</span> <span class="o">=</span> <span class="n">lastsubtp</span><span class="o">.</span><span class="n">get_last_step</span><span class="p">()</span>
            <span class="n">prevcase</span> <span class="o">=</span> <span class="n">lasttps</span><span class="o">.</span><span class="n">case</span>
        <span class="c1"># recherche...</span>
        <span class="k">while</span> <span class="n">prevcase</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prevcase</span> <span class="o">!=</span> <span class="n">case</span><span class="p">:</span>
            <span class="n">valide</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># meilleur sous chemin trouvé par recherche rapide</span>
            <span class="n">sub_tp</span><span class="p">,</span> <span class="n">samplecount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fast_search_next_step</span><span class="p">(</span>
                <span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">ecomode</span><span class="o">=</span><span class="n">ecomode</span><span class="p">,</span> <span class="n">excludedpoints</span><span class="o">=</span><span class="n">excludedpoints</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">sub_tp</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">laststep</span> <span class="o">=</span> <span class="n">sub_tp</span><span class="o">.</span><span class="n">get_last_step</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">laststep</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">valide</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># incrément</span>
                    <span class="n">prevcase</span> <span class="o">=</span> <span class="n">laststep</span><span class="o">.</span><span class="n">case</span>
                    <span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">prevcase</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">prevcase</span><span class="o">.</span><span class="n">y</span>
                    <span class="n">subtargetpath</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_tp</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valide</span><span class="p">:</span>
                <span class="c1"># Retour en arrière ?</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subtargetpath</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">samplecount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># d&#39;autres échantillons existent :</span>
                    <span class="c1"># - on élimine le sous chemin menant à un échec :</span>
                    <span class="n">delsubtp</span> <span class="o">=</span> <span class="n">subtargetpath</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="c1"># - on ajoute les coordonnées de l&#39;échantillon à exclure</span>
                    <span class="n">excludedtps</span> <span class="o">=</span> <span class="n">delsubtp</span><span class="o">.</span><span class="n">get_last_step</span><span class="p">()</span>
                    <span class="n">excludedcase</span> <span class="o">=</span> <span class="n">excludedtps</span><span class="o">.</span><span class="n">case</span>
                    <span class="n">excludedpoints</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">excludedcase</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">excludedcase</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
                    <span class="c1"># - rétablissement des coordonnées du robot:</span>
                    <span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">xref</span><span class="p">,</span> <span class="n">yref</span>
                    <span class="c1"># - on relance la recherche</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_long_TargetPath</span><span class="p">(</span>
                        <span class="n">robot</span><span class="p">,</span>
                        <span class="n">case</span><span class="p">,</span>
                        <span class="n">ecomode</span><span class="o">=</span><span class="n">ecomode</span><span class="p">,</span>
                        <span class="n">subtargetpath</span><span class="o">=</span><span class="n">subtargetpath</span><span class="p">,</span>
                        <span class="n">excludedpoints</span><span class="o">=</span><span class="n">excludedpoints</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># recherche définitivement en échec</span>
                    <span class="k">break</span>
        <span class="c1"># Concaténation des sous parcours:</span>
        <span class="k">if</span> <span class="n">valide</span><span class="p">:</span>
            <span class="n">targetpath</span> <span class="o">=</span> <span class="n">TargetPath</span><span class="p">()</span>
            <span class="n">prevcoords</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">defstepslist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">subtp</span> <span class="ow">in</span> <span class="n">subtargetpath</span><span class="p">:</span>
                <span class="n">substeps</span> <span class="o">=</span> <span class="n">subtp</span><span class="o">.</span><span class="n">get_steps_list</span><span class="p">()</span>
                <span class="n">subcoords</span> <span class="o">=</span> <span class="n">subtp</span><span class="o">.</span><span class="n">get_coords_list</span><span class="p">()</span>
                <span class="c1"># élimination des redondances</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prevcoords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">prevcoords</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">prevcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">subcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">lp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prevcoords</span><span class="p">)</span>
                        <span class="n">ls</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subcoords</span><span class="p">)</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">ls</span><span class="p">)</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">prevcoords</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">subcoords</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">break</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># nettoyage du nouveau sous parcours</span>
                        <span class="n">substeps</span> <span class="o">=</span> <span class="n">substeps</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
                        <span class="n">subcoords</span> <span class="o">=</span> <span class="n">subcoords</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># nettoyage de la liste finale d&#39;étape</span>
                        <span class="n">defstepslist</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                        <span class="n">defstepslist</span> <span class="o">=</span> <span class="n">defstepslist</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
                        <span class="n">defstepslist</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="c1"># alimentation de la liste finale</span>
                <span class="k">for</span> <span class="n">tps</span> <span class="ow">in</span> <span class="n">substeps</span><span class="p">:</span>
                    <span class="n">defstepslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tps</span><span class="p">)</span>
                <span class="c1"># incrément :</span>
                <span class="n">prevcoords</span> <span class="o">=</span> <span class="n">subcoords</span>
            <span class="c1"># constitution du parcours final :</span>
            <span class="n">targetpath</span> <span class="o">=</span> <span class="n">TargetPath</span><span class="p">(</span><span class="n">steplist</span><span class="o">=</span><span class="n">defstepslist</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tps</span> <span class="ow">in</span> <span class="n">defstepslist</span><span class="p">:</span>
                <span class="n">targetpath</span><span class="o">.</span><span class="n">cost</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_case_cost</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">tps</span><span class="o">.</span><span class="n">case</span><span class="p">)</span>
            <span class="n">targetpath</span><span class="o">.</span><span class="n">cost</span> <span class="o">-=</span> <span class="mi">2</span>  <span class="c1"># robot compté pour 2</span>
        <span class="c1"># rétablissement des coordonnées du robot:</span>
        <span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">xref</span><span class="p">,</span> <span class="n">yref</span>
        <span class="c1"># retour</span>
        <span class="k">return</span> <span class="n">targetpath</span>

    <span class="k">def</span> <span class="nf">_fast_search_next_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">ecomode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">excludedpoints</span><span class="o">=</span><span class="nb">list</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recherche rapide d&#39;un chemin entre la position actuelle du robot et la</span>
<span class="sd">        case.</span>
<span class="sd">        Retourne :</span>
<span class="sd">        </span>
<span class="sd">        * un TargetPath ou None</span>
<span class="sd">        * le nombre d&#39;échantillons testés, 0 par défaut (si recherche de path</span>
<span class="sd">          déléguée à _search_short_TargetPath)</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">targetpath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">samplecount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># constantes d&#39;optimisation</span>
        <span class="n">ptbyline</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">dlength</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="c1"># en fonction de la distance restant à parcourir :</span>
        <span class="n">pathlength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_path_length_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pathlength</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">targetpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_short_TargetPath</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">ecomode</span><span class="o">=</span><span class="n">ecomode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xr</span><span class="p">,</span> <span class="n">yr</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span>
            <span class="n">xt</span><span class="p">,</span> <span class="n">yt</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">case</span><span class="o">.</span><span class="n">y</span>
            <span class="c1"># recherche d&#39;échantillons</span>
            <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
            <span class="n">vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_vector_for_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;xy&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">vector</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># échantillons sur x :</span>
                <span class="n">sens</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">vector</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sens</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">samples</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_path_samples_on_axis</span><span class="p">(</span>
                    <span class="n">robot</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">sens</span><span class="p">,</span> <span class="n">ptbyline</span><span class="p">,</span> <span class="n">dlength</span><span class="p">,</span> <span class="n">excludedpoints</span><span class="o">=</span><span class="n">excludedpoints</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">vector</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># échantillons sur y :</span>
                <span class="n">sens</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">vector</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sens</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">samples</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_path_samples_on_axis</span><span class="p">(</span>
                    <span class="n">robot</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">sens</span><span class="p">,</span> <span class="n">ptbyline</span><span class="p">,</span> <span class="n">dlength</span><span class="p">,</span> <span class="n">excludedpoints</span><span class="o">=</span><span class="n">excludedpoints</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">vector</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">vector</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># échantillons sur xy :</span>
                <span class="c1"># sous matrice :</span>
                <span class="n">xmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">xt</span><span class="p">)</span>
                <span class="n">ymin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="n">yt</span><span class="p">)</span>
                <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">xr</span> <span class="o">-</span> <span class="n">xt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">yr</span> <span class="o">-</span> <span class="n">yt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">sm</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_submatrice</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">strictmode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">smcases</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">get_list_cases</span><span class="p">()</span>
                <span class="n">samples</span><span class="p">[</span><span class="s2">&quot;xy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">smcases</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">excludedpoints</span><span class="p">:</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_path_length_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="n">dlength</span><span class="p">:</span>
                            <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_case_cost</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                            <span class="n">samples</span><span class="p">[</span><span class="s2">&quot;xy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">cost</span><span class="p">})</span>
            <span class="c1"># sélection des meilleurs échantillons pour x, y et xy</span>
            <span class="n">bestsamples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">linesearch</span> <span class="ow">in</span> <span class="n">samples</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">linesamples</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="n">linesearch</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">linesamples</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">linesamples</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">linesamples</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;cost&quot;</span><span class="p">))</span>
                    <span class="n">bestforline</span> <span class="o">=</span> <span class="n">linesamples</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">bestsamples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bestforline</span><span class="p">)</span>
                    <span class="n">samplecount</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">linesamples</span><span class="p">)</span>
            <span class="c1"># calcul des targetpath pour les meilleurs échantillons :</span>
            <span class="n">finalsamples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">dref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_path_length_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sampledict</span> <span class="ow">in</span> <span class="n">bestsamples</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">sampledict</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span>
                <span class="n">dc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_path_length_between_cases</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dc</span> <span class="o">&lt;</span> <span class="n">dref</span><span class="p">:</span>
                    <span class="c1"># évite de diverger de la cible :</span>
                    <span class="n">tp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_short_TargetPath</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">ecomode</span><span class="o">=</span><span class="n">ecomode</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">tp</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">sampledict</span><span class="p">[</span><span class="s2">&quot;tp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span>
                        <span class="c1"># cost / 2 limite l&#39;attraction des bonus</span>
                        <span class="n">sampledict</span><span class="p">[</span><span class="s2">&quot;finalcost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span><span class="o">.</span><span class="n">cost</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dc</span>
                        <span class="n">finalsamples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sampledict</span><span class="p">)</span>
            <span class="c1"># trie des chemins évalués</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">finalsamples</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">finalsamples</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;finalcost&quot;</span><span class="p">))</span>
                <span class="n">targetpath</span> <span class="o">=</span> <span class="n">finalsamples</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;tp&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># on est suffisament proche de la cible :</span>
                <span class="n">targetpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_short_TargetPath</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">ecomode</span><span class="o">=</span><span class="n">ecomode</span><span class="p">)</span>
        <span class="c1"># retour :</span>
        <span class="k">return</span> <span class="n">targetpath</span><span class="p">,</span> <span class="n">samplecount</span>

    <span class="k">def</span> <span class="nf">_get_path_samples_on_axis</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">sens</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">excludedpoints</span><span class="o">=</span><span class="nb">list</span><span class="p">()</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collecte des échantillons pour la recherche rapide de path</span>
<span class="sd">        sur l&#39;axe &quot;x&quot; ou &quot;y&quot;</span>
<span class="sd">        Retourne une liste de dicts {&quot;case&quot;:, &quot;cost&quot;;}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xr</span><span class="p">,</span> <span class="n">yr</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span>
        <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="c1"># recherche de points dans la zone jouable</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">count</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">yrange</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">yr</span> <span class="o">-</span> <span class="n">dy</span><span class="p">,</span> <span class="n">yr</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">yrange</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
                    <span class="n">dx</span> <span class="o">=</span> <span class="n">sens</span> <span class="o">*</span> <span class="p">(</span><span class="n">delta</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">xr</span> <span class="o">+</span> <span class="n">dx</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">c</span> <span class="o">==</span> <span class="kc">None</span>
                        <span class="ow">or</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">play_set</span>
                        <span class="ow">or</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">excludedpoints</span>
                    <span class="p">):</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
                        <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">count</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">xrange</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">xr</span> <span class="o">-</span> <span class="n">dx</span><span class="p">,</span> <span class="n">xr</span> <span class="o">+</span> <span class="n">dx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
                    <span class="n">dy</span> <span class="o">=</span> <span class="n">sens</span> <span class="o">*</span> <span class="p">(</span><span class="n">delta</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">yr</span> <span class="o">+</span> <span class="n">dy</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">c</span> <span class="o">==</span> <span class="kc">None</span>
                        <span class="ow">or</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">play_set</span>
                        <span class="ow">or</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">excludedpoints</span>
                    <span class="p">):</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
                        <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># constitution de l&#39;échantillon</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_case_cost</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                <span class="n">samples</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">cost</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">samples</span>

    <span class="c1">#-----&gt; B.5.5- Approche finale de la cible principale</span>
    <span class="k">def</span> <span class="nf">_search_final_TargetPath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recherche le chemin final vers la cible principale.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">mainTarget</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_main_target</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mainTarget</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">set_temp_target</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">targetpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_TargetPath</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">mainTarget</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">targetpath</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mainTarget</span><span class="o">.</span><span class="n">targetpath</span> <span class="o">=</span> <span class="n">targetpath</span>
                <span class="n">mainTarget</span><span class="o">.</span><span class="n">pathcost</span> <span class="o">=</span> <span class="n">targetpath</span><span class="o">.</span><span class="n">cost</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mainTarget</span><span class="o">.</span><span class="n">targetpath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="c1">#-----&gt; B.6- Qualification des options adjacentes</span>
    <span class="k">def</span> <span class="nf">_evaluate_adjacent_cases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">by_gdSet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retourne les cases adjacentes triées par pertinence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
        <span class="c1"># Options adjacentes :</span>
        <span class="n">optionsadj</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">by_gdSet</span><span class="p">:</span>
            <span class="c1"># via les données collectées</span>
            <span class="n">gdolist</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_full_GDObj_list</span><span class="p">()</span>
            <span class="n">gdolist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;dist_to_bot&quot;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">gdolist</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">dist_to_bot</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">optionsadj</span><span class="p">[</span><span class="n">opt</span><span class="o">.</span><span class="n">direct</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># on crée des objets de mesures temporaires</span>
            <span class="n">adjdict</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_cases_adjacentes</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">direct</span><span class="p">,</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">adjdict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">case</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">gdobj</span> <span class="o">=</span> <span class="n">GambleDataObject</span><span class="p">(</span><span class="n">case</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">case</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">direct</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">optionsadj</span><span class="p">[</span><span class="n">direct</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdobj</span>
        <span class="c1"># enregistrement des cases adjacentes :</span>
        <span class="n">adjlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">direct</span> <span class="ow">in</span> <span class="n">optionsadj</span><span class="p">:</span>
            <span class="n">gdo</span> <span class="o">=</span> <span class="n">optionsadj</span><span class="p">[</span><span class="n">direct</span><span class="p">]</span>
            <span class="n">cadj</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">gdo</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">gdo</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="n">adjlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cadj</span><span class="p">)</span>
        <span class="n">gdSet</span><span class="o">.</span><span class="n">register_list_case</span><span class="p">(</span><span class="s2">&quot;all_adj&quot;</span><span class="p">,</span> <span class="n">adjlist</span><span class="p">)</span>
        <span class="c1"># en fonction de la cible temporaire :</span>
        <span class="n">firstchoice</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">firstlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">tempTarget</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_temp_target</span><span class="p">()</span>
        <span class="n">mainTarget</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_main_target</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tempTarget</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tpslist</span> <span class="o">=</span> <span class="n">tempTarget</span><span class="o">.</span><span class="n">targetpath</span><span class="o">.</span><span class="n">get_steps_list</span><span class="p">()</span>
            <span class="n">nextcase</span> <span class="o">=</span> <span class="n">tpslist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">case</span>
            <span class="n">firstlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nextcase</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mainTarget</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mainTarget</span><span class="o">.</span><span class="n">targetpath</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tpslist</span> <span class="o">=</span> <span class="n">mainTarget</span><span class="o">.</span><span class="n">targetpath</span><span class="o">.</span><span class="n">get_steps_list</span><span class="p">()</span>
                <span class="n">nextcase</span> <span class="o">=</span> <span class="n">tpslist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">case</span>
                <span class="n">firstlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nextcase</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vecteur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_vector_for_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">mainTarget</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">firstchoice</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">optionsadj</span><span class="p">[</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">firstchoice</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">optionsadj</span><span class="p">[</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">LEFT</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">firstchoice</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">optionsadj</span><span class="p">[</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">BOTTOM</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">firstchoice</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">optionsadj</span><span class="p">[</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">TOP</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">gdo</span> <span class="ow">in</span> <span class="n">firstchoice</span><span class="p">:</span>
                    <span class="n">case</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">gdo</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">gdo</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
                    <span class="n">firstlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>
        <span class="n">gdSet</span><span class="o">.</span><span class="n">register_list_case</span><span class="p">(</span><span class="s2">&quot;first_adj&quot;</span><span class="p">,</span> <span class="n">firstlist</span><span class="p">)</span>
        <span class="c1"># bonus adjacents :</span>
        <span class="n">listbonus</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;bonus&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">listbonus</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bonusadj</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">listbonus</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">case</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">listbonus</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">bonusadj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bonusadj</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">gdSet</span><span class="o">.</span><span class="n">register_list_case</span><span class="p">(</span><span class="s2">&quot;bonus_adj&quot;</span><span class="p">,</span> <span class="n">bonusadj</span><span class="p">)</span>
        <span class="c1"># options adjacentes ignorées :</span>
        <span class="n">secondchoice</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">direct</span><span class="p">,</span> <span class="n">gdo</span> <span class="ow">in</span> <span class="n">optionsadj</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">gdo</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">firstchoice</span><span class="p">:</span>
                <span class="n">secondchoice</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gdo</span><span class="p">)</span>
        <span class="n">secondchoice</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">otherlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">gdobj</span> <span class="ow">in</span> <span class="n">secondchoice</span><span class="p">:</span>
            <span class="n">case</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">gdobj</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">gdobj</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">case</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">firstlist</span><span class="p">:</span>
                <span class="n">otherlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>
        <span class="n">gdSet</span><span class="o">.</span><span class="n">register_list_case</span><span class="p">(</span><span class="s2">&quot;other_adj&quot;</span><span class="p">,</span> <span class="n">otherlist</span><span class="p">)</span>
        <span class="c1"># incluse dans safe zone :</span>
        <span class="n">safezonelist</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;safezone&quot;</span><span class="p">)</span>
        <span class="n">safelist</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">adjlist</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">safezonelist</span><span class="p">]</span>
        <span class="n">gdSet</span><span class="o">.</span><span class="n">register_list_case</span><span class="p">(</span><span class="s2">&quot;safe_adj&quot;</span><span class="p">,</span> <span class="n">safelist</span><span class="p">)</span>

    <span class="c1">#-----&gt; B.7- Anticipation de coups consécutifs</span>
    <span class="c1">#-----&gt; B.7.1- Dédiée aux winners et hunters intelligents</span>
    <span class="k">def</span> <span class="nf">_can_schedule_gambles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Indique si le robot peut prévoir plusieurs coups.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="c1"># hunters et winners uniquement</span>
        <span class="n">cond0</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span> <span class="ow">in</span> <span class="p">[</span><span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_HUNTER</span><span class="p">,</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_WINNER</span><span class="p">]</span>
        <span class="c1"># si aucune pseudo action n&#39;est définie</span>
        <span class="n">cond1</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">has_next_pseudoaction</span><span class="p">()</span>
        <span class="c1"># en fontion de son intelligence :</span>
        <span class="n">cond2</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">intelligence</span> <span class="o">&gt;=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span>
            <span class="s2">&quot;intelligence&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span>
        <span class="p">)</span>
        <span class="c1"># en fonction du nombre de coups restants :</span>
        <span class="n">cond3</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># gdSet.gamblecount - gdSet.gamblenumber + 1 &gt; 1</span>
        <span class="c1"># validité des actions prévues :</span>
        <span class="n">cond4</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cond1</span><span class="p">:</span>
            <span class="n">cond4</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pseudoactionlist_validity</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="c1"># retour</span>
        <span class="k">if</span> <span class="n">cond0</span> <span class="ow">and</span> <span class="n">cond1</span> <span class="ow">and</span> <span class="n">cond2</span> <span class="ow">and</span> <span class="n">cond3</span> <span class="ow">and</span> <span class="n">cond4</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_get_pseudoactionlist_validity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Vérifie qu&#39;un danger bloquant ne soit pas apparu dans le parcours.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valide</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">palist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">paobj</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_pseudoactions</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">paobj</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">palist</span> <span class="o">=</span> <span class="n">paobj</span><span class="o">.</span><span class="n">get_pseudoaction_list</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">palist</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">valide</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">pa</span> <span class="ow">in</span> <span class="n">palist</span><span class="p">:</span>
                <span class="n">typepa</span> <span class="o">=</span> <span class="n">pa</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">typepa</span> <span class="o">==</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">pa</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">]</span>
                    <span class="n">tc</span> <span class="o">=</span> <span class="n">pa</span><span class="p">[</span><span class="s2">&quot;type_case&quot;</span><span class="p">]</span>
                    <span class="n">actcase</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">actcase</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_DANGER</span><span class="p">:</span>
                        <span class="c1"># nouveau danger ?</span>
                        <span class="k">if</span> <span class="n">tc</span> <span class="o">!=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_DANGER</span><span class="p">:</span>
                            <span class="c1"># quel rayon, quelle distance</span>
                            <span class="n">actradius</span> <span class="o">=</span> <span class="n">actcase</span><span class="o">.</span><span class="n">get_danger_radius</span><span class="p">()</span>
                            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span>
                                <span class="n">robot</span><span class="p">,</span> <span class="n">actcase</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">actradius</span><span class="p">:</span>
                                <span class="c1"># on invalide les actions programmées</span>
                                <span class="n">valide</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">gdSet</span><span class="o">.</span><span class="n">register_pseudoactions</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                                <span class="k">break</span>
        <span class="k">return</span> <span class="n">valide</span>

    <span class="c1">#-----&gt; B.7.2- Recherche d&#39;une série de commandes : analyse et décisions</span>
    <span class="k">def</span> <span class="nf">_schedule_next_gambles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Méthode principale d&#39;anticipation de plusieurs coups.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># paramètres</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">gsearch</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">gamblesearch</span>
        <span class="c1"># 1- Initialisation de la recherche :</span>
        <span class="k">if</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">gamblenumber</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># priorisation des objectifs :</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_define_scheduled_ordered_objectifs</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="n">gsearch</span><span class="o">.</span><span class="n">maxactions</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">gamblecount</span> <span class="o">-</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">gamblenumber</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c1"># identification des possibilités</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_define_scheduled_possibilities</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="c1"># 2- Actions optimales</span>
        <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyse_optimal_actions</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="c1"># 3- Actions selon les objectifs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">finded</span><span class="p">:</span>
            <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyse_actions_by_objectifs</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="c1"># 4- Récupération de bonus :</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">finded</span><span class="p">:</span>
            <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_scheduled_bonus</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="c1"># 5- Revue des actions évaluées :</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">finded</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">gsearch</span><span class="o">.</span><span class="n">paObjlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># peut on se contenter d&#39;une action de pertinence moyenne?</span>
            <span class="n">paolist</span> <span class="o">=</span> <span class="p">[</span><span class="n">pao</span> <span class="k">for</span> <span class="n">pao</span> <span class="ow">in</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">paObjlist</span> <span class="k">if</span> <span class="n">pao</span><span class="o">.</span><span class="n">relevantfactor</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">paolist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">paolist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">paObj</span> <span class="o">=</span> <span class="n">paolist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">finded</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># 6- Actions désespérées si aucun objectif n&#39;a pu être atteint</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">finded</span><span class="p">:</span>
            <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyse_desperate_actions</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="c1"># 7- Meileur score :</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gsearch</span><span class="o">.</span><span class="n">paObjlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">gsearch</span><span class="o">.</span><span class="n">paObjlist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;relevantfactor&quot;</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">paObj</span> <span class="o">=</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">paObjlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">finded</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># 8- Enregistrement de la pseudos action trouvée :</span>
        <span class="k">if</span> <span class="n">finded</span><span class="p">:</span>
            <span class="n">gdSet</span><span class="o">.</span><span class="n">register_pseudoactions</span><span class="p">(</span><span class="n">paObj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">paObj</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PA_STAY_IN_PLACE</span><span class="p">:</span>
                <span class="c1"># incrément du nombre de pa no move :</span>
                <span class="n">robot</span><span class="o">.</span><span class="n">no_move_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">robot</span><span class="o">.</span><span class="n">no_move_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_define_scheduled_ordered_objectifs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Définit la liste des objectifs triés par priorité en fonction du robot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">objectifs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="c1"># - caractéristiques du robot</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">behavior</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span>
        <span class="n">ambition</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">ambition</span>
        <span class="n">instinct_survie</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">instinct_survie</span>
        <span class="n">aggressivite</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">aggressivite</span>
        <span class="n">intelligence</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">intelligence</span>
        <span class="c1"># - seuils :</span>
        <span class="n">midSUR</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;instinct_survie&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
        <span class="n">highSUR</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;instinct_survie&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">)</span>
        <span class="n">midAGG</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;aggressivite&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
        <span class="n">highAGG</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;aggressivite&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">)</span>
        <span class="c1"># - priorités</span>
        <span class="k">if</span> <span class="n">aggressivite</span> <span class="o">&lt;</span> <span class="n">midAGG</span><span class="p">:</span>
            <span class="c1"># robot non aggressif</span>
            <span class="k">if</span> <span class="n">instinct_survie</span> <span class="o">&lt;</span> <span class="n">midSUR</span><span class="p">:</span>
                <span class="n">objectifs</span> <span class="o">=</span> <span class="p">[</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_MOVE</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">instinct_survie</span> <span class="o">&gt;=</span> <span class="n">highSUR</span><span class="p">:</span>
                    <span class="n">objectifs</span> <span class="o">=</span> <span class="p">[</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_DEFENSE</span><span class="p">,</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_MOVE</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">objectifs</span> <span class="o">=</span> <span class="p">[</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_MOVE</span><span class="p">,</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_DEFENSE</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">aggressivite</span> <span class="o">&gt;=</span> <span class="n">highAGG</span><span class="p">:</span>
            <span class="c1"># robot hyper aggressif</span>
            <span class="k">if</span> <span class="n">instinct_survie</span> <span class="o">&lt;</span> <span class="n">midSUR</span><span class="p">:</span>
                <span class="n">objectifs</span> <span class="o">=</span> <span class="p">[</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_ATTACK</span><span class="p">,</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_MOVE</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">instinct_survie</span> <span class="o">&gt;=</span> <span class="n">highSUR</span><span class="p">:</span>
                    <span class="n">objectifs</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_ATTACK</span><span class="p">,</span>
                        <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_DEFENSE</span><span class="p">,</span>
                        <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_MOVE</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">objectifs</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_ATTACK</span><span class="p">,</span>
                        <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_MOVE</span><span class="p">,</span>
                        <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_DEFENSE</span><span class="p">,</span>
                    <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># cas intermédiaire</span>
            <span class="n">cond1</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># - cas particulier des winners</span>
            <span class="k">if</span> <span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_WINNER</span><span class="p">:</span>
                <span class="n">advdict</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_adversaires_avance</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">advdict</span><span class="p">[</span><span class="s2">&quot;adv_in_final&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">advdict</span><span class="p">[</span><span class="s2">&quot;adv_in_approach&quot;</span><span class="p">]:</span>
                    <span class="c1"># des adversaires peuvent gagner !</span>
                    <span class="n">cond1</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># - cas particulier des hunters</span>
            <span class="k">if</span> <span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_HUNTER</span><span class="p">:</span>
                <span class="n">maintarget</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_main_target</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">maintarget</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">maintarget</span><span class="o">.</span><span class="n">case</span> <span class="ow">in</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span>
                    <span class="s2">&quot;attaque&quot;</span>
                <span class="p">):</span>
                    <span class="c1"># Priorité à l&#39;attaque</span>
                    <span class="n">cond1</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># - cas général de priorité à l&#39;attaque</span>
            <span class="n">cond2</span> <span class="o">=</span> <span class="p">(</span><span class="n">aggressivite</span> <span class="o">+</span> <span class="n">ambition</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">intelligence</span> <span class="o">+</span> <span class="n">instinct_survie</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">cond1</span> <span class="ow">or</span> <span class="n">cond2</span><span class="p">:</span>
                <span class="n">objectifs</span> <span class="o">=</span> <span class="p">[</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_ATTACK</span><span class="p">,</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_MOVE</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">instinct_survie</span> <span class="o">&gt;=</span> <span class="n">midSUR</span><span class="p">:</span>
                    <span class="n">objectifs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_DEFENSE</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">instinct_survie</span> <span class="o">&lt;</span> <span class="n">midSUR</span><span class="p">:</span>
                    <span class="n">objectifs</span> <span class="o">=</span> <span class="p">[</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_MOVE</span><span class="p">,</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_ATTACK</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">instinct_survie</span> <span class="o">&gt;=</span> <span class="n">highSUR</span><span class="p">:</span>
                        <span class="n">objectifs</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_DEFENSE</span><span class="p">,</span>
                            <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_MOVE</span><span class="p">,</span>
                            <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_ATTACK</span><span class="p">,</span>
                        <span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">objectifs</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_MOVE</span><span class="p">,</span>
                            <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_DEFENSE</span><span class="p">,</span>
                            <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_ATTACK</span><span class="p">,</span>
                        <span class="p">]</span>
        <span class="c1"># enregistrement</span>
        <span class="n">gsearch</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">gamblesearch</span>
        <span class="n">gsearch</span><span class="o">.</span><span class="n">objectifs</span> <span class="o">=</span> <span class="n">objectifs</span>

    <span class="k">def</span> <span class="nf">_define_scheduled_possibilities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyse les possibilités de mouvement, attaque et défense</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">gsearch</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">gamblesearch</span>
        <span class="c1"># 1- Cas général</span>
        <span class="c1"># - déplacement sécurisé</span>
        <span class="n">safezone</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;safezone&quot;</span><span class="p">)</span>
        <span class="n">gsearch</span><span class="o">.</span><span class="n">safe_move_possible</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">safezone</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="c1"># - action défensive requise</span>
        <span class="n">gsearch</span><span class="o">.</span><span class="n">list_defense</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;defense&quot;</span><span class="p">)</span>
        <span class="n">gsearch</span><span class="o">.</span><span class="n">defense_needed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gsearch</span><span class="o">.</span><span class="n">list_defense</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="c1"># - attaque directe possible :</span>
        <span class="n">listatt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">behavior</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span>
        <span class="k">if</span> <span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_WINNER</span><span class="p">:</span>
            <span class="c1"># cas particulier d&#39;un winner :</span>
            <span class="n">dictadv</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_adversaires_avance</span><span class="p">()</span>
            <span class="n">list1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">list2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">dictadv</span><span class="p">[</span><span class="s2">&quot;adv_in_final&quot;</span><span class="p">]:</span>
                <span class="n">list1</span> <span class="o">=</span> <span class="n">dictadv</span><span class="p">[</span><span class="s2">&quot;final_list&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">dictadv</span><span class="p">[</span><span class="s2">&quot;adv_in_approach&quot;</span><span class="p">]:</span>
                <span class="n">list2</span> <span class="o">=</span> <span class="n">dictadv</span><span class="p">[</span><span class="s2">&quot;approach_list&quot;</span><span class="p">]</span>
            <span class="n">list1</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">list2</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">list1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">listatt</span> <span class="o">=</span> <span class="n">list1</span>
        <span class="k">if</span> <span class="n">listatt</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">listatt</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;attaque&quot;</span><span class="p">)</span>
        <span class="n">gsearch</span><span class="o">.</span><span class="n">list_attaque</span> <span class="o">=</span> <span class="n">listatt</span>
        <span class="n">gsearch</span><span class="o">.</span><span class="n">attaque_possible</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gsearch</span><span class="o">.</span><span class="n">list_attaque</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="c1"># 2- Pour un robot intelligent :</span>
        <span class="n">intelligence</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">intelligence</span>
        <span class="n">highQI</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;intelligence&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">)</span>
        <span class="n">objectifs</span> <span class="o">=</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">objectifs</span>
        <span class="k">if</span> <span class="n">intelligence</span> <span class="o">&gt;=</span> <span class="n">highQI</span><span class="p">:</span>
            <span class="c1"># attaque indirecte ?</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">objectifs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_ATTACK</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">attaque_possible</span>
            <span class="p">):</span>
                <span class="n">att_all</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;attaque_all&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">att_all</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">gsearch</span><span class="o">.</span><span class="n">list_attaque</span> <span class="o">=</span> <span class="n">att_all</span>
                    <span class="n">gsearch</span><span class="o">.</span><span class="n">attaque_possible</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># défense indirecte ?</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">objectifs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_DEFENSE</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">defense_needed</span>
            <span class="p">):</span>
                <span class="n">def_all</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;defense_all&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">def_all</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">gsearch</span><span class="o">.</span><span class="n">list_defense</span> <span class="o">=</span> <span class="n">def_all</span>
                    <span class="n">gsearch</span><span class="o">.</span><span class="n">defense_needed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_analyse_optimal_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyse la possibilité de réaliser des actions optimales</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">finded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">paObj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">relevantfactor</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># paramètres</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">gsearch</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">gamblesearch</span>
        <span class="c1"># 1- analyse des possibilités</span>
        <span class="c1"># 1.1- attaque optimale ?</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">gsearch</span><span class="o">.</span><span class="n">objectifs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_ATTACK</span>
            <span class="ow">and</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">attaque_possible</span>
        <span class="p">):</span>
            <span class="c1"># on recherche une pseudo action offensive pertinente :</span>
            <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_search_scheduled_attaque</span><span class="p">(</span>
                <span class="n">robot</span><span class="p">,</span>
                <span class="n">gsearch</span><span class="o">.</span><span class="n">list_attaque</span><span class="p">,</span>
                <span class="n">searchctx</span><span class="o">=</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">CTX_OPTIMAL</span><span class="p">,</span>
                <span class="n">relevantonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">paObj</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">relevantfactor</span> <span class="o">=</span> <span class="n">paObj</span><span class="o">.</span><span class="n">relevantfactor</span>
            <span class="n">gsearch</span><span class="o">.</span><span class="n">attaque_tried</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># 1.2- mouvement optimal ?</span>
        <span class="k">if</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">safe_move_possible</span> <span class="ow">and</span> <span class="n">relevantfactor</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># - libérer la sortie en phase finale</span>
            <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">game_phasis</span> <span class="o">==</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PHASIS_FINAL</span><span class="p">:</span>
                <span class="c1"># Le chemin vers la sortie est il défini?</span>
                <span class="n">maintarget</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_main_target</span><span class="p">()</span>
                <span class="n">case_sortie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_case_sortie</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">maintarget</span><span class="o">.</span><span class="n">case</span> <span class="o">==</span> <span class="n">case_sortie</span> <span class="ow">and</span> <span class="n">maintarget</span><span class="o">.</span><span class="n">targetpath</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># un ou plusieurs dangers bloquants sont à éliminer</span>
                    <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_scheduled_free_sortie</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
                    <span class="n">gsearch</span><span class="o">.</span><span class="n">free_sortie_tried</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># - suivre le chemin vers la cible :</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">finded</span><span class="p">:</span>
                <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_scheduled_optimal_move</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
                <span class="n">gsearch</span><span class="o">.</span><span class="n">optimal_move_tried</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># - garder la position si elle est sûre :</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">finded</span><span class="p">:</span>
                <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_scheduled_keep_position</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">finded</span><span class="p">:</span>
                <span class="c1"># on enregistre le résultat pour comparaison ultérieure</span>
                <span class="n">paObj</span><span class="o">.</span><span class="n">searchctx</span> <span class="o">=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">CTX_OPTIMAL</span>
                <span class="n">gsearch</span><span class="o">.</span><span class="n">paObjlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">paObj</span><span class="p">)</span>
                <span class="c1"># la PseudoActions est elle pertinente?</span>
                <span class="n">relevantfactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valide_paObj_relevance</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">paObj</span><span class="p">)</span>
        <span class="c1"># 2- décision</span>
        <span class="k">if</span> <span class="n">finded</span> <span class="ow">and</span> <span class="n">relevantfactor</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># l&#39;action n&#39;est pas d&#39;une pertinence optimale</span>
            <span class="c1"># liste des bots / securestop=False</span>
            <span class="n">stoptargets</span> <span class="o">=</span> <span class="n">paObj</span><span class="o">.</span><span class="n">stoptargets</span>
            <span class="k">if</span> <span class="n">stoptargets</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">stoptargets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># trie des dangers identifiés :</span>
                <span class="n">targetsdictlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">stoptargets</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
                    <span class="n">targetsdictlist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="n">b</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="n">d</span><span class="p">})</span>
                <span class="n">targetsdictlist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">))</span>
                <span class="n">defbots</span> <span class="o">=</span> <span class="p">[</span><span class="n">bdict</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">bdict</span> <span class="ow">in</span> <span class="n">targetsdictlist</span><span class="p">]</span>
                <span class="c1"># on passe &quot;defense&quot; en obj prioritaire</span>
                <span class="k">if</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_DEFENSE</span> <span class="ow">in</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">objectifs</span><span class="p">:</span>
                    <span class="n">gsearch</span><span class="o">.</span><span class="n">objectifs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_DEFENSE</span><span class="p">)</span>
                <span class="n">gsearch</span><span class="o">.</span><span class="n">objectifs</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_DEFENSE</span><span class="p">)</span>
                <span class="c1"># on met à jour listdef et defense_needed</span>
                <span class="n">gsearch</span><span class="o">.</span><span class="n">list_defense</span> <span class="o">=</span> <span class="n">defbots</span>
                <span class="n">gsearch</span><span class="o">.</span><span class="n">defense_needed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># on invalide le résultat</span>
            <span class="n">finded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span>

    <span class="k">def</span> <span class="nf">_analyse_actions_by_objectifs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recherche une action suivant la priorité des objectifs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">finded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">paObj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># paramètres</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">gsearch</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">gamblesearch</span>
        <span class="n">aggressivite</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">aggressivite</span>
        <span class="n">midAGG</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;aggressivite&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
        <span class="c1"># analyse</span>
        <span class="k">for</span> <span class="n">objectif</span> <span class="ow">in</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">objectifs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">finded</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">objectif</span> <span class="o">==</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_MOVE</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">safe_move_tried</span>
                    <span class="ow">and</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">safe_move_possible</span>
                <span class="p">):</span>
                    <span class="c1"># safe move?</span>
                    <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_scheduled_safe_move</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
                    <span class="n">gsearch</span><span class="o">.</span><span class="n">safe_move_tried</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">finded</span><span class="p">:</span>
                        <span class="c1"># on mémorise l&#39;action</span>
                        <span class="n">paObj</span><span class="o">.</span><span class="n">searchctx</span> <span class="o">=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">CTX_BY_OBJ</span>
                        <span class="n">gsearch</span><span class="o">.</span><span class="n">paObjlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">paObj</span><span class="p">)</span>
                        <span class="c1"># pertinence :</span>
                        <span class="n">relevantfactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valide_paObj_relevance</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">paObj</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">relevantfactor</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="c1"># on poursuit la recherche</span>
                            <span class="n">finded</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="p">(</span>
                    <span class="n">objectif</span> <span class="o">==</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_DEFENSE</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">defense_tried</span>
                    <span class="ow">and</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">defense_needed</span>
                <span class="p">):</span>
                    <span class="c1"># defense?</span>
                    <span class="c1"># - par attaque</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">finded</span> <span class="ow">and</span> <span class="n">aggressivite</span> <span class="o">&gt;=</span> <span class="n">midAGG</span><span class="p">:</span>
                        <span class="c1"># on recherche une pseudo action offensive pertinente :</span>
                        <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_search_scheduled_attaque</span><span class="p">(</span>
                            <span class="n">robot</span><span class="p">,</span>
                            <span class="n">gsearch</span><span class="o">.</span><span class="n">list_defense</span><span class="p">,</span>
                            <span class="n">searchctx</span><span class="o">=</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">CTX_BY_OBJ</span><span class="p">,</span>
                            <span class="n">relevantonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="c1"># - par safe move</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="ow">not</span> <span class="n">finded</span>
                        <span class="ow">and</span> <span class="ow">not</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">safe_move_tried</span>
                        <span class="ow">and</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">safe_move_possible</span>
                    <span class="p">):</span>
                        <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_scheduled_safe_move</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
                        <span class="n">gsearch</span><span class="o">.</span><span class="n">safe_move_tried</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">finded</span><span class="p">:</span>
                            <span class="c1"># on mémorise l&#39;action</span>
                            <span class="n">paObj</span><span class="o">.</span><span class="n">searchctx</span> <span class="o">=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">CTX_BY_OBJ</span>
                            <span class="n">gsearch</span><span class="o">.</span><span class="n">paObjlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">paObj</span><span class="p">)</span>
                            <span class="c1"># pertinence :</span>
                            <span class="n">relevantfactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valide_paObj_relevance</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">paObj</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">relevantfactor</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="c1"># on poursuit la recherche</span>
                                <span class="n">finded</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="c1"># solutions de défense traitées</span>
                    <span class="n">gsearch</span><span class="o">.</span><span class="n">defense_tried</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="p">(</span>
                    <span class="n">objectif</span> <span class="o">==</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_ATTACK</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">attaque_tried</span>
                    <span class="ow">and</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">attaque_possible</span>
                <span class="p">):</span>
                    <span class="c1"># attaque?</span>
                    <span class="c1"># on recherche une pseudo action offensive pertinente :</span>
                    <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_search_scheduled_attaque</span><span class="p">(</span>
                        <span class="n">robot</span><span class="p">,</span>
                        <span class="n">gsearch</span><span class="o">.</span><span class="n">list_attaque</span><span class="p">,</span>
                        <span class="n">searchctx</span><span class="o">=</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">CTX_BY_OBJ</span><span class="p">,</span>
                        <span class="n">relevantonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">gsearch</span><span class="o">.</span><span class="n">attaque_tried</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span>

    <span class="k">def</span> <span class="nf">_analyse_desperate_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sélectionne une action désespérée</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">finded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">paObj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># paramètres</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">gsearch</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">gamblesearch</span>
        <span class="c1"># analyse</span>
        <span class="n">listact</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dangers&quot;</span><span class="p">,</span> <span class="s2">&quot;risk&quot;</span><span class="p">,</span> <span class="s2">&quot;escape&quot;</span><span class="p">]</span>
        <span class="c1"># cr.CustomRandom.shuffle(listact)</span>
        <span class="k">for</span> <span class="n">act</span> <span class="ow">in</span> <span class="n">listact</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">act</span> <span class="o">==</span> <span class="s2">&quot;dangers&quot;</span><span class="p">:</span>
                <span class="c1"># - rebattre les cartes en explosant des mines</span>
                <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_scheduled_dangers</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">act</span> <span class="o">==</span> <span class="s2">&quot;risk&quot;</span><span class="p">:</span>
                <span class="c1"># - tenter un déplacement risqué</span>
                <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_scheduled_risked_move</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">act</span> <span class="o">==</span> <span class="s2">&quot;escape&quot;</span><span class="p">:</span>
                <span class="c1"># - fuite désespérée</span>
                <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_scheduled_desperate_escape</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">finded</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">finded</span><span class="p">:</span>
            <span class="c1"># infos minimales (arrêt sécurisé?)</span>
            <span class="n">paObj</span><span class="o">.</span><span class="n">searchctx</span> <span class="o">=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">CTX_DESPERATE</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_complete_paObj_with_secure_infos</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">paObj</span><span class="p">)</span>
            <span class="n">gsearch</span><span class="o">.</span><span class="n">paObjlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">paObj</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_valide_paObj_relevance</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">paObj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span>

    <span class="c1">#-----&gt; B.7.3- Méthodes de recherche thématiques</span>
    <span class="k">def</span> <span class="nf">_search_scheduled_optimal_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyse le parcours du targetpath associé à TempTarget (si définie), ou</span>
<span class="sd">        MainTarget.</span>
<span class="sd">        Retourne un objet PseudoActions si la cible et le chemin existent, ou</span>
<span class="sd">        None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">finded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">paObj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">gsearch</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">gamblesearch</span>
        <span class="n">maxactions</span> <span class="o">=</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">maxactions</span>
        <span class="c1"># 1- Sélection d&#39;un nombre de cases égal au nombre de coups à jouer</span>
        <span class="c1"># dans le chemin vers la cible, ou les cases suivantes :</span>
        <span class="n">listcases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_optimal_listcases_for_move</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">listcases</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># 2- Analyse du nombre de coups nécessaires et des besoins de</span>
            <span class="c1"># terraformage :</span>
            <span class="n">listdictcases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">delcases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">extendedunsafezone</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;extendedunsafezone&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">listcases</span><span class="p">:</span>
                <span class="n">nbg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_case_pathcost_for_robot</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nbg</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># robot inattaquable</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">nbg</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">delcases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="n">safe</span> <span class="o">=</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extendedunsafezone</span>
                    <span class="n">tc</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">type_case</span>
                    <span class="n">cdict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span>
                        <span class="s2">&quot;tc&quot;</span><span class="p">:</span> <span class="n">tc</span><span class="p">,</span>
                        <span class="s2">&quot;nbg&quot;</span><span class="p">:</span> <span class="n">nbg</span><span class="p">,</span>
                        <span class="s2">&quot;safe&quot;</span><span class="p">:</span> <span class="n">safe</span><span class="p">,</span>
                        <span class="s2">&quot;terraformed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">listdictcases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cdict</span><span class="p">)</span>
            <span class="c1"># besoin de terraformer?</span>
            <span class="n">needterraform</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">terrares</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">delcases</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">needterraform</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_params_for_grenade_and_listcases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">delcases</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">params</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">exist</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;finded&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">exist</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;bestfirst&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">terrares</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;bestfirst&quot;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">terrares</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;bestres&quot;</span><span class="p">]</span>
            <span class="c1"># 3- Réduction de la liste</span>
            <span class="c1"># rq : supprimer des dangers peut en faire apparaitre d&#39;autres</span>
            <span class="n">totalnbg</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">isexact</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">needterraform</span>
            <span class="n">finaldictlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">isexact</span><span class="p">:</span>
                <span class="n">finaldictlist</span> <span class="o">=</span> <span class="n">listdictcases</span>
                <span class="n">totalnbg</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">finaldictlist</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">terrares</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># pas de solution de terraformage initiale, on s&#39;appuye sur</span>
                    <span class="c1"># les nombres de coups théoriques</span>
                    <span class="k">for</span> <span class="n">cdict</span> <span class="ow">in</span> <span class="n">listdictcases</span><span class="p">:</span>
                        <span class="n">c</span> <span class="o">=</span> <span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span>
                        <span class="n">nbg</span> <span class="o">=</span> <span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;nbg&quot;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">totalnbg</span> <span class="o">+</span> <span class="n">nbg</span> <span class="o">&lt;=</span> <span class="n">maxactions</span><span class="p">:</span>
                            <span class="n">totalnbg</span> <span class="o">+=</span> <span class="n">nbg</span>
                            <span class="n">finaldictlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cdict</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># terraformage au premier coup : on optimise le nombre de</span>
                    <span class="c1"># coups prévus (mais pas forcément exact)</span>
                    <span class="n">terraset</span> <span class="o">=</span> <span class="n">terrares</span><span class="p">[</span><span class="s2">&quot;setmatch&quot;</span><span class="p">]</span>
                    <span class="n">totalnbg</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">for</span> <span class="n">cdict</span> <span class="ow">in</span> <span class="n">listdictcases</span><span class="p">:</span>
                        <span class="n">c</span> <span class="o">=</span> <span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span>
                        <span class="n">nbg</span> <span class="o">=</span> <span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;nbg&quot;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">terraset</span><span class="p">:</span>
                            <span class="c1"># hypothèse favorable : un danger n&#39;apparaitra pas</span>
                            <span class="n">nbg</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;terraformed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">totalnbg</span> <span class="o">+</span> <span class="n">nbg</span> <span class="o">&lt;=</span> <span class="n">maxactions</span><span class="p">:</span>
                            <span class="n">totalnbg</span> <span class="o">+=</span> <span class="n">nbg</span>
                            <span class="n">finaldictlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cdict</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">break</span>
            <span class="c1"># élimination des cases non sûres en fin de liste :</span>
            <span class="n">reddictlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">finaldictlist</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="n">hassafe</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">cdict</span> <span class="ow">in</span> <span class="n">finaldictlist</span><span class="p">:</span>
                <span class="n">safe</span> <span class="o">=</span> <span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;safe&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">safe</span><span class="p">:</span>
                    <span class="n">hassafe</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">hassafe</span><span class="p">:</span>
                    <span class="n">reddictlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cdict</span><span class="p">)</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># mise à jour du nombre de coups estimés</span>
                    <span class="k">if</span> <span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;terraformed&quot;</span><span class="p">]:</span>
                        <span class="n">totalnbg</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">totalnbg</span> <span class="o">-=</span> <span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;nbg&quot;</span><span class="p">]</span>
            <span class="n">reddictlist</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="c1"># 4- Création de l&#39;objet pseudo actions :</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reddictlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">finded</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">palist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="n">killedbots</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># terraformage initial</span>
                <span class="k">if</span> <span class="n">terrares</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">comb</span> <span class="o">=</span> <span class="n">terrares</span><span class="p">[</span><span class="s2">&quot;combinaison&quot;</span><span class="p">]</span>
                    <span class="n">terraset</span> <span class="o">=</span> <span class="n">terrares</span><span class="p">[</span><span class="s2">&quot;setmatch&quot;</span><span class="p">]</span>
                    <span class="n">killedbots</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">terraset</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alive_bots</span><span class="p">]</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cmd_from_grenade_combinaison</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">comb</span><span class="p">)</span>
                    <span class="n">terrapa</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;grenade&quot;</span><span class="p">,</span> <span class="s2">&quot;cmd&quot;</span><span class="p">:</span> <span class="n">cmd</span><span class="p">}</span>
                    <span class="n">palist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">terrapa</span><span class="p">)</span>
                <span class="c1"># déplacement :</span>
                <span class="k">for</span> <span class="n">cdict</span> <span class="ow">in</span> <span class="n">reddictlist</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span>
                    <span class="n">mpa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_move_pseudoaction_for_case</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="n">palist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mpa</span><span class="p">)</span>
                <span class="c1"># objet PseudoActions :</span>
                <span class="n">paObj</span> <span class="o">=</span> <span class="n">PseudoActions</span><span class="p">(</span><span class="n">palist</span><span class="p">,</span> <span class="n">totalnbg</span><span class="p">)</span>
                <span class="n">paObj</span><span class="o">.</span><span class="n">killedbots</span> <span class="o">=</span> <span class="n">killedbots</span>
                <span class="n">paObj</span><span class="o">.</span><span class="n">exactpath</span> <span class="o">=</span> <span class="n">isexact</span>
                <span class="n">paObj</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PA_OPTIMAL_MOVE</span>
                <span class="c1"># infos minimales (arrêt sécurisé?)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_complete_paObj_with_secure_infos</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">paObj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span>

    <span class="k">def</span> <span class="nf">_search_scheduled_free_sortie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recherche une série de coups permettant de libérer la sortie de</span>
<span class="sd">        dangers empéchant la recherche d&#39;un chemin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">finded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">paObj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># liste des dgrs triés par dist croissante à la sortie</span>
        <span class="n">case_sortie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_case_sortie</span><span class="p">()</span>
        <span class="c1"># les dangers identifiés lors de la recherche de chemin</span>
        <span class="n">blockingdgr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_TargetPath</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">case_sortie</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blockingdgr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># tous les dangers environnants la sortie</span>
            <span class="n">blockingdgr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_dangers_block_sortie</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blockingdgr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dgr</span> <span class="ow">in</span> <span class="n">blockingdgr</span><span class="p">:</span>
                <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_scheduled_attaque</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">targetcase</span><span class="o">=</span><span class="n">dgr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">finded</span><span class="p">:</span>
                    <span class="n">paObj</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PA_FREE_EXIT</span>
                    <span class="c1"># infos minimales (arrêt sécurisé?)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_complete_paObj_with_secure_infos</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">paObj</span><span class="p">)</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span>

    <span class="k">def</span> <span class="nf">_search_scheduled_keep_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recherche si la position actuelle est sûre.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">finded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">paObj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># évite des actions no move infinies :</span>
        <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">no_move_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span>
        <span class="c1"># la position actuelle du robot est-elle sûre?</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">gsearch</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">gamblesearch</span>
        <span class="n">maxactions</span> <span class="o">=</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">maxactions</span>
        <span class="n">safezone</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;safezone&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">robot</span> <span class="ow">in</span> <span class="n">safezone</span><span class="p">:</span>
            <span class="n">palist</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;nomove&quot;</span><span class="p">}]</span>
            <span class="n">paObj</span> <span class="o">=</span> <span class="n">PseudoActions</span><span class="p">(</span><span class="n">palist</span><span class="p">,</span> <span class="n">maxactions</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_complete_paObj_with_secure_infos</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">paObj</span><span class="p">)</span>
            <span class="n">paObj</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PA_STAY_IN_PLACE</span>
            <span class="n">finded</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span>

    <span class="k">def</span> <span class="nf">_search_scheduled_safe_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">wait_at_end</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recherche d&#39;un parcours menant à une case comprise dans la safe zone, si</span>
<span class="sd">        possible dans la direction de TempTarget ou MainTarget.</span>
<span class="sd">        wait_at_end : complète au besoin la liste de pseudos actions avec</span>
<span class="sd">        des actions nomove</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="c1"># liste des cases sûres</span>
        <span class="c1"># - hors portée de mine ou attaque directe</span>
        <span class="n">realsafezone</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;realsafezone&quot;</span><span class="p">)</span>
        <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_scheduled_move_in_list</span><span class="p">(</span>
            <span class="n">robot</span><span class="p">,</span> <span class="n">realsafezone</span><span class="p">,</span> <span class="n">wait_at_end</span><span class="o">=</span><span class="n">wait_at_end</span>
        <span class="p">)</span>
        <span class="c1"># - hors attaque directe</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">finded</span><span class="p">:</span>
            <span class="n">safezone</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;safezone&quot;</span><span class="p">)</span>
            <span class="n">redsafe</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">safezone</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">realsafezone</span><span class="p">]</span>
            <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_scheduled_move_in_list</span><span class="p">(</span>
                <span class="n">robot</span><span class="p">,</span> <span class="n">redsafe</span><span class="p">,</span> <span class="n">wait_at_end</span><span class="o">=</span><span class="n">wait_at_end</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">finded</span><span class="p">:</span>
            <span class="c1"># infos minimales (arrêt sécurisé?)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_complete_paObj_with_secure_infos</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">paObj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">finded</span><span class="p">:</span>
            <span class="n">paObj</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PA_SAFE_MOVE</span>
        <span class="k">return</span> <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span>

    <span class="k">def</span> <span class="nf">_search_scheduled_risked_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">risklevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">wait_at_end</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recherche d&#39;un parcours risqué si possible dans la direction de</span>
<span class="sd">        TempTarget ou MainTarget.</span>
<span class="sd">        </span>
<span class="sd">        * risklevel : entier décrivant le niveau de risque accepté</span>
<span class="sd">        </span>
<span class="sd">          * 1 : cases de move_zone telles que la proba max</span>
<span class="sd">            d&#39;attaque soit inférieure à 55%</span>
<span class="sd">          * autres : toute case de proba minimale</span>
<span class="sd">            </span>
<span class="sd">        * wait_at_end : complète au besoin la liste de pseudos actions avec</span>
<span class="sd">          des actions nomove</span>
<span class="sd">        </span>
<span class="sd">        Rq : méthode &quot;désespérée&quot;, faisant appel à des pseudos probas sous</span>
<span class="sd">        évaluées</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1- Probabilités d&#39;attaque par case de move_zone :</span>
        <span class="n">listprob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_attack_probas_for_move_zone</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="c1"># proba max en fonction du niveau de risque</span>
        <span class="n">pmax</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">risklevel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pmax</span> <span class="o">=</span> <span class="mf">0.55</span>
        <span class="c1"># sélection des cases</span>
        <span class="n">clist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cdict</span> <span class="ow">in</span> <span class="n">listprob</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;proba&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">pmax</span><span class="p">:</span>
                <span class="n">clist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="c1"># 2- Recherche de chemin</span>
        <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_scheduled_move_in_list</span><span class="p">(</span>
            <span class="n">robot</span><span class="p">,</span> <span class="n">clist</span><span class="p">,</span> <span class="n">wait_at_end</span><span class="o">=</span><span class="n">wait_at_end</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">finded</span><span class="p">:</span>
            <span class="n">paObj</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PA_RISKED_MOVE</span>
            <span class="c1"># infos minimales (arrêt sécurisé?)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_complete_paObj_with_secure_infos</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">paObj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span>

    <span class="k">def</span> <span class="nf">_search_scheduled_move_in_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">listcases</span><span class="p">,</span> <span class="n">wait_at_end</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recherche d&#39;un parcours menant à une case comprise dans listcases, si</span>
<span class="sd">        possible dans la direction de TempTarget ou MainTarget.</span>
<span class="sd">        wait_at_end : complète au besoin la liste de pseudos actions avec</span>
<span class="sd">        des actions nomove</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">gsearch</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">gamblesearch</span>
        <span class="n">maxactions</span> <span class="o">=</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">maxactions</span>
        <span class="n">finded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">paObj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">listcases</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># liste de dicts {&quot;case&quot;:, &quot;dist&quot;:, &quot;bonus&quot;:,  &quot;inpath&quot;:, &quot;indirect&quot;:}</span>
            <span class="c1"># distantes de maxactions au max</span>
            <span class="n">predictlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preselect_cases_for_safe_move</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">listcases</span><span class="p">)</span>
            <span class="c1"># choix de la meilleure liste de recherche :</span>
            <span class="n">searchdictlist</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">pathdictlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">cdict</span> <span class="k">for</span> <span class="n">cdict</span> <span class="ow">in</span> <span class="n">predictlist</span> <span class="k">if</span> <span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;inpath&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pathdictlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># rester dans le path</span>
                <span class="n">searchdictlist</span> <span class="o">=</span> <span class="n">pathdictlist</span>
            <span class="k">if</span> <span class="n">searchdictlist</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dirdictlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">cdict</span> <span class="k">for</span> <span class="n">cdict</span> <span class="ow">in</span> <span class="n">predictlist</span> <span class="k">if</span> <span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;indirect&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dirdictlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># rester dans les directions de la cible principale</span>
                    <span class="n">searchdictlist</span> <span class="o">=</span> <span class="n">dirdictlist</span>
            <span class="k">if</span> <span class="n">searchdictlist</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># par défaut la liste entière</span>
                <span class="n">searchdictlist</span> <span class="o">=</span> <span class="n">predictlist</span>
            <span class="c1"># trie :</span>
            <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">need_bonus</span><span class="p">:</span>
                <span class="n">searchdictlist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;bonus&quot;</span><span class="p">,</span> <span class="s2">&quot;dist&quot;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">searchdictlist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;dist&quot;</span><span class="p">,</span> <span class="s2">&quot;bonus&quot;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># évaluations :</span>
            <span class="k">for</span> <span class="n">searchdict</span> <span class="ow">in</span> <span class="n">searchdictlist</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">searchdict</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span>
                <span class="n">tp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_TargetPath</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">c</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">tp</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># un chemin existe, est il assez court?</span>
                    <span class="n">nbgamble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_gamble_count_for_TargetPath</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">tp</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">nbgamble</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nbgamble</span> <span class="o">&lt;=</span> <span class="n">maxactions</span><span class="p">:</span>
                        <span class="c1"># parcours trouvé :</span>
                        <span class="n">pseudoactionlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pseudoactionlist_for_TargetPath</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">wait_at_end</span> <span class="ow">and</span> <span class="n">nbgamble</span> <span class="o">&lt;</span> <span class="n">maxactions</span><span class="p">:</span>
                            <span class="c1"># pseudo action sans mouvement jusqu&#39;à la fin</span>
                            <span class="c1"># du tour (non dénombrée, nbgamble n&#39;étant pas</span>
                            <span class="c1"># forcément exact)</span>
                            <span class="n">pseudoaction</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;nomove&quot;</span><span class="p">}</span>
                            <span class="n">pseudoactionlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pseudoaction</span><span class="p">)</span>
                            <span class="n">nbgamble</span> <span class="o">=</span> <span class="n">maxactions</span>
                        <span class="c1"># Objet PseudoActions</span>
                        <span class="n">paObj</span> <span class="o">=</span> <span class="n">PseudoActions</span><span class="p">(</span><span class="n">pseudoactionlist</span><span class="p">,</span> <span class="n">nbgamble</span><span class="p">)</span>
                        <span class="n">finded</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
        <span class="c1"># retour :</span>
        <span class="k">return</span> <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span>

    <span class="k">def</span> <span class="nf">_batch_search_scheduled_attaque</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">botslist</span><span class="p">,</span> <span class="n">searchctx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">relevantonly</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recherche dans la liste une combinaison de coups offensifs.</span>
<span class="sd">        </span>
<span class="sd">        * botslist : liste de robots à attaquer</span>
<span class="sd">        * searchctx : contexte de recherche</span>
<span class="sd">        * relevantonly (bool) : si True poursuit la recherche jusqu&#39;à trouver</span>
<span class="sd">          une pseudo action pertinente (relevantfactor=2).</span>
<span class="sd">          </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">gsearch</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">gamblesearch</span>
        <span class="n">finded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">paObj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># on exclut les robots déja traités</span>
        <span class="n">filterdef</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">botslist</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">kill_search_already_done</span><span class="p">(</span><span class="n">b</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">filterdef</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
            <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_scheduled_attaque</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">targetcase</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">finded</span><span class="p">:</span>
                <span class="c1"># on mémorise l&#39;action</span>
                <span class="n">paObj</span><span class="o">.</span><span class="n">searchctx</span> <span class="o">=</span> <span class="n">searchctx</span>
                <span class="n">gsearch</span><span class="o">.</span><span class="n">paObjlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">paObj</span><span class="p">)</span>
                <span class="c1"># pertinence :</span>
                <span class="n">relevantfactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valide_paObj_relevance</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">paObj</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">relevantfactor</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">relevantonly</span><span class="p">:</span>
                    <span class="c1"># on poursuit la recherche</span>
                    <span class="n">finded</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">paObj</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span>

    <span class="k">def</span> <span class="nf">_search_scheduled_attaque</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">targetcase</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pathsearch</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recherche d&#39;une série de coups offensifs</span>
<span class="sd">        Retourne un boolean indiquant si une solution a été trouvée et une liste</span>
<span class="sd">        de pseudos actions ou None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">gsearch</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">gamblesearch</span>
        <span class="n">maxactions</span> <span class="o">=</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">maxactions</span>
        <span class="n">finded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">paObj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># cible de l&#39;attaque</span>
        <span class="n">attcase</span> <span class="o">=</span> <span class="n">targetcase</span>
        <span class="k">if</span> <span class="n">attcase</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">listatt</span> <span class="o">=</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">list_attaque</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">listatt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">attcase</span> <span class="o">=</span> <span class="n">listatt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">attcase</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span>
        <span class="c1"># liste des bots éliminés :</span>
        <span class="n">killedbots</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># 1- Attaque directe</span>
        <span class="n">directcmd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">typeaction</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">has_grenade</span><span class="p">:</span>
            <span class="n">recursive</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">highQI</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;intelligence&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">intelligence</span> <span class="o">&gt;=</span> <span class="n">highQI</span><span class="p">:</span>
                <span class="n">recursive</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">typeaction</span> <span class="o">=</span> <span class="s2">&quot;grenade&quot;</span>
            <span class="n">directcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_complex_action</span><span class="p">(</span>
                <span class="n">robot</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_GRENADE</span><span class="p">,</span> <span class="n">attcase</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">attcase</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="n">attcase</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_ROBOT</span>
        <span class="p">):</span>
            <span class="n">typeaction</span> <span class="o">=</span> <span class="s2">&quot;kill&quot;</span>
            <span class="n">actdict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_KILL</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_KILL</span><span class="p">}</span>
            <span class="n">directcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_simple_action</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">actdict</span><span class="p">,</span> <span class="n">attcase</span><span class="p">)</span>
        <span class="n">directcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">directcmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">directcmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pseudoaction</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">typeaction</span><span class="p">,</span> <span class="s2">&quot;cmd&quot;</span><span class="p">:</span> <span class="n">directcmd</span><span class="p">}</span>
            <span class="n">pseudoactionlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">pseudoaction</span><span class="p">]</span>
            <span class="c1"># bots impactés :</span>
            <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">has_grenade</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_params_for_grenade</span><span class="p">(</span>
                    <span class="n">robot</span><span class="p">,</span> <span class="n">attcase</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span>
                <span class="p">)</span>
                <span class="n">defcomb</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
                <span class="n">cases_impactees</span> <span class="o">=</span> <span class="n">defcomb</span><span class="p">[</span><span class="s2">&quot;cases_impactees&quot;</span><span class="p">]</span>
                <span class="n">killedbots</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cases_impactees</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alive_bots</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">attcase</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_ROBOT</span><span class="p">:</span>
                <span class="n">killedbots</span> <span class="o">=</span> <span class="p">[</span><span class="n">attcase</span><span class="p">]</span>
            <span class="c1"># Objet PseudoActions</span>
            <span class="n">paObj</span> <span class="o">=</span> <span class="n">PseudoActions</span><span class="p">(</span><span class="n">pseudoactionlist</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">paObj</span><span class="o">.</span><span class="n">killedbots</span> <span class="o">=</span> <span class="n">killedbots</span>
            <span class="n">finded</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># 2- Mouvement puis attaque</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">finded</span> <span class="ow">and</span> <span class="n">pathsearch</span><span class="p">:</span>
            <span class="n">move_zone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_caseset_for_coordset</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">move_zone</span><span class="p">)</span>
            <span class="n">dlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="c1"># mémorisation coords robot</span>
            <span class="n">refx</span><span class="p">,</span> <span class="n">refy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="c1"># cas particulier ou cas général ?</span>
            <span class="n">test_dgr</span> <span class="o">=</span> <span class="n">attcase</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_DANGER</span>
            <span class="n">cond_back</span> <span class="o">=</span> <span class="n">test_dgr</span> <span class="ow">and</span> <span class="n">attcase</span><span class="o">.</span><span class="n">get_danger_radius</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span>
                <span class="n">robot</span><span class="p">,</span> <span class="n">attcase</span>
            <span class="p">)</span>
            <span class="c1"># 2.1- Cas général</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cond_back</span><span class="p">:</span>
                <span class="c1"># attcase n&#39;est pas un danger ou la distance robot-attcase est</span>
                <span class="c1"># supérieure au rayon d&#39;action du danger, on avance.</span>
                <span class="c1"># - distance limite pour la sélection de cases</span>
                <span class="n">dra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_path_length_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">attcase</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">robot</span><span class="o">.</span><span class="n">has_grenade</span><span class="p">:</span>
                    <span class="n">dlimit</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dlimit</span> <span class="o">=</span> <span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">get_danger_radius</span><span class="p">()</span> <span class="o">-</span> <span class="n">robot</span><span class="o">.</span><span class="n">vitesse</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.5</span>
                <span class="c1"># - cases accessibles en direction de la cible</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">move_zone</span><span class="p">:</span>
                    <span class="n">dr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_path_length_between_cases</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
                    <span class="c1"># on garde une action offensive</span>
                    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">maxactions</span><span class="p">:</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_path_length_between_cases</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">attcase</span><span class="p">)</span>
                        <span class="c1"># on se limite :</span>
                        <span class="c1"># - aux cases dirigées vers la cible : d &lt; dra</span>
                        <span class="c1"># - telles que dist case / attcase &lt;= 1 sans grenade</span>
                        <span class="c1"># - ou dist case / attcase &lt;= dlimit si grenade</span>
                        <span class="c1">#   pour limiter les calculs récurifs</span>
                        <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dra</span><span class="p">,</span> <span class="n">dlimit</span><span class="p">):</span>
                            <span class="n">vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_vector_for_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                            <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_case_cost</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                            <span class="n">dlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">{</span>
                                    <span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span>
                                    <span class="s2">&quot;dist&quot;</span><span class="p">:</span> <span class="n">d</span><span class="p">,</span>
                                    <span class="s2">&quot;disr_robot&quot;</span><span class="p">:</span> <span class="n">dr</span><span class="p">,</span>
                                    <span class="s2">&quot;vx&quot;</span><span class="p">:</span> <span class="n">vector</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="s2">&quot;vy&quot;</span><span class="p">:</span> <span class="n">vector</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                    <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">cost</span><span class="p">,</span>
                                <span class="p">}</span>
                            <span class="p">)</span>
            <span class="c1"># 2.2- Cas particulier</span>
            <span class="k">elif</span> <span class="n">robot</span><span class="o">.</span><span class="n">has_grenade</span><span class="p">:</span>
                <span class="c1"># attcase est un danger trop proche du robot, il faut reculer.</span>
                <span class="c1"># rq : nécessite un lancer de grenade.</span>
                <span class="n">dmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">attcase</span><span class="p">)</span>
                <span class="n">dlimit</span> <span class="o">=</span> <span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">get_danger_radius</span><span class="p">()</span> <span class="o">-</span> <span class="n">robot</span><span class="o">.</span><span class="n">vitesse</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.5</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">move_zone</span><span class="p">:</span>
                    <span class="n">dr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_path_length_between_cases</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
                    <span class="c1"># on garde une action offensive</span>
                    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">maxactions</span><span class="p">:</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">attcase</span><span class="p">)</span>
                        <span class="c1"># on se limite aux cases qui éloignent le robot de la</span>
                        <span class="c1"># cible tout en restant dans dlimit</span>
                        <span class="k">if</span> <span class="n">dmin</span> <span class="o">&lt;</span> <span class="n">d</span> <span class="o">&lt;=</span> <span class="n">dlimit</span><span class="p">:</span>
                            <span class="n">vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_vector_for_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                            <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_case_cost</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                            <span class="n">dlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">{</span>
                                    <span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span>
                                    <span class="s2">&quot;dist&quot;</span><span class="p">:</span> <span class="n">d</span><span class="p">,</span>
                                    <span class="s2">&quot;disr_robot&quot;</span><span class="p">:</span> <span class="n">dr</span><span class="p">,</span>
                                    <span class="s2">&quot;vx&quot;</span><span class="p">:</span> <span class="n">vector</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="s2">&quot;vy&quot;</span><span class="p">:</span> <span class="n">vector</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                    <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">cost</span><span class="p">,</span>
                                <span class="p">}</span>
                            <span class="p">)</span>
            <span class="c1"># - tentative de réduction de la liste de recherche...</span>
            <span class="n">searchlist1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">searchlist2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="c1"># ... à partir d&#39;un certain nombre d&#39;options</span>
                <span class="n">xlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">cd</span> <span class="k">for</span> <span class="n">cd</span> <span class="ow">in</span> <span class="n">dlist</span> <span class="k">if</span> <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;vy&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">ylist</span> <span class="o">=</span> <span class="p">[</span><span class="n">cd</span> <span class="k">for</span> <span class="n">cd</span> <span class="ow">in</span> <span class="n">dlist</span> <span class="k">if</span> <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;vx&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">rlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">cd</span> <span class="k">for</span> <span class="n">cd</span> <span class="ow">in</span> <span class="n">dlist</span> <span class="k">if</span> <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;vx&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;vy&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
                <span class="c1"># en fonction du vecteur robot -&gt; cible</span>
                <span class="n">vectra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_vector_for_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">attcase</span><span class="p">)</span>
                <span class="n">cond_hori</span> <span class="o">=</span> <span class="n">vectra</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span>
                    <span class="n">vectra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">vectra</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">vectra</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.16</span>
                <span class="p">)</span>
                <span class="n">cond_vert</span> <span class="o">=</span> <span class="n">vectra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">vectra</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">vectra</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">6</span>
                <span class="n">cond_oblique</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">cond_hori</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cond_vert</span>
                <span class="k">if</span> <span class="n">cond_oblique</span><span class="p">:</span>
                    <span class="c1"># vecteur oblique (pas de réduction évidente)</span>
                    <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">vectra</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">vectra</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="c1"># on privilégie y</span>
                        <span class="n">searchlist1</span> <span class="o">=</span> <span class="n">ylist</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># sinon x</span>
                        <span class="n">searchlist1</span> <span class="o">=</span> <span class="n">xlist</span>
                    <span class="c1"># on complète avec les autres éléments de dlist</span>
                    <span class="n">searchlist2</span> <span class="o">=</span> <span class="p">[</span><span class="n">cd</span> <span class="k">for</span> <span class="n">cd</span> <span class="ow">in</span> <span class="n">dlist</span> <span class="k">if</span> <span class="n">cd</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">searchlist1</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">cond_hori</span><span class="p">:</span>
                    <span class="c1"># vecteur horizontal (réduction)</span>
                    <span class="n">searchlist1</span> <span class="o">=</span> <span class="n">xlist</span>
                    <span class="n">searchlist2</span> <span class="o">=</span> <span class="p">[</span><span class="n">cd</span> <span class="k">for</span> <span class="n">cd</span> <span class="ow">in</span> <span class="n">rlist</span> <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">cd</span><span class="p">[</span><span class="s2">&quot;vy&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">cond_vert</span><span class="p">:</span>
                    <span class="c1"># vecteur vertical (réduction)</span>
                    <span class="n">searchlist1</span> <span class="o">=</span> <span class="n">ylist</span>
                    <span class="n">searchlist2</span> <span class="o">=</span> <span class="p">[</span><span class="n">cd</span> <span class="k">for</span> <span class="n">cd</span> <span class="ow">in</span> <span class="n">rlist</span> <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">cd</span><span class="p">[</span><span class="s2">&quot;vx&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">searchlist1</span> <span class="o">=</span> <span class="n">dlist</span>
            <span class="c1"># - tries :</span>
            <span class="n">searchlist1</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;disr_robot&quot;</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">))</span>
            <span class="n">searchlist2</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;disr_robot&quot;</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">))</span>
            <span class="c1"># concaténation</span>
            <span class="n">finalsearchlist</span> <span class="o">=</span> <span class="n">searchlist1</span>
            <span class="n">finalsearchlist</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">searchlist2</span><span class="p">)</span>
            <span class="c1"># limitation des recherches :</span>
            <span class="n">nbmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">finalsearchlist</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mi">15</span> <span class="o">*</span> <span class="n">robot</span><span class="o">.</span><span class="n">intelligence</span><span class="p">))</span>
            <span class="n">finalsearchlist</span> <span class="o">=</span> <span class="n">finalsearchlist</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nbmax</span><span class="p">]</span>
            <span class="c1"># - recherche d&#39;une case permettant d&#39;attaquer :</span>
            <span class="n">finalTargetPath</span> <span class="o">=</span> <span class="n">attaquepa</span> <span class="o">=</span> <span class="n">nbgamble</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">cdict</span> <span class="ow">in</span> <span class="n">finalsearchlist</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span>
                <span class="c1"># rétablissement des coordonnées</span>
                <span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">refx</span><span class="p">,</span> <span class="n">refy</span>
                <span class="c1"># position de tir satisfaisante?</span>
                <span class="p">(</span>
                    <span class="n">finded</span><span class="p">,</span>
                    <span class="n">finalTargetPath</span><span class="p">,</span>
                    <span class="n">attaquepa</span><span class="p">,</span>
                    <span class="n">killedbots</span><span class="p">,</span>
                    <span class="n">nbgamble</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_scheduled_shoot_position</span><span class="p">(</span>
                    <span class="n">robot</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">attcase</span><span class="p">,</span> <span class="n">maxactions</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">finded</span><span class="p">:</span>
                    <span class="c1"># on a trouvé une solution</span>
                    <span class="k">break</span>
            <span class="c1"># rétablissement des coordonnées</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">refx</span><span class="p">,</span> <span class="n">refy</span>
            <span class="c1"># Création de la liste finale de pseudos actions :</span>
            <span class="k">if</span> <span class="n">finded</span><span class="p">:</span>
                <span class="n">pseudoactionlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pseudoactionlist_for_TargetPath</span><span class="p">(</span>
                    <span class="n">finalTargetPath</span>
                <span class="p">)</span>
                <span class="n">pseudoactionlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attaquepa</span><span class="p">)</span>
                <span class="c1"># Objet PseudoActions</span>
                <span class="n">paObj</span> <span class="o">=</span> <span class="n">PseudoActions</span><span class="p">(</span><span class="n">pseudoactionlist</span><span class="p">,</span> <span class="n">nbgamble</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">paObj</span><span class="o">.</span><span class="n">killedbots</span> <span class="o">=</span> <span class="n">killedbots</span>
        <span class="c1"># mémorisation de la recherche offensive</span>
        <span class="k">if</span> <span class="n">attcase</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_ROBOT</span><span class="p">:</span>
            <span class="n">gsearch</span><span class="o">.</span><span class="n">register_kill_search</span><span class="p">(</span><span class="n">attcase</span><span class="p">)</span>
        <span class="c1"># retour :</span>
        <span class="k">if</span> <span class="n">finded</span><span class="p">:</span>
            <span class="n">paObj</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PA_ATTACK</span>
            <span class="c1"># infos minimales (arrêt sécurisé?)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_complete_paObj_with_secure_infos</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">paObj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span>

    <span class="k">def</span> <span class="nf">_search_scheduled_bonus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        En cas de bloquage, vise à amasser le plus de bonus.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">gsearch</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">gamblesearch</span>
        <span class="n">maxactions</span> <span class="o">=</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">maxactions</span>
        <span class="n">finded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">paObj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># les bonus à partée</span>
        <span class="n">listbonus</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;bonus&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">listbonus</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>
        <span class="c1"># distance au robot</span>
        <span class="n">bonusdictlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">listbonus</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_path_length_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
            <span class="n">bonusdictlist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">b</span><span class="p">,</span> <span class="s2">&quot;dist&quot;</span><span class="p">:</span> <span class="n">d</span><span class="p">,</span> <span class="s2">&quot;distprev&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
        <span class="c1"># trie par proximité au robot</span>
        <span class="n">bonusdictlist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;dist&quot;</span><span class="p">))</span>
        <span class="c1"># mesure des inter distances</span>
        <span class="n">proxdictlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bonusdictlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">prevb</span> <span class="o">=</span> <span class="n">robot</span>
            <span class="k">for</span> <span class="n">bdict</span> <span class="ow">in</span> <span class="n">bonusdictlist</span><span class="p">:</span>
                <span class="c1"># mesure des inter distances</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">bdict</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span>
                <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_path_length_between_cases</span><span class="p">(</span><span class="n">prevb</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
                <span class="n">bdict</span><span class="p">[</span><span class="s2">&quot;distprev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
                <span class="n">prevb</span> <span class="o">=</span> <span class="n">b</span>
            <span class="n">proxdictlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">bd</span> <span class="k">for</span> <span class="n">bd</span> <span class="ow">in</span> <span class="n">bonusdictlist</span> <span class="k">if</span> <span class="n">bd</span><span class="p">[</span><span class="s2">&quot;distprev&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">proxdictlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">proxdictlist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;distprev&quot;</span><span class="p">,</span> <span class="s2">&quot;dist&quot;</span><span class="p">))</span>
        <span class="c1"># mémorisation coords robot</span>
        <span class="n">refx</span><span class="p">,</span> <span class="n">refy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="c1"># recherche de parcours :</span>
        <span class="n">dictlist</span> <span class="o">=</span> <span class="n">bonusdictlist</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">proxdictlist</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">dictlist</span> <span class="o">=</span> <span class="n">proxdictlist</span>
        <span class="n">tplist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">prevcase</span> <span class="o">=</span> <span class="n">robot</span>
        <span class="n">gcount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">bdict</span> <span class="ow">in</span> <span class="n">dictlist</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">bdict</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">prevcase</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">prevcase</span><span class="o">.</span><span class="n">y</span>
            <span class="n">tp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_TargetPath</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">b</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tp</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># la case peut être atteinte...</span>
                <span class="n">nbgamble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_gamble_count_for_TargetPath</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">tp</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nbgamble</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">gcount</span> <span class="o">+</span> <span class="n">nbgamble</span> <span class="o">&lt;=</span> <span class="n">maxactions</span><span class="p">:</span>
                        <span class="n">tplist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
                        <span class="n">gcount</span> <span class="o">+=</span> <span class="n">nbgamble</span>
                        <span class="n">prevcase</span> <span class="o">=</span> <span class="n">b</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>
        <span class="c1"># création de la liste de pseudos actions</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tplist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">finded</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># concaténation des paths :</span>
            <span class="n">defstepslist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">lastcase</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">subtp</span> <span class="ow">in</span> <span class="n">tplist</span><span class="p">:</span>
                <span class="n">substeps</span> <span class="o">=</span> <span class="n">subtp</span><span class="o">.</span><span class="n">get_steps_list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">tps</span> <span class="ow">in</span> <span class="n">substeps</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">tps</span><span class="o">.</span><span class="n">case</span> <span class="o">!=</span> <span class="n">lastcase</span><span class="p">:</span>
                        <span class="n">defstepslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tps</span><span class="p">)</span>
                        <span class="n">lastcase</span> <span class="o">=</span> <span class="n">tps</span><span class="o">.</span><span class="n">case</span>
            <span class="n">targetpath</span> <span class="o">=</span> <span class="n">TargetPath</span><span class="p">(</span><span class="n">steplist</span><span class="o">=</span><span class="n">defstepslist</span><span class="p">)</span>
            <span class="c1"># création des p.a.</span>
            <span class="n">pseudoactionlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pseudoactionlist_for_TargetPath</span><span class="p">(</span><span class="n">targetpath</span><span class="p">)</span>
            <span class="c1"># Objet PseudoActions</span>
            <span class="n">paObj</span> <span class="o">=</span> <span class="n">PseudoActions</span><span class="p">(</span><span class="n">pseudoactionlist</span><span class="p">,</span> <span class="n">gcount</span><span class="p">)</span>
        <span class="c1"># rétablissement des coordonnées</span>
        <span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">refx</span><span class="p">,</span> <span class="n">refy</span>
        <span class="c1"># retour</span>
        <span class="k">if</span> <span class="n">finded</span><span class="p">:</span>
            <span class="c1"># on mémorise l&#39;action</span>
            <span class="n">paObj</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PA_BONUS</span>
            <span class="n">paObj</span><span class="o">.</span><span class="n">searchctx</span> <span class="o">=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">CTX_BONUS</span>
            <span class="n">gsearch</span><span class="o">.</span><span class="n">paObjlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">paObj</span><span class="p">)</span>
            <span class="c1"># infos minimales (arrêt sécurisé?)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_complete_paObj_with_secure_infos</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">paObj</span><span class="p">)</span>
            <span class="c1"># pertinence :</span>
            <span class="n">relevantfactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valide_paObj_relevance</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">paObj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">relevantfactor</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># on poursuit la recherche</span>
                <span class="n">finded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonus_tried</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span>

    <span class="k">def</span> <span class="nf">_search_scheduled_dangers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Méthode de défense alternative : faire exploser un maximum de mines</span>
<span class="sd">        pour rebattre les cartes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">finded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">paObj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># recherche des mines dans la zone d&#39;attaque</span>
        <span class="n">setatt</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;attaque&quot;</span><span class="p">))</span>
        <span class="n">setdgr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dangers_set_plus1</span>
        <span class="n">proxdgr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">setatt</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">setdgr</span><span class="p">))</span>
        <span class="c1"># Trie</span>
        <span class="n">proxdgr</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;danger_impact&quot;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># recherche</span>
        <span class="k">for</span> <span class="n">dgr</span> <span class="ow">in</span> <span class="n">proxdgr</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dgr</span><span class="o">.</span><span class="n">danger_impact</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_scheduled_attaque</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">targetcase</span><span class="o">=</span><span class="n">dgr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">finded</span><span class="p">:</span>
                <span class="n">paObj</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PA_DANGERS</span>
                <span class="c1"># infos minimales (arrêt sécurisé?)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_complete_paObj_with_secure_infos</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">paObj</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span>

    <span class="k">def</span> <span class="nf">_search_scheduled_desperate_escape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recherche d&#39;une fuite désespérée</span>
<span class="sd">        Retourne un boolean indiquant si une solution a été trouvée et une liste</span>
<span class="sd">        de pseudos actions ou None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">gsearch</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">gamblesearch</span>
        <span class="n">maxactions</span> <span class="o">=</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">maxactions</span>
        <span class="n">finded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">paObj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">pseudoactionlist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">midQI</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;intelligence&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
        <span class="c1"># le bot à priori le plus dangereux :</span>
        <span class="n">defbot</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">listdef</span> <span class="o">=</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">list_defense</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">listdef</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">defbot</span> <span class="o">=</span> <span class="n">listdef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">defbot</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">finded</span><span class="p">,</span> <span class="n">pseudoactionlist</span>
        <span class="c1"># On s&#39;éloigne de defbot (en posant mine ou mur si intelligence &lt; moyenne)</span>
        <span class="c1"># case la plus éloignée de defbot</span>
        <span class="n">move_zone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_caseset_for_coordset</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">move_zone</span><span class="p">)</span>
        <span class="n">dlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">move_zone</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">defbot</span><span class="p">)</span>
            <span class="n">dlist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s2">&quot;dist&quot;</span><span class="p">:</span> <span class="n">d</span><span class="p">})</span>
        <span class="n">dlist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;dist&quot;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># recherche de chemin :</span>
        <span class="n">farcase</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">cdict</span> <span class="ow">in</span> <span class="n">dlist</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span>
            <span class="n">tp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_TargetPath</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">c</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tp</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">farcase</span> <span class="o">=</span> <span class="n">c</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">farcase</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nbgamble</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">pseudoactionlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">tpslist</span> <span class="o">=</span> <span class="n">tp</span><span class="o">.</span><span class="n">get_steps_list</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">for</span> <span class="n">tps</span> <span class="ow">in</span> <span class="n">tpslist</span><span class="p">:</span>
                <span class="n">case</span> <span class="o">=</span> <span class="n">tps</span><span class="o">.</span><span class="n">case</span>
                <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_case_pathcost_for_robot</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
                <span class="c1"># conditions d&#39;arrêt</span>
                <span class="k">if</span> <span class="n">cost</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">nbgamble</span> <span class="o">&gt;=</span> <span class="n">maxactions</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">nbgamble</span> <span class="o">+=</span> <span class="n">cost</span>
                <span class="c1"># mouvement :</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">case</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">case</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
                <span class="n">tc</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">type_case</span>
                <span class="n">dgr_impact</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">tc</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_DANGER</span><span class="p">:</span>
                    <span class="n">dgr_impact</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">danger_impact</span>
                <span class="n">pseudoaction</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;goto&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;coords&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span>
                    <span class="s2">&quot;type_case&quot;</span><span class="p">:</span> <span class="n">tc</span><span class="p">,</span>
                    <span class="s2">&quot;danger_impact&quot;</span><span class="p">:</span> <span class="n">dgr_impact</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">pseudoactionlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pseudoaction</span><span class="p">)</span>
                <span class="c1"># mur ou mine</span>
                <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">intelligence</span> <span class="o">&lt;</span> <span class="n">midQI</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">nbgamble</span> <span class="o">&lt;</span> <span class="n">maxactions</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">has_mine</span><span class="p">:</span>
                            <span class="n">pseudoaction</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;minemax&quot;</span><span class="p">}</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">pseudoaction</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;wall&quot;</span><span class="p">}</span>
                        <span class="n">pseudoactionlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pseudoaction</span><span class="p">)</span>
                        <span class="n">nbgamble</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">nbgamble</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Objet PseudoActions</span>
                <span class="n">paObj</span> <span class="o">=</span> <span class="n">PseudoActions</span><span class="p">(</span><span class="n">pseudoactionlist</span><span class="p">,</span> <span class="n">nbgamble</span><span class="p">)</span>
                <span class="n">paObj</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PA_ESCAPE</span>
                <span class="c1"># infos minimales (arrêt sécurisé?)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_complete_paObj_with_secure_infos</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">paObj</span><span class="p">)</span>
                <span class="n">finded</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># retour :</span>
        <span class="k">return</span> <span class="n">finded</span><span class="p">,</span> <span class="n">paObj</span>

    <span class="c1">#-----&gt; B.7.4- Schedule tools</span>
    <span class="k">def</span> <span class="nf">_valide_paObj_relevance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">paObj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calcul le facteur de pertinence de la PseudoActions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">relevantfactor</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">gsearch</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">gamblesearch</span>
        <span class="c1"># 1- Pertinence globale</span>
        <span class="c1"># la case d&#39;arrivée est elle sûre?</span>
        <span class="n">securestop</span> <span class="o">=</span> <span class="n">paObj</span><span class="o">.</span><span class="n">securestop</span>
        <span class="c1"># une case sûre pourra elle être rejointe ensuite?</span>
        <span class="n">secureissue</span> <span class="o">=</span> <span class="n">paObj</span><span class="o">.</span><span class="n">secureissue</span>
        <span class="c1"># nombre d&#39;actions supplémentaires</span>
        <span class="n">supactions</span> <span class="o">=</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">maxactions</span> <span class="o">-</span> <span class="n">paObj</span><span class="o">.</span><span class="n">gamblecount</span>
        <span class="c1"># fin sur une action nomove?</span>
        <span class="n">lastpa</span> <span class="o">=</span> <span class="n">paObj</span><span class="o">.</span><span class="n">get_last_pseudoaction</span><span class="p">()</span>
        <span class="n">endnomove</span> <span class="o">=</span> <span class="n">lastpa</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;nomove&quot;</span>
        <span class="c1"># évaluation de la pertinence de l&#39;action :</span>
        <span class="k">if</span> <span class="n">securestop</span> <span class="ow">and</span> <span class="n">supactions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">endnomove</span><span class="p">:</span>
                <span class="c1"># pertinence moyenne</span>
                <span class="n">relevantfactor</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># pertinence max</span>
                <span class="n">relevantfactor</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">secureissue</span> <span class="ow">and</span> <span class="n">supactions</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">supactions</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># pertinence max</span>
                <span class="n">relevantfactor</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># pertinence moyenne</span>
                <span class="n">relevantfactor</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># prise en compte minimale des risques de bouclage</span>
        <span class="n">lcoords</span> <span class="o">=</span> <span class="n">paObj</span><span class="o">.</span><span class="n">get_path_in_pseudoaction_list</span><span class="p">()</span>
        <span class="n">paObj</span><span class="o">.</span><span class="n">loop_factor</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">compute_loop_factor</span><span class="p">(</span><span class="n">lcoords</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">paObj</span><span class="o">.</span><span class="n">loop_factor</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">relevantfactor</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># on rétrograde sauf pour la libération de la sortie</span>
            <span class="k">if</span> <span class="n">paObj</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PA_FREE_EXIT</span><span class="p">:</span>
                <span class="n">relevantfactor</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">paObj</span><span class="o">.</span><span class="n">loop_factor</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># cas particulier de la recherche de bonus (lancée si aucune action</span>
        <span class="c1"># optimale ou par objectif n&#39;a atteint la pertinence de 2)</span>
        <span class="k">if</span> <span class="n">paObj</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PA_BONUS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">securestop</span> <span class="ow">and</span> <span class="n">paObj</span><span class="o">.</span><span class="n">bonuscount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">relevantfactor</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="n">paObj</span><span class="o">.</span><span class="n">loop_factor</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># enregistrement</span>
        <span class="n">paObj</span><span class="o">.</span><span class="n">relevantfactor</span> <span class="o">=</span> <span class="n">relevantfactor</span>
        <span class="c1"># 2- Score :</span>
        <span class="n">sco_avance</span> <span class="o">=</span> <span class="n">paObj</span><span class="o">.</span><span class="n">deltamainpathlen</span>
        <span class="n">sco_bonus</span> <span class="o">=</span> <span class="n">paObj</span><span class="o">.</span><span class="n">bonuscount</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">need_bonus</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">sco_defense</span> <span class="o">=</span> <span class="n">paObj</span><span class="o">.</span><span class="n">defensecount</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">gsearch</span><span class="o">.</span><span class="n">defense_needed</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">sco_attaque</span> <span class="o">=</span> <span class="n">paObj</span><span class="o">.</span><span class="n">attaquecount</span>
        <span class="n">sco_loop</span> <span class="o">=</span> <span class="o">-</span><span class="n">paObj</span><span class="o">.</span><span class="n">loop_factor</span>
        <span class="c1"># enregistrement</span>
        <span class="n">paObj</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="n">sco_avance</span> <span class="o">+</span> <span class="n">sco_bonus</span> <span class="o">+</span> <span class="n">sco_defense</span> <span class="o">+</span> <span class="n">sco_attaque</span> <span class="o">+</span> <span class="n">sco_loop</span>
        <span class="c1"># enregistrement et retour :</span>
        <span class="n">paObj</span><span class="o">.</span><span class="n">relevantfactor</span> <span class="o">=</span> <span class="n">relevantfactor</span>
        <span class="k">return</span> <span class="n">relevantfactor</span>

    <span class="k">def</span> <span class="nf">_complete_paObj_with_secure_infos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">paObj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Renseigne les propriétés suivantes d&#39;un objet PseudoActions :</span>
<span class="sd">        </span>
<span class="sd">        * securestop : la case d&#39;arrivée est elle sûre?</span>
<span class="sd">        * stoptargets : liste des bots / securestop=False</span>
<span class="sd">        * secureissue : une case sûre pourra elle être rejointe ensuite?</span>
<span class="sd">        * bonuscount : nombre de bonus dans le path</span>
<span class="sd">        * defensecount : nombre de bots contre lesquels se défendre éliminés</span>
<span class="sd">        * attaquecount : nombre de bots à attaquer éliminer</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">securestop</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">stoptargets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">case_sortie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_case_sortie</span><span class="p">()</span>
        <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
        <span class="c1"># définition de la sûreté des zones :</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">gsearch</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">gamblesearch</span>
        <span class="n">botdefcount</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># bots contre lesquels se défendre touchés</span>
        <span class="n">botattcount</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># bots à attaquer touchés</span>
        <span class="k">if</span> <span class="n">paObj</span><span class="o">.</span><span class="n">killedbots</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># des bots vont être éliminés pendant l&#39;action, on doit re définir</span>
            <span class="c1"># les zones</span>
            <span class="n">defall</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;defense_all&quot;</span><span class="p">)</span>
            <span class="n">defreal</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">defall</span> <span class="k">if</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">paObj</span><span class="o">.</span><span class="n">killedbots</span><span class="p">]</span>
            <span class="n">move_zone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_caseset_for_coordset</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">move_zone</span><span class="p">)</span>
            <span class="n">safe_set</span> <span class="o">=</span> <span class="n">move_zone</span>  <span class="c1"># cases sûres / coups directs</span>
            <span class="n">ext_unsafe_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># zone étendue des cases attaquables</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">defreal</span><span class="p">:</span>
                <span class="n">b_att</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_caseset_for_coordset</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">attack_zone</span><span class="p">)</span>
                <span class="n">safe_set</span> <span class="o">=</span> <span class="n">safe_set</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">b_att</span><span class="p">)</span>
                <span class="n">ext_unsafe_set</span> <span class="o">=</span> <span class="n">ext_unsafe_set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">b_att</span><span class="p">)</span>
            <span class="n">safezone</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">safe_set</span><span class="p">)</span>
            <span class="n">extendedunsafezone</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ext_unsafe_set</span><span class="p">)</span>
            <span class="c1"># dénombrement des bots touchés :</span>
            <span class="n">killset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">paObj</span><span class="o">.</span><span class="n">killedbots</span><span class="p">)</span>
            <span class="n">defset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">list_defense</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">defset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">gsearch</span><span class="o">.</span><span class="n">list_defense</span><span class="p">)</span>
            <span class="n">botdefcount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">killset</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">defset</span><span class="p">))</span>
            <span class="n">attset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">list_attaque</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">attset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">gsearch</span><span class="o">.</span><span class="n">list_attaque</span><span class="p">)</span>
            <span class="n">botattcount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">killset</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">attset</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># pas de bots éliminés, on utilise les listes complètes</span>
            <span class="n">extendedunsafezone</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;extendedunsafezone&quot;</span><span class="p">)</span>
            <span class="n">safezone</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;safezone&quot;</span><span class="p">)</span>
        <span class="c1"># 1- Case d&#39;arrivée de la série d&#39;actions</span>
        <span class="c1"># dernière case atteinte :</span>
        <span class="n">coordspath</span> <span class="o">=</span> <span class="n">paObj</span><span class="o">.</span><span class="n">get_path_in_pseudoaction_list</span><span class="p">()</span>
        <span class="n">lastcase</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coordspath</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">coordspath</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">lastcase</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lastcase</span> <span class="o">=</span> <span class="n">robot</span>
        <span class="c1"># est elle dans la zone non sûre?</span>
        <span class="k">if</span> <span class="n">lastcase</span> <span class="o">==</span> <span class="n">case_sortie</span><span class="p">:</span>
            <span class="n">securestop</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">lastcase</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extendedunsafezone</span><span class="p">:</span>
            <span class="n">securestop</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">deftargets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_defense_targets_for_case</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">lastcase</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">paObj</span><span class="o">.</span><span class="n">killedbots</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># on retire les bots qui vont être éliminés</span>
                <span class="n">stoptargets</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">deftargets</span> <span class="k">if</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">paObj</span><span class="o">.</span><span class="n">killedbots</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stoptargets</span> <span class="o">=</span> <span class="n">deftargets</span>
        <span class="c1"># distance du chemin vers la cible principale</span>
        <span class="n">mainTarget</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_main_target</span><span class="p">()</span>
        <span class="n">deltamainpathlen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">mainTarget</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">maincase</span> <span class="o">=</span> <span class="n">mainTarget</span><span class="o">.</span><span class="n">case</span>
            <span class="n">mainpathlen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_path_length_between_cases</span><span class="p">(</span>
                <span class="n">lastcase</span><span class="p">,</span> <span class="n">maincase</span>
            <span class="p">)</span>
            <span class="n">botpathlen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_path_length_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">maincase</span><span class="p">)</span>
            <span class="n">deltamainpathlen</span> <span class="o">=</span> <span class="n">botpathlen</span> <span class="o">-</span> <span class="n">mainpathlen</span>
        <span class="c1"># 2- Possibilité de rejoindre une case sûre ensuite?</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">gsearch</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">gamblesearch</span>
        <span class="n">maxactions</span> <span class="o">=</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">maxactions</span>
        <span class="n">supactions</span> <span class="o">=</span> <span class="n">maxactions</span> <span class="o">-</span> <span class="n">paObj</span><span class="o">.</span><span class="n">gamblecount</span>
        <span class="n">secureissue</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">lastcase</span> <span class="o">==</span> <span class="n">case_sortie</span><span class="p">:</span>
            <span class="n">secureissue</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">supactions</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># 2.1- Trajet initial à rebourd sur?</span>
            <span class="k">if</span> <span class="n">lastcase</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">robot</span><span class="p">]:</span>
                <span class="c1"># si lastcase est sure et que le trajet robot-&gt;lastcase est</span>
                <span class="c1"># réalisable en supactions coups maximum, on a trouvé une</span>
                <span class="c1"># solution de repli possible</span>
                <span class="k">if</span> <span class="n">lastcase</span> <span class="ow">in</span> <span class="n">safezone</span><span class="p">:</span>
                    <span class="c1"># reconstitution du targetpath :</span>
                    <span class="n">stepslist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">coords</span> <span class="ow">in</span> <span class="n">coordspath</span><span class="p">:</span>
                        <span class="n">c</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="o">*</span><span class="n">coords</span><span class="p">)</span>
                        <span class="n">tps</span> <span class="o">=</span> <span class="n">TargetPathStep</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                        <span class="n">stepslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tps</span><span class="p">)</span>
                    <span class="n">backtp</span> <span class="o">=</span> <span class="n">TargetPath</span><span class="p">(</span><span class="n">steplist</span><span class="o">=</span><span class="n">stepslist</span><span class="p">)</span>
                    <span class="n">backcount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_gamble_count_for_TargetPath</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">backtp</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">backcount</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">backcount</span> <span class="o">&lt;=</span> <span class="n">supactions</span><span class="p">:</span>
                        <span class="n">secureissue</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># 2.2- Recherche d&#39;autres cases sures</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">secureissue</span><span class="p">:</span>
                <span class="c1"># coordonnées du robot :</span>
                <span class="n">refx</span><span class="p">,</span> <span class="n">refy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
                <span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">lastcase</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">lastcase</span><span class="o">.</span><span class="n">y</span>
                <span class="c1"># une case sûre pourra elle être atteinte?</span>
                <span class="n">limitedsafe</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">safezone</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_path_length_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;=</span> <span class="n">supactions</span><span class="p">:</span>
                        <span class="n">limitedsafe</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s2">&quot;dist&quot;</span><span class="p">:</span> <span class="n">d</span><span class="p">})</span>
                <span class="n">limitedsafe</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;dist&quot;</span><span class="p">))</span>
                <span class="c1"># recherche restreinte aux cases accessibles</span>
                <span class="n">restrictsafe</span> <span class="o">=</span> <span class="p">[</span><span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">cdict</span> <span class="ow">in</span> <span class="n">limitedsafe</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">restrictsafe</span><span class="p">:</span>
                    <span class="n">tp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_TargetPath</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">c</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">tp</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># la première possibilité suffit</span>
                        <span class="n">secureissue</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="c1"># rétablissement des coords :</span>
                <span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">refx</span><span class="p">,</span> <span class="n">refy</span>
        <span class="c1"># 3- Dénombrement des bonus :</span>
        <span class="n">listcoords</span> <span class="o">=</span> <span class="n">paObj</span><span class="o">.</span><span class="n">get_path_in_pseudoaction_list</span><span class="p">()</span>
        <span class="n">listcases</span> <span class="o">=</span> <span class="p">[</span><span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">listcoords</span><span class="p">]</span>
        <span class="n">listbonus</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">listcases</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_BONUS</span><span class="p">]</span>
        <span class="n">nbbonus</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">listbonus</span><span class="p">)</span>
        <span class="c1"># 4- Mise à jour de l&#39;objet</span>
        <span class="n">paObj</span><span class="o">.</span><span class="n">securestop</span> <span class="o">=</span> <span class="n">securestop</span>
        <span class="n">paObj</span><span class="o">.</span><span class="n">stoptargets</span> <span class="o">=</span> <span class="n">stoptargets</span>
        <span class="n">paObj</span><span class="o">.</span><span class="n">secureissue</span> <span class="o">=</span> <span class="n">secureissue</span>
        <span class="n">paObj</span><span class="o">.</span><span class="n">bonuscount</span> <span class="o">=</span> <span class="n">nbbonus</span>
        <span class="n">paObj</span><span class="o">.</span><span class="n">defensecount</span> <span class="o">=</span> <span class="n">botdefcount</span>
        <span class="n">paObj</span><span class="o">.</span><span class="n">attaquecount</span> <span class="o">=</span> <span class="n">botattcount</span>
        <span class="n">paObj</span><span class="o">.</span><span class="n">deltamainpathlen</span> <span class="o">=</span> <span class="n">deltamainpathlen</span>

    <span class="k">def</span> <span class="nf">_get_attack_probas_for_move_zone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retourne une liste de dicts {&quot;case&quot;, &quot;proba&quot;:}, triée par proba desc</span>
<span class="sd">        des cases de la zone de déplacement du robot avec proba une pseudo</span>
<span class="sd">        probabilité d&#39;attaque associée à une case.</span>
<span class="sd">        Rq : ces pseudos probas sont aussi approximatives que sous évaluées,</span>
<span class="sd">        elles permettent néanmoins d&#39;essayer de minimiser les risques lorsqu&#39;il</span>
<span class="sd">        n&#39;y a pas de zone sûre.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="c1"># 1- Cache ?</span>
        <span class="n">cachedlist</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;prob_dicts&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cachedlist</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cachedlist</span>
        <span class="c1"># 2- Calcul des probabilités d&#39;attaque par case de move_zone :</span>
        <span class="c1"># - init avec probas nulles</span>
        <span class="n">probdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">move_zone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_caseset_for_coordset</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">move_zone</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">move_zone</span><span class="p">:</span>
            <span class="n">probdict</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s2">&quot;proba&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="c1"># - proba max d&#39;attaque par case sur l&#39;ensemble des bots contre lesquels</span>
        <span class="c1"># se défendre</span>
        <span class="n">listdef</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;defense_all&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">listdef</span><span class="p">:</span>
            <span class="n">bprobdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">evaluate_bot_attack_proba_for_robot</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">bprobdict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">casedict</span> <span class="o">=</span> <span class="n">probdict</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                <span class="n">oldp</span> <span class="o">=</span> <span class="n">casedict</span><span class="p">[</span><span class="s2">&quot;proba&quot;</span><span class="p">]</span>
                <span class="n">casedict</span><span class="p">[</span><span class="s2">&quot;proba&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">oldp</span><span class="p">)</span>
        <span class="c1"># - extraction et trie de la liste de dicts {&quot;case&quot;:, &quot;proba&quot;:}</span>
        <span class="n">listprob</span> <span class="o">=</span> <span class="p">[</span><span class="n">dv</span> <span class="k">for</span> <span class="n">dv</span> <span class="ow">in</span> <span class="n">probdict</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="n">listprob</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;proba&quot;</span><span class="p">))</span>
        <span class="c1"># - mise en cache</span>
        <span class="n">gdSet</span><span class="o">.</span><span class="n">register_list_case</span><span class="p">(</span><span class="s2">&quot;prob_dicts&quot;</span><span class="p">,</span> <span class="n">listprob</span><span class="p">)</span>
        <span class="c1"># retour</span>
        <span class="k">return</span> <span class="n">listprob</span>

    <span class="k">def</span> <span class="nf">_evaluate_scheduled_shoot_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">maxactions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evalue si la case peut être une bonne position de tir sur target</span>
<span class="sd">        pour le robot disposant de maxactions possibles</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">finded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">finalTargetPath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">attaquepaobj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">attaquepa</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">killedbots</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">nbgamble</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># targetpath :</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_TargetPath</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tp</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># la case peut être atteinte...</span>
            <span class="n">nbgamble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_gamble_count_for_TargetPath</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">tp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nbgamble</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nbgamble</span> <span class="o">&lt;</span> <span class="n">maxactions</span><span class="p">:</span>
                <span class="c1"># ... assez rapidement</span>
                <span class="c1"># déplacement du robot à la position de la case</span>
                <span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">case</span><span class="o">.</span><span class="n">y</span>
                <span class="c1"># attaque directe :</span>
                <span class="n">finded</span><span class="p">,</span> <span class="n">attaquepaobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_scheduled_attaque</span><span class="p">(</span>
                    <span class="n">robot</span><span class="p">,</span> <span class="n">targetcase</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">pathsearch</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">finded</span><span class="p">:</span>
                    <span class="c1"># on a trouvé une solution</span>
                    <span class="n">attaquepa</span> <span class="o">=</span> <span class="n">attaquepaobj</span><span class="o">.</span><span class="n">get_next_pseudoaction</span><span class="p">()</span>
                    <span class="n">killedbots</span> <span class="o">=</span> <span class="n">attaquepaobj</span><span class="o">.</span><span class="n">killedbots</span>
                    <span class="n">finalTargetPath</span> <span class="o">=</span> <span class="n">tp</span>
        <span class="c1"># retour</span>
        <span class="k">return</span> <span class="n">finded</span><span class="p">,</span> <span class="n">finalTargetPath</span><span class="p">,</span> <span class="n">attaquepa</span><span class="p">,</span> <span class="n">killedbots</span><span class="p">,</span> <span class="n">nbgamble</span>

    <span class="k">def</span> <span class="nf">_preselect_cases_for_safe_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">listcase</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retourne une liste de cases de listcase cohérente avec les cibles,</span>
<span class="sd">        ou la liste complète par défaut.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dmax</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dmax</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="c1"># directions ou paths à privilégier?</span>
        <span class="n">targetpathlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_optimal_listcases_for_move</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="n">refdirs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">maintarget</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_main_target</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">maintarget</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">refdirs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dirs_to_mainTarget</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="c1"># pré sélection :</span>
        <span class="n">choicedictlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">preselectlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="c1"># dans le path</span>
        <span class="k">if</span> <span class="n">targetpathlist</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">listcase</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">targetpathlist</span><span class="p">:</span>
                    <span class="n">dist</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;=</span> <span class="n">dmax</span><span class="p">:</span>
                        <span class="n">bonus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonus_set</span><span class="p">)</span>
                        <span class="n">choicedict</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span>
                            <span class="s2">&quot;dist&quot;</span><span class="p">:</span> <span class="n">dist</span><span class="p">,</span>
                            <span class="s2">&quot;bonus&quot;</span><span class="p">:</span> <span class="n">bonus</span><span class="p">,</span>
                            <span class="s2">&quot;inpath&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="s2">&quot;indirect&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="p">}</span>
                        <span class="n">choicedictlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">choicedict</span><span class="p">)</span>
                    <span class="n">preselectlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="c1"># dans les directions de ref</span>
        <span class="k">if</span> <span class="n">refdirs</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">listcase</span><span class="p">:</span>
                <span class="n">direct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dir_for_case</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">direct</span> <span class="ow">in</span> <span class="n">refdirs</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">preselectlist</span><span class="p">:</span>
                    <span class="n">dist</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;=</span> <span class="n">dmax</span><span class="p">:</span>
                        <span class="n">bonus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonus_set</span><span class="p">)</span>
                        <span class="n">choicedict</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span>
                            <span class="s2">&quot;dist&quot;</span><span class="p">:</span> <span class="n">dist</span><span class="p">,</span>
                            <span class="s2">&quot;bonus&quot;</span><span class="p">:</span> <span class="n">bonus</span><span class="p">,</span>
                            <span class="s2">&quot;inpath&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="s2">&quot;indirect&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="p">}</span>
                        <span class="n">choicedictlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">choicedict</span><span class="p">)</span>
                    <span class="n">preselectlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="c1"># liste finale :</span>
        <span class="n">finalchoicedictlist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">preselectlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">finalchoicedictlist</span> <span class="o">=</span> <span class="n">choicedictlist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">finalchoicedictlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">listcase</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">preselectlist</span><span class="p">:</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;=</span> <span class="n">dmax</span><span class="p">:</span>
                    <span class="n">bonus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonus_set</span><span class="p">)</span>
                    <span class="n">choicedict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span>
                        <span class="s2">&quot;dist&quot;</span><span class="p">:</span> <span class="n">dist</span><span class="p">,</span>
                        <span class="s2">&quot;bonus&quot;</span><span class="p">:</span> <span class="n">bonus</span><span class="p">,</span>
                        <span class="s2">&quot;inpath&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s2">&quot;indirect&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">finalchoicedictlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">choicedict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">finalchoicedictlist</span>

    <span class="k">def</span> <span class="nf">_get_optimal_listcases_for_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retourne une liste de maxactions éléments comprenant :</span>
<span class="sd">        </span>
<span class="sd">        * les cases du path de Target Temp augmentées de la liste des cases</span>
<span class="sd">          suivant la cible</span>
<span class="sd">        * les cases du path de la cible principale sinon</span>
<span class="sd">        * None par défaut</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">gsearch</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">gamblesearch</span>
        <span class="n">maxactions</span> <span class="o">=</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">maxactions</span>
        <span class="c1"># liste des cases qui devraient constituer la suite du chemin</span>
        <span class="n">listcases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nextcases_in_path</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="c1"># on tronque listcases pour avoir au max maxactions éléments</span>
        <span class="k">if</span> <span class="n">listcases</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">listcases</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxactions</span><span class="p">:</span>
            <span class="n">listcases</span> <span class="o">=</span> <span class="n">listcases</span><span class="p">[:</span><span class="n">maxactions</span><span class="p">]</span>
        <span class="c1"># retour:</span>
        <span class="k">return</span> <span class="n">listcases</span>

    <span class="k">def</span> <span class="nf">_get_nextcases_in_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recherche quelle seront les prochaines cases dans le path des cibles</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">listcases</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># recherche dans les paths des cibles</span>
        <span class="n">targettp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tempTarget</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_temp_target</span><span class="p">()</span>
        <span class="n">targettype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">tempTarget</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">targettp</span> <span class="o">=</span> <span class="n">tempTarget</span><span class="o">.</span><span class="n">targetpath</span>
            <span class="n">targettype</span> <span class="o">=</span> <span class="n">tempTarget</span><span class="o">.</span><span class="n">typetarget</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">maintarget</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_main_target</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">maintarget</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">targettp</span> <span class="o">=</span> <span class="n">maintarget</span><span class="o">.</span><span class="n">targetpath</span>
                <span class="n">targettype</span> <span class="o">=</span> <span class="n">maintarget</span><span class="o">.</span><span class="n">typetarget</span>
        <span class="k">if</span> <span class="n">targettp</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># dans les cases suivant la cible</span>
            <span class="n">targetsteplist</span> <span class="o">=</span> <span class="n">targettp</span><span class="o">.</span><span class="n">get_steps_list</span><span class="p">()</span>
            <span class="n">listcases</span> <span class="o">=</span> <span class="p">[</span><span class="n">tps</span><span class="o">.</span><span class="n">case</span> <span class="k">for</span> <span class="n">tps</span> <span class="ow">in</span> <span class="n">targetsteplist</span><span class="p">]</span>
            <span class="n">listcases</span> <span class="o">=</span> <span class="n">listcases</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># première case = robot</span>
            <span class="k">if</span> <span class="n">targettype</span> <span class="o">==</span> <span class="n">TargetObject</span><span class="o">.</span><span class="n">TARGET_TEMP</span><span class="p">:</span>
                <span class="c1"># dans le cas d&#39;une cible principale le chemin complet est déja</span>
                <span class="c1"># défini. Dans le cas d&#39;une cible temporaire, le chemin va se</span>
                <span class="c1"># poursuivre (à priori) dans les cases suivant la cible.</span>
                <span class="n">targetlistcases</span> <span class="o">=</span> <span class="n">tempTarget</span><span class="o">.</span><span class="n">listcases</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">listcases</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">targetlistcases</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">listcases</span>

    <span class="k">def</span> <span class="nf">_get_gamble_count_for_TargetPath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">targetpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compte le nombre de coups nécessaire pour atteindre la dernière case</span>
<span class="sd">        du targetpath</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbgamble</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">targetpath</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">targetpath</span><span class="o">.</span><span class="n">get_steps_list</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tpslist</span> <span class="o">=</span> <span class="n">targetpath</span><span class="o">.</span><span class="n">get_steps_list</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">nbgamble</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">tps</span> <span class="ow">in</span> <span class="n">tpslist</span><span class="p">:</span>
                <span class="n">case</span> <span class="o">=</span> <span class="n">tps</span><span class="o">.</span><span class="n">case</span>
                <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_case_pathcost_for_robot</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cost</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="n">nbgamble</span> <span class="o">+=</span> <span class="n">cost</span>
        <span class="k">return</span> <span class="n">nbgamble</span>

    <span class="k">def</span> <span class="nf">_get_case_pathcost_for_robot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retourne le coût pour accéder à la case</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">case</span><span class="o">.</span><span class="n">type_case</span> <span class="ow">in</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_CASES_LIBRES</span><span class="p">:</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">robot</span><span class="o">.</span><span class="n">has_grenade</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">case</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_ROBOT</span><span class="p">:</span>
                <span class="c1"># peut on l&#39;éliminer?</span>
                <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
                <span class="n">att_all</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;attaque_all&quot;</span><span class="p">)</span>
                <span class="n">def_all</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;defense_all&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">att_all</span> <span class="ow">or</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">def_all</span><span class="p">:</span>
                    <span class="n">cost</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># case danger : suppression théorique possible</span>
                <span class="n">cost</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">cost</span>

    <span class="k">def</span> <span class="nf">_get_pseudoactionlist_for_TargetPath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targetpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convertit le TargetPath en liste de pseudos actions de mouvement</span>
<span class="sd">        Rq : la validité de targetpath a été vérifiée au préalable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pseudoactionlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">tpslist</span> <span class="o">=</span> <span class="n">targetpath</span><span class="o">.</span><span class="n">get_steps_list</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="n">tpslist</span><span class="p">:</span>
            <span class="n">case</span> <span class="o">=</span> <span class="n">tp</span><span class="o">.</span><span class="n">case</span>
            <span class="n">pseudoaction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_move_pseudoaction_for_case</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>
            <span class="n">pseudoactionlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pseudoaction</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pseudoactionlist</span>

    <span class="k">def</span> <span class="nf">_format_move_pseudoaction_for_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Génère la pseudo action de déplacement sur la case</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tc</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">type_case</span>
        <span class="n">dgr_impact</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">tc</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_DANGER</span><span class="p">:</span>
            <span class="n">dgr_impact</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">danger_impact</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">case</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">case</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="c1"># pseudo action de déplacement</span>
        <span class="n">pseudoaction</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;goto&quot;</span><span class="p">,</span>
            <span class="s2">&quot;coords&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span>
            <span class="s2">&quot;type_case&quot;</span><span class="p">:</span> <span class="n">tc</span><span class="p">,</span>
            <span class="s2">&quot;danger_impact&quot;</span><span class="p">:</span> <span class="n">dgr_impact</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">pseudoaction</span>

    <span class="k">def</span> <span class="nf">_get_defense_targets_for_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrouve dans les bots contre lesquels se défendre, ceux qui menacent</span>
<span class="sd">        directement case.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">def_all</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;defense_all&quot;</span><span class="p">)</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">def_all</span><span class="p">:</span>
            <span class="n">bot_attaque</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_caseset_for_coordset</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">attack_zone</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">bot_attaque</span><span class="p">:</span>
                <span class="n">targets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">targets</span>

    <span class="c1">#-----&gt; B.7.5- Application de commandes anticipées</span>
    <span class="k">def</span> <span class="nf">_get_cmd_for_next_pseudoaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Traduit la prochaine pseudoaction en commande si elle existe ou</span>
<span class="sd">        retourne None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
        <span class="n">firstadj</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;first_adj&quot;</span><span class="p">)</span>
        <span class="n">bonusadj</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;bonus_adj&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bonusadj</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bonusadj</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">alladj</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;all_adj&quot;</span><span class="p">)</span>
        <span class="n">safezone</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;safezone&quot;</span><span class="p">)</span>
        <span class="n">nextpa</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">paobj</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_pseudoactions</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">paobj</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nextpa</span> <span class="o">=</span> <span class="n">paobj</span><span class="o">.</span><span class="n">get_next_pseudoaction</span><span class="p">()</span>
        <span class="n">removepa</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">nextpa</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># profondeur de recherche</span>
            <span class="n">fullsearch</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">recursive</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">highQI</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;intelligence&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">intelligence</span> <span class="o">&gt;=</span> <span class="n">highQI</span><span class="p">:</span>
                <span class="n">recursive</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">need_bonus</span><span class="p">:</span>
                    <span class="c1"># recherche de toutes les combinaisons de terraformage pour</span>
                    <span class="c1"># limiter la destruction de bonus</span>
                    <span class="n">fullsearch</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">typepa</span> <span class="o">=</span> <span class="n">nextpa</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">typepa</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;grenade&quot;</span><span class="p">,</span> <span class="s2">&quot;kill&quot;</span><span class="p">]:</span>
                <span class="c1"># attaque, cmd déja générée et pré validée</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">nextpa</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]</span>
                <span class="n">removepa</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">typepa</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;goto&quot;</span><span class="p">]:</span>
                <span class="c1"># mouvement :</span>
                <span class="c1"># liste des coordonnées du path à suivre :</span>
                <span class="n">listcoords</span> <span class="o">=</span> <span class="n">paobj</span><span class="o">.</span><span class="n">get_path_in_pseudoaction_list</span><span class="p">()</span>
                <span class="n">listcases</span> <span class="o">=</span> <span class="p">[</span><span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">listcoords</span><span class="p">]</span>
                <span class="c1"># ménage à faire ?</span>
                <span class="n">dellist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">listcases</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">type_case</span> <span class="ow">in</span> <span class="p">[</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_DANGER</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_MUR</span><span class="p">]:</span>
                        <span class="n">dellist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dellist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_cmd_in_terraform_list</span><span class="p">(</span>
                        <span class="n">robot</span><span class="p">,</span> <span class="n">dellist</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span> <span class="n">fullsearch</span><span class="o">=</span><span class="n">fullsearch</span>
                    <span class="p">)</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">nextpa</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">]</span>
                    <span class="n">case</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                    <span class="n">actiondict</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">doremove</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">case</span><span class="o">.</span><span class="n">type_case</span> <span class="ow">in</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_CASES_LIBRES</span><span class="p">:</span>
                        <span class="n">actiondict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_MOVE</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
                        <span class="n">doremove</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">case</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_MUR</span><span class="p">:</span>
                        <span class="n">actiondict</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_CREATE_DOOR</span><span class="p">,</span>
                            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_PORTE</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="c1"># Rq : inutile de vérifier que l&#39;action est sûre si l&#39;on</span>
                    <span class="c1"># transite par une case hors safezone (handlebehavior=False)</span>
                    <span class="k">if</span> <span class="n">actiondict</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_simple_action</span><span class="p">(</span>
                            <span class="n">robot</span><span class="p">,</span> <span class="n">actiondict</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">handlebehavior</span><span class="o">=</span><span class="kc">False</span>
                        <span class="p">)</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">removepa</span> <span class="o">=</span> <span class="n">doremove</span>
            <span class="k">elif</span> <span class="n">typepa</span> <span class="o">==</span> <span class="s2">&quot;nomove&quot;</span><span class="p">:</span>
                <span class="c1"># actions à priori statiques</span>
                <span class="n">sup_gdcount</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">gamblecount</span> <span class="o">-</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">gamblenumber</span>
                <span class="k">if</span> <span class="n">sup_gdcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># dernière action du tour, un mouvement sur et pertinent</span>
                    <span class="c1"># est il possible?</span>
                    <span class="n">moveset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">bonusadj</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">firstadj</span><span class="p">))</span>
                    <span class="n">safeset</span> <span class="o">=</span> <span class="n">moveset</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">safezone</span><span class="p">))</span>
                    <span class="n">listcases</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">safeset</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_CASES_LIBRES</span>
                    <span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">listcases</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">actiondict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_MOVE</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_simple_action</span><span class="p">(</span>
                            <span class="n">robot</span><span class="p">,</span> <span class="n">actiondict</span><span class="p">,</span> <span class="n">listcases</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">handlebehavior</span><span class="o">=</span><span class="kc">True</span>
                        <span class="p">)</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># ménage anticipé?</span>
                    <span class="n">listcases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nextcases_in_path</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">listcases</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">dellist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">listcases</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">type_case</span> <span class="ow">in</span> <span class="p">[</span>
                                <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_DANGER</span><span class="p">,</span>
                                <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_MUR</span><span class="p">,</span>
                            <span class="p">]:</span>
                                <span class="n">dellist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dellist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_cmd_in_terraform_list</span><span class="p">(</span>
                                <span class="n">robot</span><span class="p">,</span>
                                <span class="n">dellist</span><span class="p">,</span>
                                <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span>
                                <span class="n">fullsearch</span><span class="o">=</span><span class="n">fullsearch</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sup_gdcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="c1"># on modifie le type de l&#39;objet :</span>
                                <span class="c1"># cf identification des actions stay in place</span>
                                <span class="c1"># répétées.</span>
                                <span class="n">paobj</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">PA_TERRAFORM</span>
                                <span class="c1"># on ré initialise le compteur de ces actions</span>
                                <span class="n">robot</span><span class="o">.</span><span class="n">no_move_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># moins utile : porte, mur</span>
                    <span class="k">for</span> <span class="n">actiontype</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;door&quot;</span><span class="p">,</span> <span class="s2">&quot;wall&quot;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">actiontype</span> <span class="o">==</span> <span class="s2">&quot;door&quot;</span><span class="p">:</span>
                            <span class="n">searchlist</span> <span class="o">=</span> <span class="n">alladj</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">searchlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">alladj</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">firstadj</span><span class="p">]</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_cmd_by_action_in_list</span><span class="p">(</span>
                            <span class="n">robot</span><span class="p">,</span> <span class="n">searchlist</span><span class="p">,</span> <span class="n">actiontype</span>
                        <span class="p">)</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">break</span>
            <span class="k">elif</span> <span class="n">typepa</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;minemax&quot;</span><span class="p">,</span> <span class="s2">&quot;wall&quot;</span><span class="p">]:</span>
                <span class="c1"># mine, mur :</span>
                <span class="n">searchlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">alladj</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">firstadj</span><span class="p">]</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_cmd_by_action_in_list</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">searchlist</span><span class="p">,</span> <span class="n">typepa</span><span class="p">)</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">removepa</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># dépilement de la pseudo action?</span>
            <span class="k">if</span> <span class="n">removepa</span><span class="p">:</span>
                <span class="n">paobj</span><span class="o">.</span><span class="n">remove_pseudoaction_from_list</span><span class="p">(</span><span class="n">nextpa</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cmd</span>

    <span class="k">def</span> <span class="nf">_search_cmd_by_action_in_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">listcase</span><span class="p">,</span> <span class="n">actiontype</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recherche dans la liste de cases la première pouvant faire l&#39;objet</span>
<span class="sd">        de l&#39;action actiontype</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># familles de cases adaptées :</span>
        <span class="n">famille</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">actiontype</span> <span class="o">==</span> <span class="s2">&quot;minemax&quot;</span><span class="p">:</span>
            <span class="n">famille</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_MINE</span>
        <span class="k">elif</span> <span class="n">actiontype</span> <span class="o">==</span> <span class="s2">&quot;wall&quot;</span><span class="p">:</span>
            <span class="n">famille</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_BUILD_WALL</span>
        <span class="k">elif</span> <span class="n">actiontype</span> <span class="o">==</span> <span class="s2">&quot;door&quot;</span><span class="p">:</span>
            <span class="n">famille</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_BUILD_DOOR</span>
        <span class="k">if</span> <span class="n">famille</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># recherche de la première case adaptée</span>
            <span class="n">actioncase</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">listcase</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">type_case</span> <span class="ow">in</span> <span class="n">famille</span><span class="p">:</span>
                    <span class="n">actioncase</span> <span class="o">=</span> <span class="n">c</span>
                    <span class="k">break</span>
            <span class="c1"># si la case existe :</span>
            <span class="k">if</span> <span class="n">actioncase</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">actiondict</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">actiontype</span> <span class="o">==</span> <span class="s2">&quot;minemax&quot;</span><span class="p">:</span>
                    <span class="n">actiondict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_MINE</span><span class="p">,</span>
                        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_MINE</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="k">elif</span> <span class="n">actiontype</span> <span class="o">==</span> <span class="s2">&quot;wall&quot;</span><span class="p">:</span>
                    <span class="n">actiondict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_CREATE_WALL</span><span class="p">,</span>
                        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_MUR</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="k">elif</span> <span class="n">actiontype</span> <span class="o">==</span> <span class="s2">&quot;door&quot;</span><span class="p">:</span>
                    <span class="n">actiondict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_CREATE_DOOR</span><span class="p">,</span>
                        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_PORTE</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="k">if</span> <span class="n">actiondict</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_simple_action</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">actiondict</span><span class="p">,</span> <span class="n">actioncase</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cmd</span>

    <span class="c1">#-----&gt; B.8- Recherche du prochain coup</span>
    <span class="k">def</span> <span class="nf">_search_next_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Choisit une commande une fois la cible temporaire mise à jour et les données évaluées</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># seuils</span>
        <span class="n">midAGG</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;aggressivite&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
        <span class="c1"># Objectifs généraux et actions associées (valuées en termes de violence)</span>
        <span class="n">objectifs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">objectifs</span><span class="p">[</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_MOVE</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_MOVE</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;violence&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_CREATE_DOOR</span><span class="p">,</span>
                <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_PORTE</span><span class="p">,</span>
                <span class="s2">&quot;violence&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>
        <span class="n">objectifs</span><span class="p">[</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_DEFENSE</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_GRENADE</span><span class="p">,</span>
                <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_GRENADE</span><span class="p">,</span>
                <span class="s2">&quot;violence&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_MINE</span><span class="p">,</span>
                <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_MINE</span><span class="p">,</span>
                <span class="s2">&quot;violence&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_KILL</span><span class="p">,</span>
                <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_KILL</span><span class="p">,</span>
                <span class="s2">&quot;violence&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_MOVE</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;violence&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_CREATE_WALL</span><span class="p">,</span>
                <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_MUR</span><span class="p">,</span>
                <span class="s2">&quot;violence&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>
        <span class="n">objectifs</span><span class="p">[</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_ATTACK</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_GRENADE</span><span class="p">,</span>
                <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_GRENADE</span><span class="p">,</span>
                <span class="s2">&quot;violence&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_KILL</span><span class="p">,</span>
                <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_KILL</span><span class="p">,</span>
                <span class="s2">&quot;violence&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>
        <span class="c1"># 1- Priorisation des objectifs :</span>
        <span class="n">orderedobjectifs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_define_direct_ordered_objectifs</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
        <span class="c1"># 2- Traduction des objectifs en actions :</span>
        <span class="n">bot_objectif</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">motclef</span> <span class="ow">in</span> <span class="n">orderedobjectifs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">motclef</span> <span class="o">==</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_MOVE</span><span class="p">:</span>
                <span class="n">mouv_list</span> <span class="o">=</span> <span class="n">objectifs</span><span class="p">[</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_MOVE</span><span class="p">]</span>
                <span class="n">bot_objectif</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_MOVE</span><span class="p">,</span> <span class="n">mouv_list</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">motclef</span> <span class="o">==</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_ATTACK</span><span class="p">:</span>
                <span class="n">att_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="n">objectifs</span><span class="p">[</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_ATTACK</span><span class="p">],</span>
                    <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;violence&quot;</span><span class="p">),</span>
                    <span class="n">reverse</span><span class="o">=</span><span class="n">robot</span><span class="o">.</span><span class="n">aggressivite</span> <span class="o">&gt;=</span> <span class="n">midAGG</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">bot_objectif</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_ATTACK</span><span class="p">,</span> <span class="n">att_list</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">motclef</span> <span class="o">==</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_DEFENSE</span><span class="p">:</span>
                <span class="n">def_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="n">objectifs</span><span class="p">[</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_DEFENSE</span><span class="p">],</span>
                    <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;violence&quot;</span><span class="p">),</span>
                    <span class="n">reverse</span><span class="o">=</span><span class="n">robot</span><span class="o">.</span><span class="n">aggressivite</span> <span class="o">&gt;=</span> <span class="n">midAGG</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">bot_objectif</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_DEFENSE</span><span class="p">,</span> <span class="n">def_list</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">motclef</span> <span class="o">==</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_WORK</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_SAPPER</span><span class="p">:</span>
                    <span class="c1"># travail = pose de mine</span>
                    <span class="n">bot_objectif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_WORK</span><span class="p">,</span>
                            <span class="p">[</span>
                                <span class="p">{</span>
                                    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_MINE</span><span class="p">,</span>
                                    <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_MINE</span><span class="p">,</span>
                                    <span class="s2">&quot;violence&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="p">}</span>
                            <span class="p">],</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_BUILDER</span><span class="p">:</span>
                    <span class="c1"># travail = construction de mur</span>
                    <span class="n">bot_objectif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_WORK</span><span class="p">,</span>
                            <span class="p">[</span>
                                <span class="p">{</span>
                                    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_CREATE_WALL</span><span class="p">,</span>
                                    <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_MUR</span><span class="p">,</span>
                                    <span class="s2">&quot;violence&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                <span class="p">}</span>
                            <span class="p">],</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="n">motclef</span> <span class="o">==</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_RANDOM</span><span class="p">:</span>
                <span class="c1"># hasard = mur, porte, mine, grenade</span>
                <span class="n">list_rand</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_CREATE_WALL</span><span class="p">,</span>
                        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_MUR</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_CREATE_DOOR</span><span class="p">,</span>
                        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_PORTE</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_MINE</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_MINE</span><span class="p">},</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_GRENADE</span><span class="p">,</span>
                        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_GRENADE</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">]</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">CustomRandom</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">list_rand</span><span class="p">)</span>
                <span class="n">bot_objectif</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_RANDOM</span><span class="p">,</span> <span class="n">list_rand</span><span class="p">))</span>
        <span class="c1"># 3- Recherche de commande :</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">bot_objectif</span><span class="p">:</span>
            <span class="n">objectif</span><span class="p">,</span> <span class="n">actionlist</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">objectif</span> <span class="o">==</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_ATTACK</span> <span class="ow">and</span> <span class="n">cmd</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_next_command_attack</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">actionlist</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">objectif</span> <span class="o">==</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_DEFENSE</span> <span class="ow">and</span> <span class="n">cmd</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_next_command_defense</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">actionlist</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">objectif</span> <span class="o">==</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_MOVE</span> <span class="ow">and</span> <span class="n">cmd</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_next_command_move</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">actionlist</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">objectif</span> <span class="o">==</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_WORK</span> <span class="ow">and</span> <span class="n">cmd</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_next_command_work</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">actionlist</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">objectif</span> <span class="o">==</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_RANDOM</span> <span class="ow">and</span> <span class="n">cmd</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_next_command_random</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">actionlist</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="c1"># retour :</span>
        <span class="k">return</span> <span class="n">cmd</span>

    <span class="k">def</span> <span class="nf">_define_direct_ordered_objectifs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retourne une liste d&#39;objectifs priorisés pour le prochain coup à jouer.</span>
<span class="sd">        Méthode dédiée à tous les comportements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">orderedobjectifs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="c1"># paramètres</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">listdefense</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;defense&quot;</span><span class="p">)</span>
        <span class="c1"># caractéristiques du robot</span>
        <span class="n">behavior</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span>
        <span class="n">instinct_survie</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">instinct_survie</span>
        <span class="n">aggressivite</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">aggressivite</span>
        <span class="n">ambition</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">ambition</span>
        <span class="n">intelligence</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">intelligence</span>
        <span class="c1"># seuils</span>
        <span class="n">midSUR</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;instinct_survie&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
        <span class="n">highSUR</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;instinct_survie&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">)</span>
        <span class="n">midAGG</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;aggressivite&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
        <span class="n">highAGG</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;aggressivite&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">)</span>
        <span class="c1"># 1- auto défense :</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">listdefense</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">instinct_survie</span> <span class="o">&gt;=</span> <span class="n">highSUR</span>
            <span class="ow">or</span> <span class="p">(</span>
                <span class="n">instinct_survie</span> <span class="o">&gt;=</span> <span class="n">midSUR</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">instinct_survie</span> <span class="o">+</span> <span class="n">intelligence</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">aggressivite</span> <span class="o">+</span> <span class="n">ambition</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">):</span>
            <span class="n">orderedobjectifs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_DEFENSE</span><span class="p">)</span>
        <span class="c1"># 2- en fonction du comportement :</span>
        <span class="k">if</span> <span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_WINNER</span><span class="p">:</span>
            <span class="n">advdict</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_adversaires_avance</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">advdict</span><span class="p">[</span><span class="s2">&quot;adv_in_final&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">advdict</span><span class="p">[</span><span class="s2">&quot;adv_in_approach&quot;</span><span class="p">]:</span>
                <span class="c1"># des adversaires peuvent gagner !</span>
                <span class="n">orderedobjectifs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_ATTACK</span><span class="p">)</span>
                <span class="n">orderedobjectifs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_MOVE</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Priorité au mouvement</span>
                <span class="n">orderedobjectifs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_MOVE</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_HUNTER</span><span class="p">:</span>
            <span class="n">maintarget</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_main_target</span><span class="p">()</span>
            <span class="n">cond_att</span> <span class="o">=</span> <span class="n">aggressivite</span> <span class="o">&gt;=</span> <span class="n">highAGG</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">maintarget</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">maintarget</span><span class="o">.</span><span class="n">case</span> <span class="ow">in</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;attaque&quot;</span><span class="p">)</span>
            <span class="p">)</span> <span class="ow">or</span> <span class="n">cond_att</span><span class="p">:</span>
                <span class="c1"># Priorité à l&#39;attaque</span>
                <span class="n">orderedobjectifs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_ATTACK</span><span class="p">)</span>
                <span class="n">orderedobjectifs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_MOVE</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Priorité au mouvement</span>
                <span class="n">orderedobjectifs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_MOVE</span><span class="p">)</span>
                <span class="n">orderedobjectifs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_ATTACK</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span> <span class="ow">in</span> <span class="p">[</span><span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_SAPPER</span><span class="p">,</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_BUILDER</span><span class="p">]:</span>
            <span class="c1"># mouvement et &quot;travail&quot; alternés:</span>
            <span class="k">if</span> <span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_SAPPER</span><span class="p">:</span>
                <span class="n">work_action</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_MINE</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">work_action</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_CREATE_WALL</span>
            <span class="c1"># en fonction du ratio :</span>
            <span class="n">nextaction</span> <span class="o">=</span> <span class="s2">&quot;move&quot;</span>
            <span class="n">wmratio</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_work_ratio</span><span class="p">()</span>  <span class="c1"># fraction travail/mouvement</span>
            <span class="k">if</span> <span class="n">wmratio</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># travail dès que possible (sauf dans le targetpath)</span>
                <span class="n">listothers</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;other_adj&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">listothers</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">listothers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="n">freeadj</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">listothers</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">type_case</span> <span class="ow">in</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_BUILD_WALL</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">freeadj</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">nextaction</span> <span class="o">=</span> <span class="s2">&quot;work&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># en fonction des dernières actions effectuées :</span>
                <span class="n">actionlist</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_action_list</span><span class="p">()</span>
                <span class="n">wmratio_num</span> <span class="o">=</span> <span class="n">wmratio</span><span class="o">.</span><span class="n">numerator</span>
                <span class="n">wmratio_den</span> <span class="o">=</span> <span class="n">wmratio</span><span class="o">.</span><span class="n">denominator</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">actionlist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">wmratio_den</span><span class="p">:</span>
                    <span class="c1"># par alternance au début</span>
                    <span class="n">lastaction</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">actionlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">lastaction</span> <span class="o">=</span> <span class="n">actionlist</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">actionlist</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">lastaction</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_MOVE</span><span class="p">:</span>
                        <span class="n">nextaction</span> <span class="o">=</span> <span class="s2">&quot;work&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># par ratio ensuite</span>
                    <span class="n">lastactions</span> <span class="o">=</span> <span class="n">actionlist</span><span class="p">[</span><span class="o">-</span><span class="n">wmratio_den</span><span class="p">:]</span>
                    <span class="n">lastwork</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">lastactions</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">work_action</span><span class="p">]</span>
                    <span class="n">nbwork</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lastwork</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">nbwork</span> <span class="o">&lt;</span> <span class="n">wmratio_num</span><span class="p">:</span>
                        <span class="n">nextaction</span> <span class="o">=</span> <span class="s2">&quot;work&quot;</span>
            <span class="c1"># priorisation</span>
            <span class="k">if</span> <span class="n">nextaction</span> <span class="o">==</span> <span class="s2">&quot;work&quot;</span><span class="p">:</span>
                <span class="n">orderedobjectifs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_WORK</span><span class="p">)</span>
                <span class="n">orderedobjectifs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_MOVE</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">orderedobjectifs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_MOVE</span><span class="p">)</span>
                <span class="n">orderedobjectifs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_WORK</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_TOURIST</span><span class="p">:</span>
            <span class="c1"># Mouvement seul :</span>
            <span class="n">orderedobjectifs</span> <span class="o">=</span> <span class="p">[</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_MOVE</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_RANDOM</span><span class="p">:</span>
            <span class="c1"># random</span>
            <span class="n">orderedobjectifs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_MOVE</span><span class="p">)</span>
            <span class="n">orderedobjectifs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_RANDOM</span><span class="p">)</span>
        <span class="c1"># 3- objectif oublié?</span>
        <span class="k">if</span> <span class="n">behavior</span> <span class="o">!=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_TOURIST</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_ATTACK</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">orderedobjectifs</span>
                <span class="ow">and</span> <span class="n">aggressivite</span> <span class="o">&gt;=</span> <span class="n">midAGG</span>
            <span class="p">):</span>
                <span class="n">orderedobjectifs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_ATTACK</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_DEFENSE</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">orderedobjectifs</span>
                <span class="ow">and</span> <span class="n">instinct_survie</span> <span class="o">&gt;=</span> <span class="n">midSUR</span>
                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">listdefense</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="n">orderedobjectifs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CommandManager</span><span class="o">.</span><span class="n">OBJ_DEFENSE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_RANDOM</span><span class="p">:</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">CustomRandom</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">orderedobjectifs</span><span class="p">)</span>
        <span class="c1"># retour</span>
        <span class="k">return</span> <span class="n">orderedobjectifs</span>

    <span class="k">def</span> <span class="nf">_search_next_command_attack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">actionlist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evalue les possibilités immédiates d&#39;attaque</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">gsearch</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">gamblesearch</span>
        <span class="c1"># cibles de l&#39;attaque</span>
        <span class="n">listbots</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># profondeur de recherche</span>
        <span class="n">recursive</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">highQI</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;intelligence&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">intelligence</span> <span class="o">&gt;=</span> <span class="n">highQI</span><span class="p">:</span>
            <span class="n">recursive</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># cas particuliers :</span>
        <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_WINNER</span><span class="p">:</span>
            <span class="c1"># des adversaires en avance?</span>
            <span class="n">dictadv</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_adversaires_avance</span><span class="p">()</span>
            <span class="n">listadv</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">dictadv</span><span class="p">[</span><span class="s2">&quot;adv_in_final&quot;</span><span class="p">]:</span>
                <span class="n">listadv</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dictadv</span><span class="p">[</span><span class="s2">&quot;final_list&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">dictadv</span><span class="p">[</span><span class="s2">&quot;adv_in_approach&quot;</span><span class="p">]:</span>
                <span class="n">listadv</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dictadv</span><span class="p">[</span><span class="s2">&quot;approach_list&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">listadv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">listbots</span> <span class="o">=</span> <span class="n">listadv</span>
        <span class="k">elif</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_HUNTER</span><span class="p">:</span>
            <span class="n">maintarget</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_main_target</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">maintarget</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">maintarget</span><span class="o">.</span><span class="n">case</span> <span class="ow">in</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;attaque&quot;</span><span class="p">):</span>
                    <span class="n">listbots</span> <span class="o">=</span> <span class="p">[</span><span class="n">maintarget</span><span class="o">.</span><span class="n">case</span><span class="p">]</span>
        <span class="c1"># par défaut :</span>
        <span class="k">if</span> <span class="n">listbots</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">listbots</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;attaque&quot;</span><span class="p">)</span>
        <span class="c1"># filtrage des coups déja analysés :</span>
        <span class="n">filteratt</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">listbots</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">kill_search_already_done</span><span class="p">(</span><span class="n">b</span><span class="p">)]</span>
        <span class="c1"># Recherche de commandes :</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filteratt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">actdict</span> <span class="ow">in</span> <span class="n">actionlist</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">bot</span> <span class="ow">in</span> <span class="n">filteratt</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">actdict</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_GRENADE</span><span class="p">:</span>
                        <span class="c1"># cas complexe : grenade</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_complex_action</span><span class="p">(</span>
                            <span class="n">robot</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_GRENADE</span><span class="p">,</span> <span class="n">bot</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span>
                        <span class="p">)</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
                        <span class="c1"># mémorisation de la recherche</span>
                        <span class="n">gsearch</span><span class="o">.</span><span class="n">register_kill_search</span><span class="p">(</span><span class="n">bot</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># cas général simple (kill)</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_simple_action</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">actdict</span><span class="p">,</span> <span class="n">bot</span><span class="p">)</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="n">cmd</span>

    <span class="k">def</span> <span class="nf">_search_next_command_defense</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">actionlist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evalue les possibilités immédiates de défense</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">gsearch</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">gamblesearch</span>
        <span class="c1"># profondeur de recherche</span>
        <span class="n">recursive</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">highQI</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;intelligence&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">intelligence</span> <span class="o">&gt;=</span> <span class="n">highQI</span><span class="p">:</span>
            <span class="n">recursive</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># 1- robots</span>
        <span class="n">listbots</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;defense&quot;</span><span class="p">)</span>
        <span class="c1"># filtrage des coups déja analysés :</span>
        <span class="n">filterdef</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">listbots</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">gsearch</span><span class="o">.</span><span class="n">kill_search_already_done</span><span class="p">(</span><span class="n">b</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filterdef</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">actdict</span> <span class="ow">in</span> <span class="n">actionlist</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">bot</span> <span class="ow">in</span> <span class="n">filterdef</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">actdict</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_GRENADE</span><span class="p">:</span>
                        <span class="c1"># cas complexe : grenade</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_complex_action</span><span class="p">(</span>
                            <span class="n">robot</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_GRENADE</span><span class="p">,</span> <span class="n">bot</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span>
                        <span class="p">)</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
                        <span class="c1"># mémorisation de la recherche</span>
                        <span class="n">gsearch</span><span class="o">.</span><span class="n">register_kill_search</span><span class="p">(</span><span class="n">bot</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># cas général simple (kill, move, mine...)</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_simple_action</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">actdict</span><span class="p">,</span> <span class="n">bot</span><span class="p">)</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="c1"># 2- dangers</span>
        <span class="n">listdgrs</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;dangers&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">listdgrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">cmd</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">actdict</span> <span class="ow">in</span> <span class="n">actionlist</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">listdgrs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">actdict</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_GRENADE</span><span class="p">:</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_complex_action</span><span class="p">(</span>
                            <span class="n">robot</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_GRENADE</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span>
                        <span class="p">)</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_simple_action</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">actdict</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="n">cmd</span>

    <span class="k">def</span> <span class="nf">_search_next_command_work</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">actionlist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evalue les possibilités de réaliser des commandes particulières hors contexe</span>
<span class="sd">        de défense, attaque, mouvement : pour les sappers, builders et random</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># afin de ne pas bloquer sa progression, on effectue le travail de</span>
        <span class="c1"># préférence sur la dernière case passée ou sur les &quot;other_adj&quot;:</span>
        <span class="n">listadj</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">prevcoords</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_prev_coords</span><span class="p">()</span>
        <span class="n">prevupdated</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">prevcoords</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">prevcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">prevcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
            <span class="n">prevupdated</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">listadj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prevupdated</span><span class="p">)</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">listothers</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;other_adj&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">listothers</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">listadj</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">listothers</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">listadj</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">actdict</span> <span class="ow">in</span> <span class="n">actionlist</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_simple_action</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">actdict</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">cmd</span>

    <span class="k">def</span> <span class="nf">_search_next_command_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">actionlist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evalue les opportunités de mouvement</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="c1"># Les listes contenant les 4 options adjacentes</span>
        <span class="n">firstlist</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;first_adj&quot;</span><span class="p">)</span>
        <span class="n">bonuslist</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;bonus_adj&quot;</span><span class="p">)</span>
        <span class="n">otherlist</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;other_adj&quot;</span><span class="p">)</span>
        <span class="c1"># 1- Cas particulier d&#39;un bonus à prendre :</span>
        <span class="n">case</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">need_bonus</span><span class="p">:</span>
            <span class="n">case</span> <span class="o">=</span> <span class="s2">&quot;need_bonus&quot;</span>
            <span class="n">case_bonus</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">firstlist</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">firstlist</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_BONUS</span><span class="p">:</span>
                        <span class="n">case_bonus</span> <span class="o">=</span> <span class="n">c</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="n">case_bonus</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bonuslist</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">case_bonus</span> <span class="o">=</span> <span class="n">bonuslist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">case_bonus</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">actdict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_MOVE</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;violence&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_simple_action</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">actdict</span><span class="p">,</span> <span class="n">case_bonus</span><span class="p">)</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
        <span class="c1"># 2- Cas général :</span>
        <span class="c1"># doit on faire le ménage?</span>
        <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">case</span> <span class="o">=</span> <span class="s2">&quot;terraform&quot;</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terraform_to_move</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
        <span class="c1"># recherche dans la liste principale, les bonus puis la liste secondaire :</span>
        <span class="k">if</span> <span class="n">firstlist</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cmd</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">case</span> <span class="o">=</span> <span class="s2">&quot;firstlist&quot;</span>
            <span class="c1"># peut on bouger sur une des cases prioritaires?</span>
            <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">firstlist</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">actdict</span> <span class="ow">in</span> <span class="n">actionlist</span><span class="p">:</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_simple_action</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">actdict</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="c1"># peut-on faire le ménage?</span>
            <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">robot</span><span class="o">.</span><span class="n">has_grenade</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">firstlist</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">case</span><span class="p">)</span> <span class="o">==</span> <span class="n">CaseDanger</span> <span class="ow">and</span> <span class="n">case</span><span class="o">.</span><span class="n">danger_impact</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_complex_action</span><span class="p">(</span>
                            <span class="n">robot</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_GRENADE</span><span class="p">,</span> <span class="n">case</span>
                        <span class="p">)</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">break</span>
        <span class="k">if</span> <span class="n">bonuslist</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cmd</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">case</span> <span class="o">=</span> <span class="s2">&quot;bonuslist&quot;</span>
            <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">bonuslist</span><span class="p">:</span>
                <span class="n">actdict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_MOVE</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_simple_action</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">actdict</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="n">otherlist</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cmd</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">case</span> <span class="o">=</span> <span class="s2">&quot;otherlist&quot;</span>
            <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">otherlist</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">actdict</span> <span class="ow">in</span> <span class="n">actionlist</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">actdict</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_GRENADE</span><span class="p">:</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_complex_action</span><span class="p">(</span>
                            <span class="n">robot</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_GRENADE</span><span class="p">,</span> <span class="n">case</span>
                        <span class="p">)</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_simple_action</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">actdict</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="c1"># retour</span>
        <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">case</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
        <span class="k">return</span> <span class="n">cmd</span>

    <span class="k">def</span> <span class="nf">_search_next_command_random</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">actionlist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Commande aléatoire</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">listadj</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;all_adj&quot;</span><span class="p">)</span>
        <span class="c1"># recherche :</span>
        <span class="k">for</span> <span class="n">actdict</span> <span class="ow">in</span> <span class="n">actionlist</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">actdict</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_GRENADE</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_random_launch_grenade</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">listadj</span><span class="p">:</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_simple_action</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">actdict</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_check_or_nullify_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">robot</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="c1"># retour :</span>
        <span class="k">return</span> <span class="n">cmd</span>

    <span class="c1">#-----&gt; B.9- Outils communs aux recherches de commande</span>
    <span class="k">def</span> <span class="nf">_terraform_to_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Etudie l&#39;opportunité de faire le ménage avant de bouger</span>
<span class="sd">        Retour : cmd ou None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Condition préalable :</span>
        <span class="n">midEFF</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;efficacite&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">efficacite</span> <span class="o">&lt;</span> <span class="n">midEFF</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># profondeur de recherche</span>
        <span class="n">fullsearch</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">recursive</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">highQI</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;intelligence&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">intelligence</span> <span class="o">&gt;=</span> <span class="n">highQI</span><span class="p">:</span>
            <span class="n">recursive</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">need_bonus</span><span class="p">:</span>
                <span class="c1"># recherche de toutes les combinaisons de terraformage pour</span>
                <span class="c1"># limiter la destruction de bonus</span>
                <span class="n">fullsearch</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Traitement</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># 1- Cas particulier de l&#39;approche de la sortie :</span>
        <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_WINNER</span><span class="p">,</span>
            <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_HUNTER</span><span class="p">,</span>
        <span class="p">]</span> <span class="ow">and</span> <span class="n">robot</span><span class="o">.</span><span class="n">game_phasis</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">CommandManager</span><span class="o">.</span><span class="n">PHASIS_APPROACH</span><span class="p">,</span>
            <span class="n">CommandManager</span><span class="o">.</span><span class="n">PHASIS_FINAL</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="c1"># Des dangers bloquent ils la sortie ?</span>
            <span class="n">dgrnearsortie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_dangers_block_sortie</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dgrnearsortie</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># recherche poussée :</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_cmd_in_terraform_list</span><span class="p">(</span>
                    <span class="n">robot</span><span class="p">,</span>
                    <span class="n">dgrnearsortie</span><span class="p">,</span>
                    <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span>
                    <span class="n">fullsearch</span><span class="o">=</span><span class="n">fullsearch</span><span class="p">,</span>
                    <span class="n">fardangeronly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="c1"># 2- Recherche dans le targetpath :</span>
        <span class="n">worktarget</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">temptarget</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_temp_target</span><span class="p">()</span>
        <span class="n">mainTarget</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_main_target</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">temptarget</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">worktarget</span> <span class="o">=</span> <span class="n">temptarget</span>
        <span class="k">elif</span> <span class="n">mainTarget</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">worktarget</span> <span class="o">=</span> <span class="n">mainTarget</span>
        <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">worktarget</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">targetpath</span> <span class="o">=</span> <span class="n">worktarget</span><span class="o">.</span><span class="n">targetpath</span>
            <span class="k">if</span> <span class="n">targetpath</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ontheline</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">worktarget</span><span class="o">.</span><span class="n">axe</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">AXIS_X</span> <span class="ow">and</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span> <span class="o">==</span> <span class="n">worktarget</span><span class="o">.</span><span class="n">y</span>
                <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">worktarget</span><span class="o">.</span><span class="n">axe</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">AXIS_Y</span> <span class="ow">and</span> <span class="n">robot</span><span class="o">.</span><span class="n">x</span> <span class="o">==</span> <span class="n">worktarget</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ontheline</span><span class="p">:</span>
                    <span class="c1"># nettoyage du chemin vers la cible</span>
                    <span class="n">stepslist</span> <span class="o">=</span> <span class="n">worktarget</span><span class="o">.</span><span class="n">targetpath</span><span class="o">.</span><span class="n">get_steps_list</span><span class="p">()</span>
                    <span class="n">pathlist</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">tps</span><span class="o">.</span><span class="n">case</span>
                        <span class="k">for</span> <span class="n">tps</span> <span class="ow">in</span> <span class="n">stepslist</span>
                        <span class="k">if</span> <span class="n">tps</span><span class="o">.</span><span class="n">case</span> <span class="o">!=</span> <span class="n">robot</span>
                        <span class="ow">and</span> <span class="n">tps</span><span class="o">.</span><span class="n">case</span><span class="o">.</span><span class="n">type_case</span>
                        <span class="ow">in</span> <span class="p">[</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_MUR</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_DANGER</span><span class="p">]</span>
                    <span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pathlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_cmd_in_terraform_list</span><span class="p">(</span>
                            <span class="n">robot</span><span class="p">,</span> <span class="n">pathlist</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span> <span class="n">fullsearch</span><span class="o">=</span><span class="n">fullsearch</span>
                        <span class="p">)</span>
        <span class="c1"># 3- Recherche dans la direction de la cible si elle est principale</span>
        <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">maindirs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dirs_to_mainTarget</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">worktarget</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">worktarget</span><span class="o">.</span><span class="n">direct</span> <span class="ow">in</span> <span class="n">maindirs</span><span class="p">:</span>
                <span class="n">direct</span> <span class="o">=</span> <span class="n">worktarget</span><span class="o">.</span><span class="n">direct</span>
                <span class="n">nextcases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_next_cases_in_dir</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">direct</span><span class="p">)</span>
                <span class="n">directlist</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">nextcases</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_DANGER</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">directlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_cmd_in_terraform_list</span><span class="p">(</span>
                        <span class="n">robot</span><span class="p">,</span>
                        <span class="n">directlist</span><span class="p">,</span>
                        <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span>
                        <span class="n">fullsearch</span><span class="o">=</span><span class="n">fullsearch</span><span class="p">,</span>
                        <span class="n">fardangeronly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="c1"># Retour :</span>
        <span class="k">return</span> <span class="n">cmd</span>

    <span class="k">def</span> <span class="nf">_search_cmd_in_terraform_list</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">robot</span><span class="p">,</span>
        <span class="n">listcases</span><span class="p">,</span>
        <span class="n">fardangeronly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">safemode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fullsearch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">allowcollatdamage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">directonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recherche des cases murs ou dangers à éliminer en priorité dans</span>
<span class="sd">        la liste.</span>
<span class="sd">        </span>
<span class="sd">        * listcases : liste de cases mur ou danger</span>
<span class="sd">        * recursive : recherche l&#39;intégralité des combinaisons (récursion comprise)</span>
<span class="sd">        * safemode : respect ou non de l&#39;instinct de survie du robot</span>
<span class="sd">        * fullsearch : recherche l&#39;ensemble des combinaisons simples (non récursives par défaut)</span>
<span class="sd">        * allowcollatdamage : similaire à safemode, pour surcharger l&#39;empathie</span>
<span class="sd">          du bot et permettre des dégâts collatéraux</span>
<span class="sd">        * directonly : limite la recherche aux coups directs</span>
<span class="sd">        </span>
<span class="sd">        Retourne une cmd ou None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">botradius</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_danger_radius</span><span class="p">()</span>
        <span class="n">maxdist</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">robot</span><span class="o">.</span><span class="n">efficacite</span>  <span class="c1"># distance maxi considérée</span>
        <span class="c1"># Liste de dicts {&quot;case&quot;:, &quot;distance&quot;:, &quot;impact&quot;:}</span>
        <span class="n">dictlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">listcases</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_DANGER</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get_danger_radius</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;=</span> <span class="nb">min</span><span class="p">(</span><span class="n">botradius</span><span class="p">,</span> <span class="n">maxdist</span><span class="p">):</span>
                <span class="n">dictlist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s2">&quot;distance&quot;</span><span class="p">:</span> <span class="n">d</span><span class="p">,</span> <span class="s2">&quot;impact&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">})</span>
        <span class="n">dictlist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;distance&quot;</span><span class="p">))</span>
        <span class="c1"># 1- Cases proches ralentissant le robot :</span>
        <span class="n">nearfactor</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fardangeronly</span><span class="p">:</span>
            <span class="n">neardictlist</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">cdict</span> <span class="k">for</span> <span class="n">cdict</span> <span class="ow">in</span> <span class="n">dictlist</span> <span class="k">if</span> <span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">nearfactor</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neardictlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># recherche rapide :</span>
                <span class="n">cible</span> <span class="o">=</span> <span class="n">neardictlist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;case&quot;</span><span class="p">]</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_complex_action</span><span class="p">(</span>
                    <span class="n">robot</span><span class="p">,</span>
                    <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_GRENADE</span><span class="p">,</span>
                    <span class="n">cible</span><span class="p">,</span>
                    <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span>
                    <span class="n">safemode</span><span class="o">=</span><span class="n">safemode</span><span class="p">,</span>
                    <span class="n">fullsearch</span><span class="o">=</span><span class="n">fullsearch</span><span class="p">,</span>
                    <span class="n">allowcollatdamage</span><span class="o">=</span><span class="n">allowcollatdamage</span><span class="p">,</span>
                    <span class="n">directonly</span><span class="o">=</span><span class="n">directonly</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">neardictlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># recherche plus poussée :</span>
                <span class="c1"># directions associées :</span>
                <span class="n">listdirect</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">cdict</span> <span class="ow">in</span> <span class="n">neardictlist</span><span class="p">:</span>
                    <span class="n">direct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dir_for_case</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">direct</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">listdirect</span><span class="p">:</span>
                        <span class="n">listdirect</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">direct</span><span class="p">)</span>
                <span class="c1"># évaluation des directions :</span>
                <span class="n">evaldirectlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">direct</span> <span class="ow">in</span> <span class="n">listdirect</span><span class="p">:</span>
                    <span class="c1"># toutes les cases pouvant être atteintes (certaines combinaisons</span>
                    <span class="c1"># associées peuvent être fatales au robot)</span>
                    <span class="n">casesimpactees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_cases_reachable_by_grenade_in_dir</span><span class="p">(</span>
                        <span class="n">robot</span><span class="p">,</span> <span class="n">direct</span>
                    <span class="p">)</span>
                    <span class="n">nb</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">cdict</span> <span class="ow">in</span> <span class="n">neardictlist</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">casesimpactees</span><span class="p">:</span>
                            <span class="n">nb</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">evaldirectlist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;direct&quot;</span><span class="p">:</span> <span class="n">direct</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">nb</span><span class="p">})</span>
                <span class="c1"># choix de la meilleure direction :</span>
                <span class="n">evaldirectlist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">bestdirect</span> <span class="o">=</span> <span class="n">evaldirectlist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;direct&quot;</span><span class="p">]</span>
                <span class="c1"># choix d&#39;une cible (distance = moitié du rayon d&#39;action du robot)</span>
                <span class="n">pas</span> <span class="o">=</span> <span class="n">botradius</span> <span class="o">//</span> <span class="mi">2</span>
                <span class="n">cible</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">while</span> <span class="n">pas</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cible</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_case_for_dir_and_pas</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">bestdirect</span><span class="p">,</span> <span class="n">pas</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cible</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">pas</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">cible</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_complex_action</span><span class="p">(</span>
                        <span class="n">robot</span><span class="p">,</span>
                        <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_GRENADE</span><span class="p">,</span>
                        <span class="n">cible</span><span class="p">,</span>
                        <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span>
                        <span class="n">safemode</span><span class="o">=</span><span class="n">safemode</span><span class="p">,</span>
                        <span class="n">fullsearch</span><span class="o">=</span><span class="n">fullsearch</span><span class="p">,</span>
                        <span class="n">allowcollatdamage</span><span class="o">=</span><span class="n">allowcollatdamage</span><span class="p">,</span>
                        <span class="n">directonly</span><span class="o">=</span><span class="n">directonly</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="c1"># la commande a t&#39;elle du sens?</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_params_for_grenade</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">cible</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">params</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">casesimpactees</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">][</span><span class="s2">&quot;cases_impactees&quot;</span><span class="p">]</span>
                        <span class="n">nb</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">cdict</span> <span class="ow">in</span> <span class="n">neardictlist</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">casesimpactees</span><span class="p">:</span>
                                <span class="n">nb</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">nb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">cmd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># 2- Dangers éloignés pouvant libérer de l&#39;espace pour les coups prochains :</span>
        <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">fardangeronly</span><span class="p">:</span>
            <span class="n">dgrdictlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">cdict</span> <span class="ow">in</span> <span class="n">dictlist</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">nearfactor</span> <span class="ow">and</span> <span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;impact&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">dgrdictlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cdict</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dgrdictlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># on commence par le danger le plus puissant :</span>
                <span class="n">dgrdictlist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;impact&quot;</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">dgrdict</span> <span class="ow">in</span> <span class="n">dgrdictlist</span><span class="p">:</span>
                    <span class="n">cible</span> <span class="o">=</span> <span class="n">dgrdict</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_complex_action</span><span class="p">(</span>
                        <span class="n">robot</span><span class="p">,</span>
                        <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_GRENADE</span><span class="p">,</span>
                        <span class="n">cible</span><span class="p">,</span>
                        <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span>
                        <span class="n">safemode</span><span class="o">=</span><span class="n">safemode</span><span class="p">,</span>
                        <span class="n">fullsearch</span><span class="o">=</span><span class="n">fullsearch</span><span class="p">,</span>
                        <span class="n">allowcollatdamage</span><span class="o">=</span><span class="n">allowcollatdamage</span><span class="p">,</span>
                        <span class="n">directonly</span><span class="o">=</span><span class="n">directonly</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">break</span>
        <span class="c1"># Retour :</span>
        <span class="k">return</span> <span class="n">cmd</span>

    <span class="k">def</span> <span class="nf">_do_dangers_block_sortie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retourne la liste des cases dangers à proximité de la sortie, triées</span>
<span class="sd">        par distance croissante à la sortie</span>
<span class="sd">        critère : distance &lt;= CommandManager.DIST_APPROACH</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># données carto</span>
        <span class="n">case_sortie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_case_sortie</span><span class="p">()</span>
        <span class="n">dist_bot_sortie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">case_sortie</span><span class="p">)</span>
        <span class="n">list_dgrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dangers_set_plus1</span>
        <span class="c1"># réduction de la liste :</span>
        <span class="n">dfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">case_sortie</span><span class="p">)</span>
        <span class="n">fulllist</span> <span class="o">=</span> <span class="p">[(</span><span class="n">dgr</span><span class="p">,</span> <span class="n">dfunc</span><span class="p">(</span><span class="n">dgr</span><span class="p">))</span> <span class="k">for</span> <span class="n">dgr</span> <span class="ow">in</span> <span class="n">list_dgrs</span><span class="p">]</span>
        <span class="n">dist_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dist_bot_sortie</span><span class="p">,</span> <span class="n">CommandManager</span><span class="o">.</span><span class="n">DIST_APPROACH</span><span class="p">)</span>
        <span class="n">redlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">fulllist</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dist_max</span><span class="p">]</span>
        <span class="n">redlist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">redlist</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_evaluate_simple_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">actiondict</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">handlebehavior</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retourne la commande si l&#39;action est possible et conforme au comportement</span>
<span class="sd">        du robot (si handlebehavior=True), None sinon.</span>
<span class="sd">        Prend en charge toutes les actions sur des cases adjacentes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">possible</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_possible_todo_ACTION_on_case</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="n">actiondict</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span> <span class="n">robot</span><span class="p">)</span>
        <span class="n">conform</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">handlebehavior</span> <span class="ow">and</span> <span class="n">possible</span><span class="p">:</span>
            <span class="n">conform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_action_conform_to_behavior</span><span class="p">(</span>
                <span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">actiondict</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">possible</span> <span class="ow">and</span> <span class="n">conform</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">actiondict</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dir_cmd_for_case</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">action</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">direction</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">action</span> <span class="o">+</span> <span class="n">direction</span>
            <span class="k">if</span> <span class="n">actiondict</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_MINE</span><span class="p">:</span>
                <span class="n">puissance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_puissance_mine_for_bot</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
                <span class="n">cmd</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">puissance</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cmd</span>

    <span class="k">def</span> <span class="nf">_get_puissance_mine_for_bot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retourne une puissance de mine</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">puissance</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">list_puissance</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_puissance_list</span><span class="p">(</span><span class="s2">&quot;mine&quot;</span><span class="p">)</span>
        <span class="n">midAGG</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;aggressivite&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
        <span class="n">midEFF</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;efficacite&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
        <span class="n">cond_puissance</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">aggressivite</span> <span class="o">&gt;=</span> <span class="n">midAGG</span> <span class="ow">or</span> <span class="n">robot</span><span class="o">.</span><span class="n">efficacite</span> <span class="o">&gt;=</span> <span class="n">midEFF</span>
        <span class="k">if</span> <span class="n">cond_puissance</span><span class="p">:</span>
            <span class="c1"># max</span>
            <span class="n">puissance</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">list_puissance</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># aléatoire</span>
            <span class="n">puissance</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">CustomRandom</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">list_puissance</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">puissance</span>

    <span class="k">def</span> <span class="nf">_evaluate_complex_action</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">robot</span><span class="p">,</span>
        <span class="n">action</span><span class="p">,</span>
        <span class="n">case</span><span class="p">,</span>
        <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">safemode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fullsearch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">allowcollatdamage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">directonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retourne la commande si l&#39;action est possible et conforme au comportement du robot,</span>
<span class="sd">        None sinon.</span>
<span class="sd">        </span>
<span class="sd">        * recursive : recherche l&#39;intégralité des combinaisons (récursion comprise)</span>
<span class="sd">        * safemode : respect ou non de l&#39;instinct de survie du robot</span>
<span class="sd">        * fullsearch : recherche l&#39;ensemble des combinaisons simples (non récursives par défaut)</span>
<span class="sd">        * allowcollatdamage : similaire à safemode, pour surcharger l&#39;empathie</span>
<span class="sd">          du bot et permettre des dégâts collatéraux</span>
<span class="sd">        * directonly : limite la recherche aux coups directs</span>
<span class="sd">        </span>
<span class="sd">        Prend en charge des actions complexes (ACTION_GRENADE à ce jour)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">!=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_GRENADE</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_params_for_grenade</span><span class="p">(</span>
            <span class="n">robot</span><span class="p">,</span>
            <span class="n">case</span><span class="p">,</span>
            <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span>
            <span class="n">safemode</span><span class="o">=</span><span class="n">safemode</span><span class="p">,</span>
            <span class="n">fullsearch</span><span class="o">=</span><span class="n">fullsearch</span><span class="p">,</span>
            <span class="n">allowcollatdamage</span><span class="o">=</span><span class="n">allowcollatdamage</span><span class="p">,</span>
            <span class="n">directonly</span><span class="o">=</span><span class="n">directonly</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">params</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">defaultcomb</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cmd_from_grenade_combinaison</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">defaultcomb</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cmd</span>

    <span class="k">def</span> <span class="nf">_get_cmd_from_grenade_combinaison</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">combinaison</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retoune une cmd formatée à partir de combinaison, dict de la forme</span>
<span class="sd">        {&quot;cible&quot;:, &quot;portee&quot;:, &quot;puissance&quot;:}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_GRENADE</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dir_cmd_for_case</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">combinaison</span><span class="p">[</span><span class="s2">&quot;cible&quot;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">action</span>
                <span class="o">+</span> <span class="n">direction</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">combinaison</span><span class="p">[</span><span class="s2">&quot;portee&quot;</span><span class="p">])</span>
                <span class="o">+</span> <span class="s2">&quot;-&quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">combinaison</span><span class="p">[</span><span class="s2">&quot;puissance&quot;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cmd</span>

    <span class="k">def</span> <span class="nf">_simple_action_conform_to_behavior</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">danger_impact</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Indique si l&#39;action est cohérente avec le comportement du robot</span>
<span class="sd">        actionargs = {&quot;action&quot;:, &quot;case&quot;:, &quot;danger_impact&quot;:}</span>
<span class="sd">        Ne prend en charge que les actions simples, pour les jets de grenade</span>
<span class="sd">        la conformité est vérifiée dans les méthodes dédiées.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">drc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
        <span class="c1"># l&#39;action est-elle fatale, conforme?</span>
        <span class="n">dodie</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">maydie</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">conform</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_MOVE</span><span class="p">,</span>
            <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_CREATE_WALL</span><span class="p">,</span>
            <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_CREATE_DOOR</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">case</span><span class="p">)</span> <span class="o">==</span> <span class="n">CaseDanger</span><span class="p">:</span>
                <span class="n">dodie</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_MOVE</span><span class="p">:</span>
                <span class="n">safelist</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;safe_adj&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">case</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">safelist</span><span class="p">:</span>
                    <span class="n">maydie</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_KILL</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">case</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="p">:</span>
                <span class="n">kill_all</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;kill_all&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">kill_all</span><span class="p">:</span>
                    <span class="n">conform</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_MINE</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">danger_impact</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">danger_impact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_puissance_mine_for_bot</span><span class="p">(</span><span class="n">robot</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">case</span><span class="p">)</span> <span class="o">==</span> <span class="n">CaseDanger</span><span class="p">:</span>
                <span class="n">radius_case</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">get_danger_radius</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">radius_case</span> <span class="o">&gt;</span> <span class="n">drc</span> <span class="ow">or</span> <span class="n">danger_impact</span> <span class="o">&gt;</span> <span class="n">drc</span><span class="p">:</span>
                    <span class="n">dodie</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># en fonction du comportement:</span>
        <span class="n">midSUR</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;instinct_survie&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
        <span class="n">highSUR</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;instinct_survie&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">instinct_survie</span> <span class="o">&gt;=</span> <span class="n">midSUR</span> <span class="ow">and</span> <span class="n">dodie</span><span class="p">:</span>
            <span class="n">conform</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">robot</span><span class="o">.</span><span class="n">instinct_survie</span> <span class="o">&gt;=</span> <span class="n">highSUR</span> <span class="ow">and</span> <span class="n">maydie</span><span class="p">:</span>
            <span class="n">conform</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">conform</span>

    <span class="k">def</span> <span class="nf">_random_launch_grenade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lancer de gernade au hasard (cohérent avec le facteur de danger du robot)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">robot</span><span class="o">.</span><span class="n">has_grenade</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># paramètres</span>
        <span class="n">list_portee</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">portee_grenade</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">CustomRandom</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">list_portee</span><span class="p">)</span>
        <span class="n">list_puissance</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_puissance_list</span><span class="p">(</span><span class="s2">&quot;grenade&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">CustomRandom</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">list_puissance</span><span class="p">)</span>
        <span class="n">directions</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">LIST_DIRECTIONS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">CustomRandom</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">directions</span><span class="p">)</span>
        <span class="n">finded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># recherche :</span>
        <span class="k">for</span> <span class="n">direct</span> <span class="ow">in</span> <span class="n">directions</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">portee</span> <span class="ow">in</span> <span class="n">list_portee</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">puissance</span> <span class="ow">in</span> <span class="n">list_puissance</span><span class="p">:</span>
                    <span class="c1"># combinaison :</span>
                    <span class="n">cible</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_case_for_dir_and_pas</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">direct</span><span class="p">,</span> <span class="n">portee</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cible</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cible</span><span class="o">.</span><span class="n">type_case</span> <span class="ow">in</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_GRENADE</span><span class="p">:</span>
                        <span class="n">comb</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;cible&quot;</span><span class="p">:</span> <span class="n">cible</span><span class="p">,</span>
                            <span class="s2">&quot;portee&quot;</span><span class="p">:</span> <span class="n">portee</span><span class="p">,</span>
                            <span class="s2">&quot;puissance&quot;</span><span class="p">:</span> <span class="n">puissance</span><span class="p">,</span>
                        <span class="p">}</span>
                        <span class="n">valide</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_complete_and_valide_grenade_combinaison</span><span class="p">(</span>
                            <span class="n">robot</span><span class="p">,</span> <span class="n">cible</span><span class="p">,</span> <span class="n">comb</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">valide</span><span class="p">:</span>
                            <span class="n">listchardir</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_TOP</span><span class="p">,</span>
                                <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_BOTTOM</span><span class="p">,</span>
                                <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_LEFT</span><span class="p">,</span>
                                <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_RIGHT</span><span class="p">,</span>
                            <span class="p">]</span>
                            <span class="n">listdir</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="n">LabHelper</span><span class="o">.</span><span class="n">TOP</span><span class="p">,</span>
                                <span class="n">LabHelper</span><span class="o">.</span><span class="n">BOTTOM</span><span class="p">,</span>
                                <span class="n">LabHelper</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span>
                                <span class="n">LabHelper</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">,</span>
                            <span class="p">]</span>
                            <span class="n">indice</span> <span class="o">=</span> <span class="n">listdir</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">direct</span><span class="p">)</span>
                            <span class="n">chardir</span> <span class="o">=</span> <span class="n">listchardir</span><span class="p">[</span><span class="n">indice</span><span class="p">]</span>
                            <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_TXT_GRENADE</span>
                                <span class="o">+</span> <span class="n">chardir</span>
                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">portee</span><span class="p">)</span>
                                <span class="o">+</span> <span class="s2">&quot;-&quot;</span>
                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">puissance</span><span class="p">)</span>
                            <span class="p">)</span>
                            <span class="n">finded</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="n">finded</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">finded</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="c1"># retour</span>
        <span class="k">return</span> <span class="n">cmd</span>

    <span class="c1">#-----&gt; B.10- Outils liés au comportement</span>
    <span class="k">def</span> <span class="nf">_may_firstbot_attack_otherbot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">firstbot</span><span class="p">,</span> <span class="n">otherbot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyse si firstbot peut attaquer otherbot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">possible</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># 1- attaque :</span>
        <span class="c1"># facteur de danger associé à firstbot</span>
        <span class="n">fb_dgrfactor</span> <span class="o">=</span> <span class="n">firstbot</span><span class="o">.</span><span class="n">get_danger_factor_for_bot</span><span class="p">(</span><span class="n">otherbot</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fb_dgrfactor</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># psychopathe : danger certain</span>
            <span class="n">possible</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">fb_dgrfactor</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># danger possible :</span>
            <span class="c1"># - cas d&#39;un winner aggressif et ambitieux / adversaire en avance</span>
            <span class="c1"># - cas d&#39;un bot aggressif et efficace qui peut terraformer</span>
            <span class="n">possible</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># 2- défense:</span>
        <span class="n">midSUR</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;instinct_survie&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
        <span class="n">highSUR</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;instinct_survie&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">)</span>
        <span class="c1"># facteur de danger associé à otherbot</span>
        <span class="n">ob_dgrfactor</span> <span class="o">=</span> <span class="n">otherbot</span><span class="o">.</span><span class="n">get_danger_factor_for_bot</span><span class="p">(</span><span class="n">firstbot</span><span class="p">)</span>
        <span class="c1"># &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ob_dgrfactor</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">firstbot</span><span class="o">.</span><span class="n">instinct_survie</span> <span class="o">&gt;=</span> <span class="n">midSUR</span><span class="p">:</span>
            <span class="c1"># niveau de défense minimal</span>
            <span class="n">possible</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">ob_dgrfactor</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">firstbot</span><span class="o">.</span><span class="n">instinct_survie</span> <span class="o">&gt;=</span> <span class="n">highSUR</span><span class="p">:</span>
            <span class="c1"># niveau de défense avancé</span>
            <span class="n">possible</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ob_dgrfactor</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">fb_dgrfactor</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">possible</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># retour</span>
        <span class="k">return</span> <span class="n">possible</span>

    <span class="k">def</span> <span class="nf">_possible_todo_ACTION_on_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Indique si une case peut faire l&#39;objet d&#39;une action de la part de l&#39;éventuel robot</span>
<span class="sd">        Rq : LabHelper.ACTION_GRENADE non prise en charge par cette méthode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">possible</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_MOVE</span><span class="p">:</span>
            <span class="n">famille</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_MOVE</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_CREATE_DOOR</span><span class="p">:</span>
            <span class="n">famille</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_BUILD_DOOR</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_CREATE_WALL</span><span class="p">:</span>
            <span class="n">famille</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_BUILD_WALL</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_KILL</span><span class="p">:</span>
            <span class="n">famille</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_KILL</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">ACTION_MINE</span><span class="p">:</span>
            <span class="n">famille</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_MINE</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">has_mine</span> <span class="ow">and</span> <span class="n">robot</span><span class="o">.</span><span class="n">puissance_mine</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">cond</span> <span class="ow">and</span> <span class="n">case</span><span class="o">.</span><span class="n">type_case</span> <span class="ow">in</span> <span class="n">famille</span><span class="p">:</span>
            <span class="n">possible</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># cas particuliers :</span>
        <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_HUNTER</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">case_sets_updated</span><span class="p">:</span>
                <span class="c1"># cas particulier d&#39;un client</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_usefull_sets</span><span class="p">()</span>
            <span class="n">case_sortie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_case_sortie</span><span class="p">()</span>
            <span class="n">other_alive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alive_bots</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hunter_alive</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="n">case_sortie</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_alive</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># tant qu&#39;il y a du monde à éliminer</span>
                <span class="n">possible</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># retour</span>
        <span class="k">return</span> <span class="n">possible</span>

    <span class="c1">#-----&gt; B.11- Gestion de lancer de grenade</span>
    <span class="k">def</span> <span class="nf">_get_params_for_grenade</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">robot</span><span class="p">,</span>
        <span class="n">case</span><span class="p">,</span>
        <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">safemode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fullsearch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">allowcollatdamage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">directonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recherche la meilleure combinaison de lancer de grenade pour atteindre</span>
<span class="sd">        case depuis la position actuelle du robot.</span>
<span class="sd">           </span>
<span class="sd">        * recursive : recherche l&#39;intégralité des combinaisons (récursion comprise)</span>
<span class="sd">        * safemode : respect ou non de l&#39;instinct de survie du robot</span>
<span class="sd">        * fullsearch : recherche l&#39;ensemble des combinaisons simples (non récursives par défaut)</span>
<span class="sd">        * allowcollatdamage : similaire à safemode, pour surcharger l&#39;empathie</span>
<span class="sd">          du bot et permettre des dégâts collatéraux</span>
<span class="sd">        * directonly : limite la recherche aux coups directs</span>
<span class="sd">        </span>
<span class="sd">        Retourne :</span>
<span class="sd">        </span>
<span class="sd">        * le dict {&quot;finded&quot;:, &quot;default&quot;:, &quot;combinaisons&quot;:} permettant au</span>
<span class="sd">          robot de détruire la case par un lancer de grenade. default est la</span>
<span class="sd">          solution à priori adapée au robot, combinaisons comprend la liste</span>
<span class="sd">          des combinaisons possibles pour un choix particulier.</span>
<span class="sd">        * None si c&#39;est impossible</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">has_grenade</span> <span class="ow">and</span> <span class="n">robot</span><span class="o">.</span><span class="n">puissance_grenade</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="n">robot</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># Recherche en cache ou calcul des combinaisons possibles et</span>
        <span class="c1"># des paramètres adaptés au robot</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_grenade_combinaisons</span><span class="p">(</span>
            <span class="n">robot</span><span class="p">,</span>
            <span class="n">case</span><span class="p">,</span>
            <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span>
            <span class="n">safemode</span><span class="o">=</span><span class="n">safemode</span><span class="p">,</span>
            <span class="n">fullsearch</span><span class="o">=</span><span class="n">fullsearch</span><span class="p">,</span>
            <span class="n">allowcollatdamage</span><span class="o">=</span><span class="n">allowcollatdamage</span><span class="p">,</span>
            <span class="n">directonly</span><span class="o">=</span><span class="n">directonly</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;finded&quot;</span><span class="p">]:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">params</span>

    <span class="k">def</span> <span class="nf">_get_params_for_grenade_and_listcases</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">robot</span><span class="p">,</span>
        <span class="n">listcases</span><span class="p">,</span>
        <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">safemode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fullsearch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">allowcollatdamage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">directonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tente de trouver une combinaison permettant d&#39;atteindre le maximum de</span>
<span class="sd">        cases de listcases.</span>
<span class="sd">        Méthode de terraformage de haut niveau.</span>
<span class="sd">        Retourne :</span>
<span class="sd">        </span>
<span class="sd">        * le dict {&quot;finded&quot;:, &quot;bestres&quot;:, &quot;bestfirst&quot;:} avec</span>
<span class="sd">        </span>
<span class="sd">            * finded : un boolean indiquant si une solution parfaite existe</span>
<span class="sd">            * bestres : la meilleure solution trouvée au format</span>
<span class="sd">              {&quot;case&quot;:, &quot;combinaison&quot;:, &quot;setmatch&quot;:, &quot;nb&quot;:}</span>
<span class="sd">            * bestfirst : la meilleure solution trouvée comprenant la</span>
<span class="sd">              première case de listcases au même format ou None</span>
<span class="sd">            </span>
<span class="sd">        * ou None</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">robot</span><span class="o">.</span><span class="n">has_grenade</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">listcases</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># cache ?</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="n">listcases</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">))</span>
        <span class="n">casescoords</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">listcases</span><span class="p">]</span>
        <span class="n">keycoords</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">casescoords</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
            <span class="n">keycoords</span><span class="p">,</span>
            <span class="n">recursive</span><span class="p">,</span>
            <span class="n">safemode</span><span class="p">,</span>
            <span class="n">fullsearch</span><span class="p">,</span>
            <span class="n">allowcollatdamage</span><span class="p">,</span>
            <span class="n">directonly</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">cached_params</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_params_grenade_in_cache</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached_params</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># recherche déja effectuée</span>
            <span class="k">if</span> <span class="n">cached_params</span><span class="p">[</span><span class="s2">&quot;finded&quot;</span><span class="p">]:</span>
                <span class="c1"># résultat trouvé</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">cached_params</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Liste de dicts de résultats</span>
            <span class="n">resdictlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">setcases</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">listcases</span><span class="p">)</span>
            <span class="c1"># recherche case à case</span>
            <span class="n">finded</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">listcases</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="n">robot</span><span class="p">:</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_grenade_combinaisons</span><span class="p">(</span>
                        <span class="n">robot</span><span class="p">,</span>
                        <span class="n">c</span><span class="p">,</span>
                        <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span>
                        <span class="n">safemode</span><span class="o">=</span><span class="n">safemode</span><span class="p">,</span>
                        <span class="n">fullsearch</span><span class="o">=</span><span class="n">fullsearch</span><span class="p">,</span>
                        <span class="n">allowcollatdamage</span><span class="o">=</span><span class="n">allowcollatdamage</span><span class="p">,</span>
                        <span class="n">directonly</span><span class="o">=</span><span class="n">directonly</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;finded&quot;</span><span class="p">]:</span>
                        <span class="n">combinaisons</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;combinaisons&quot;</span><span class="p">]</span>
                        <span class="c1"># analyse des combinaisons :</span>
                        <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="n">combinaisons</span><span class="p">:</span>
                            <span class="n">set_impacted</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">comb</span><span class="p">[</span><span class="s2">&quot;cases_impactees&quot;</span><span class="p">])</span>
                            <span class="n">set_match</span> <span class="o">=</span> <span class="n">set_impacted</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">setcases</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">set_match</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span>
                                    <span class="s2">&quot;combinaison&quot;</span><span class="p">:</span> <span class="n">comb</span><span class="p">,</span>
                                    <span class="s2">&quot;setmatch&quot;</span><span class="p">:</span> <span class="n">set_match</span><span class="p">,</span>
                                    <span class="s2">&quot;nb&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">set_match</span><span class="p">),</span>
                                <span class="p">}</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">set_match</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">setcases</span><span class="p">):</span>
                                    <span class="c1"># solution parfaite trouvée</span>
                                    <span class="n">resdictlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">res</span><span class="p">]</span>
                                    <span class="n">finded</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">break</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">resdictlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">finded</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="c1"># Meilleur résultat</span>
            <span class="n">bestres</span> <span class="o">=</span> <span class="n">bestfirst</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resdictlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># trie par nombre de matchs</span>
                <span class="n">resdictlist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;nb&quot;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">bestres</span> <span class="o">=</span> <span class="n">resdictlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># meilleur résultat comprenant la première case de la liste</span>
                <span class="n">firstc</span> <span class="o">=</span> <span class="n">listcases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">resdict</span> <span class="ow">in</span> <span class="n">resdictlist</span><span class="p">:</span>
                    <span class="n">setmatch</span> <span class="o">=</span> <span class="n">resdict</span><span class="p">[</span><span class="s2">&quot;setmatch&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">firstc</span> <span class="ow">in</span> <span class="n">setmatch</span><span class="p">:</span>
                        <span class="n">bestfirst</span> <span class="o">=</span> <span class="n">resdict</span>
                        <span class="k">break</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;finded&quot;</span><span class="p">:</span> <span class="n">finded</span><span class="p">,</span> <span class="s2">&quot;bestres&quot;</span><span class="p">:</span> <span class="n">bestres</span><span class="p">,</span> <span class="s2">&quot;bestfirst&quot;</span><span class="p">:</span> <span class="n">bestfirst</span><span class="p">}</span>
            <span class="c1"># mise en cache :</span>
            <span class="n">gdSet</span><span class="o">.</span><span class="n">cache_params_grenade</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">params</span>

    <span class="k">def</span> <span class="nf">_search_grenade_combinaisons</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">robot</span><span class="p">,</span>
        <span class="n">case</span><span class="p">,</span>
        <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">safemode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fullsearch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">allowcollatdamage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">directonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recherche l&#39;ensemble des combinaisons de lancé de grenade.</span>
<span class="sd">        Crée ou complète l&#39;objet GambleDataSet du robot pour mettre en cache</span>
<span class="sd">        les principaux résultats.</span>
<span class="sd">        Retourne le dict :</span>
<span class="sd">        {&quot;finded&quot;:, &quot;default&quot;:, &quot;combinaisons&quot;:}</span>
<span class="sd">        </span>
<span class="sd">        avec combinaisons une liste de dicts</span>
<span class="sd">        {&quot;cible&quot;:, &quot;realportee&quot;:, &quot;puissance&quot;:,&quot;cases_impactees&quot;:,</span>
<span class="sd">        &quot;destruction&quot;:, &quot;dangers&quot;:, &quot;bonus&quot;:, &quot;robots&quot;:, &quot;murs&quot;:} valides</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># cache ?</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">gdSet</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># permet la mise en cache des données</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">register_current_gdSet</span><span class="p">(</span><span class="n">GambleDataSet</span><span class="p">())</span>
        <span class="n">k</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
            <span class="n">case</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="n">case</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
            <span class="n">recursive</span><span class="p">,</span>
            <span class="n">safemode</span><span class="p">,</span>
            <span class="n">fullsearch</span><span class="p">,</span>
            <span class="n">allowcollatdamage</span><span class="p">,</span>
            <span class="n">directonly</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_params_grenade_in_cache</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">params</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Recherche :</span>
            <span class="n">combinaisons</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">result_finded</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># Condition de trie par puissance : à revoir</span>
            <span class="n">midAGG</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;aggressivite&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
            <span class="n">midEFF</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;efficacite&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
            <span class="n">cond_puissance</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">aggressivite</span> <span class="o">&gt;=</span> <span class="n">midAGG</span> <span class="ow">or</span> <span class="n">robot</span><span class="o">.</span><span class="n">efficacite</span> <span class="o">&gt;=</span> <span class="n">midEFF</span>
            <span class="c1"># 1- Recherche de combinaisons par lancer direct :</span>
            <span class="c1"># récupération d&#39;une liste de dicts {&quot;cible&quot;:, &quot;portee&quot;:, &quot;puissance&quot;:}</span>
            <span class="n">directlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direct_grenade_parameters_search</span><span class="p">(</span>
                <span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">safemode</span><span class="o">=</span><span class="n">safemode</span><span class="p">,</span> <span class="n">fullsearch</span><span class="o">=</span><span class="n">fullsearch</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">directlist</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Trie en fonction du comportement :</span>
                <span class="k">if</span> <span class="n">cond_puissance</span><span class="p">:</span>
                    <span class="n">directlist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;puissance&quot;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">directlist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;puissance&quot;</span><span class="p">))</span>
                <span class="c1"># Validation des combinaisons, complétion des dicts avec les clefs</span>
                <span class="c1"># cases_impactees, destruction, dangers, bonus, robots, murs</span>
                <span class="k">for</span> <span class="n">cdict</span> <span class="ow">in</span> <span class="n">directlist</span><span class="p">:</span>
                    <span class="n">valide</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_complete_and_valide_grenade_combinaison</span><span class="p">(</span>
                        <span class="n">robot</span><span class="p">,</span>
                        <span class="n">case</span><span class="p">,</span>
                        <span class="n">cdict</span><span class="p">,</span>
                        <span class="n">safemode</span><span class="o">=</span><span class="n">safemode</span><span class="p">,</span>
                        <span class="n">allowcollatdamage</span><span class="o">=</span><span class="n">allowcollatdamage</span><span class="p">,</span>
                        <span class="n">directonly</span><span class="o">=</span><span class="n">directonly</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">valide</span><span class="p">:</span>
                        <span class="n">combinaisons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cdict</span><span class="p">)</span>
                        <span class="n">result_finded</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">fullsearch</span><span class="p">:</span>
                            <span class="k">break</span>
            <span class="c1"># 2- Recherche de combinaisons &quot;par la bande&quot;</span>
            <span class="c1"># optimisation : on vérifie que la recherche indirecte a du sens</span>
            <span class="c1"># La case est elle dans la zone d&#39;impact d&#39;une mine?</span>
            <span class="n">keepsearching</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_case_surrounded_by_mine</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>
            <span class="c1"># poursuite éventuelle de la recherche</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">keepsearching</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">result_finded</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">fullsearch</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">directonly</span><span class="p">):</span>
                <span class="n">nondirectlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nondirect_grenade_parameters_search</span><span class="p">(</span>
                    <span class="n">robot</span><span class="p">,</span>
                    <span class="n">case</span><span class="p">,</span>
                    <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span>
                    <span class="n">safemode</span><span class="o">=</span><span class="n">safemode</span><span class="p">,</span>
                    <span class="n">fullsearch</span><span class="o">=</span><span class="n">fullsearch</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">nondirectlist</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Trie en fonction du comportement :</span>
                    <span class="k">if</span> <span class="n">cond_puissance</span><span class="p">:</span>
                        <span class="n">nondirectlist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;puissance&quot;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">nondirectlist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;puissance&quot;</span><span class="p">))</span>
                    <span class="c1"># Validation des combinaisons, complétion des dicts avec les clefs</span>
                    <span class="c1"># cases_impactees, destruction, dangers, bonus, robots, murs</span>
                    <span class="k">for</span> <span class="n">cdict</span> <span class="ow">in</span> <span class="n">nondirectlist</span><span class="p">:</span>
                        <span class="n">valide</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_complete_and_valide_grenade_combinaison</span><span class="p">(</span>
                            <span class="n">robot</span><span class="p">,</span>
                            <span class="n">case</span><span class="p">,</span>
                            <span class="n">cdict</span><span class="p">,</span>
                            <span class="n">safemode</span><span class="o">=</span><span class="n">safemode</span><span class="p">,</span>
                            <span class="n">allowcollatdamage</span><span class="o">=</span><span class="n">allowcollatdamage</span><span class="p">,</span>
                            <span class="n">directonly</span><span class="o">=</span><span class="n">directonly</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">valide</span><span class="p">:</span>
                            <span class="n">combinaisons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cdict</span><span class="p">)</span>
                            <span class="n">result_finded</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">fullsearch</span><span class="p">:</span>
                                <span class="k">break</span>
            <span class="c1"># sélection de l&#39;option la plus adaptée</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_grenade_parameters</span><span class="p">(</span>
                <span class="n">robot</span><span class="p">,</span>
                <span class="n">case</span><span class="p">,</span>
                <span class="n">combinaisons</span><span class="p">,</span>
                <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span>
                <span class="n">safemode</span><span class="o">=</span><span class="n">safemode</span><span class="p">,</span>
                <span class="n">fullsearch</span><span class="o">=</span><span class="n">fullsearch</span><span class="p">,</span>
                <span class="n">allowcollatdamage</span><span class="o">=</span><span class="n">allowcollatdamage</span><span class="p">,</span>
                <span class="n">directonly</span><span class="o">=</span><span class="n">directonly</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># mise en cache :</span>
            <span class="n">gdSet</span><span class="o">.</span><span class="n">cache_params_grenade</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="c1"># retour :</span>
        <span class="k">return</span> <span class="n">params</span>

    <span class="k">def</span> <span class="nf">_select_grenade_parameters</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">robot</span><span class="p">,</span>
        <span class="n">case</span><span class="p">,</span>
        <span class="n">combinaisons</span><span class="p">,</span>
        <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">safemode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fullsearch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">allowcollatdamage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">directonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recherche les paramètres de commande les plus adaptés au robot.</span>
<span class="sd">        combinaisons liste générée par _search_grenade_combinaisons.</span>
<span class="sd">        toutes les combinaisons ont été validées au préalable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Analyse :</span>
        <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">combinaisons</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;finded&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># solutions par défaut</span>
            <span class="n">midAGG</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;aggressivite&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
            <span class="n">midEFF</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;efficacite&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">need_bonus</span><span class="p">:</span>
                <span class="c1"># on minimise la destruction de bonus</span>
                <span class="n">combinaisons</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;bonus&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">aggressivite</span> <span class="o">&gt;=</span> <span class="n">midAGG</span> <span class="ow">or</span> <span class="n">robot</span><span class="o">.</span><span class="n">efficacite</span> <span class="o">&gt;=</span> <span class="n">midEFF</span><span class="p">:</span>
                <span class="c1"># destruction décroissante</span>
                <span class="n">combinaisons</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;destruction&quot;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">robot</span><span class="o">.</span><span class="n">behavior</span> <span class="o">==</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">BEHAVIOR_RANDOM</span><span class="p">:</span>
                <span class="c1"># au hasard</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">CustomRandom</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">combinaisons</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># destruction croissante</span>
                <span class="n">combinaisons</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;destruction&quot;</span><span class="p">))</span>
            <span class="c1"># Données :</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;finded&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">combinaisons</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;combinaisons&quot;</span><span class="p">:</span> <span class="n">combinaisons</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">params</span>

    <span class="k">def</span> <span class="nf">_direct_grenade_parameters_search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">safemode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fullsearch</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recherche d&#39;un coup direct : la grenade touche directement la case.</span>
<span class="sd">        </span>
<span class="sd">        * safemode : respect ou non de l&#39;instinct de survie du robot</span>
<span class="sd">        * fullsearch : recherche ou non toutes les combinaisons possibles</span>
<span class="sd">        </span>
<span class="sd">        Rq : les conséquences (cases impactées) ne sont pas calculées.</span>
<span class="sd">        Retourne une liste de dicts {&quot;cible&quot;:, &quot;portee&quot;:, &quot;puissance&quot;:}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">combinaisons</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="c1"># cadre géométrique :</span>
        <span class="n">vecteur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_vector_for_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
        <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">vecteur</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">vecteur</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">D</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">))</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">))</span>
        <span class="c1"># params : portée et puissance</span>
        <span class="n">list_portee</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">portee_grenade</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">portee_max</span> <span class="o">=</span> <span class="n">list_portee</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">list_puissance</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_puissance_list</span><span class="p">(</span><span class="s2">&quot;grenade&quot;</span><span class="p">)</span>
        <span class="c1"># trie en fonction du comportement du robot et de son besoin de bonus :</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">robot</span><span class="o">.</span><span class="n">need_bonus</span><span class="p">:</span>
            <span class="n">midAGG</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;aggressivite&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
            <span class="n">midEFF</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;efficacite&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">aggressivite</span> <span class="o">&gt;=</span> <span class="n">midAGG</span> <span class="ow">or</span> <span class="n">robot</span><span class="o">.</span><span class="n">efficacite</span> <span class="o">&gt;=</span> <span class="n">midEFF</span><span class="p">:</span>
                <span class="n">list_puissance</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Recherche  :</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">d</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">D</span> <span class="o">&gt;</span> <span class="n">portee_max</span> <span class="o">+</span> <span class="mi">2</span><span class="p">):</span>
            <span class="c1"># Rq : cas impossibles sachant que puissance_max &lt;= 25</span>
            <span class="c1"># liste de recherche de cible (sens robot vers case):</span>
            <span class="n">liste</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_segment_for_grenade_search</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
            <span class="n">portee_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">portee_max</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">liste</span><span class="p">)))</span>
            <span class="n">famille</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">FAMILLE_GRENADE</span>
            <span class="c1"># recherche des combinaisons :</span>
            <span class="n">result_finded</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">puissance</span> <span class="ow">in</span> <span class="n">list_puissance</span><span class="p">:</span>
                <span class="n">plist</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># rayon d&#39;action induit par la puissance :</span>
                <span class="n">power_radius</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">puissance</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">power_radius</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">puissance</span> <span class="o">&gt;=</span> <span class="mi">13</span><span class="p">:</span>
                    <span class="n">power_radius</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="c1"># recherche des portées en fonction de la puissance</span>
                <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">puissance</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">D</span> <span class="o">&lt;=</span> <span class="n">portee_max</span><span class="p">:</span>
                        <span class="n">plist</span> <span class="o">=</span> <span class="p">[</span><span class="n">D</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">puissance</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">]:</span>
                        <span class="n">plist</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">D</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">D</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">portee_max</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">puissance</span> <span class="o">&gt;=</span> <span class="mi">13</span><span class="p">:</span>
                        <span class="n">plist</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">D</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">D</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">portee_max</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">puissance</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">D</span> <span class="o">&lt;=</span> <span class="n">portee_max</span><span class="p">:</span>
                        <span class="n">plist</span> <span class="o">=</span> <span class="p">[</span><span class="n">D</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">puissance</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">17</span><span class="p">]:</span>
                        <span class="n">plist</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">D</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">D</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">portee_max</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">puissance</span> <span class="o">==</span> <span class="mi">25</span><span class="p">:</span>
                        <span class="n">plist</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">D</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">D</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">portee_max</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">puissance</span> <span class="o">==</span> <span class="mi">13</span> <span class="ow">and</span> <span class="n">D</span> <span class="o">&lt;=</span> <span class="n">portee_max</span><span class="p">:</span>
                        <span class="n">plist</span> <span class="o">=</span> <span class="p">[</span><span class="n">D</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">puissance</span> <span class="o">==</span> <span class="mi">17</span><span class="p">:</span>
                        <span class="n">plist</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">i</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">D</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">D</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>
                            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">portee_max</span> <span class="ow">and</span> <span class="p">(</span><span class="n">D</span> <span class="o">-</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span>
                        <span class="p">]</span>
                    <span class="k">elif</span> <span class="n">puissance</span> <span class="o">==</span> <span class="mi">25</span><span class="p">:</span>
                        <span class="n">plist</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">D</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">D</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">portee_max</span><span class="p">]</span>
                <span class="c1"># alimentation</span>
                <span class="k">if</span> <span class="n">plist</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plist</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">liste</span><span class="p">):</span>
                            <span class="n">cible</span> <span class="o">=</span> <span class="n">liste</span><span class="p">[</span><span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                            <span class="n">valide</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">safemode</span><span class="p">:</span>
                                <span class="c1"># exclus les tirs immédiatement suicidaires</span>
                                <span class="c1"># attention : les impacts en cascade ne sont pas</span>
                                <span class="c1"># recherchés ici.</span>
                                <span class="n">radius</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">power_radius</span>
                                <span class="k">if</span> <span class="n">radius</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">valide</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">valide</span> <span class="ow">and</span> <span class="n">cible</span><span class="o">.</span><span class="n">type_case</span> <span class="ow">in</span> <span class="n">famille</span><span class="p">:</span>
                                <span class="n">combinaisons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="p">{</span>
                                        <span class="s2">&quot;cible&quot;</span><span class="p">:</span> <span class="n">cible</span><span class="p">,</span>
                                        <span class="s2">&quot;portee&quot;</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span>
                                        <span class="s2">&quot;puissance&quot;</span><span class="p">:</span> <span class="n">puissance</span><span class="p">,</span>
                                    <span class="p">}</span>
                                <span class="p">)</span>
                                <span class="n">result_finded</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">result_finded</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fullsearch</span><span class="p">:</span>
                                <span class="k">break</span>
                <span class="k">if</span> <span class="n">result_finded</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fullsearch</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="c1"># retour :</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">combinaisons</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">combinaisons</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">combinaisons</span>

    <span class="k">def</span> <span class="nf">_nondirect_grenade_parameters_search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">safemode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fullsearch</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recherche d&#39;un coup &quot;par la bande&quot; : peut on atteindre la case en</span>
<span class="sd">        visant une case danger avoisinnante?</span>
<span class="sd">        </span>
<span class="sd">        * recursive : recherche récursive, faux par défaut</span>
<span class="sd">        * safemode : respect ou non de l&#39;instinct de survie du robot</span>
<span class="sd">        * fullsearch : recherche ou non toutes les combinaisons possibles</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># cadre géométrique :</span>
        <span class="n">vecteur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_vector_for_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
        <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span> <span class="o">=</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">vy</span><span class="p">):</span>
            <span class="n">main_sens</span> <span class="o">=</span> <span class="n">vx</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">main_sens</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">main_dir</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">RIGHT</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">main_dir</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">LEFT</span>
            <span class="k">if</span> <span class="n">vy</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">second_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">TOP</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">vy</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">second_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">BOTTOM</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">second_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">TOP</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">BOTTOM</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">main_sens</span> <span class="o">=</span> <span class="n">vy</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">vy</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">main_sens</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">main_dir</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">BOTTOM</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">main_dir</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">TOP</span>
            <span class="k">if</span> <span class="n">vx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">second_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">LEFT</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">vx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">second_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">second_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">]</span>
        <span class="c1"># combinaisons :</span>
        <span class="n">combinaisons</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="c1"># recherche dans la direction principale :</span>
        <span class="c1"># rq : liste_main est un set</span>
        <span class="n">liste_main</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_cases_reachable_by_grenade_in_dir</span><span class="p">(</span>
            <span class="n">robot</span><span class="p">,</span> <span class="n">main_dir</span>
        <span class="p">)</span>
        <span class="n">main_comb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_does_liste_may_impact_case</span><span class="p">(</span>
            <span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">liste_main</span><span class="p">,</span> <span class="n">recursive</span><span class="p">,</span> <span class="n">safemode</span><span class="p">,</span> <span class="n">fullsearch</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">main_comb</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">combinaisons</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">main_comb</span><span class="p">)</span>
        <span class="c1"># recherche dans les directions secondaires :</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">combinaisons</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">fullsearch</span><span class="p">:</span>
            <span class="n">liste_second</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">direct</span> <span class="ow">in</span> <span class="n">second_dirs</span><span class="p">:</span>
                <span class="c1"># rq : l est un set</span>
                <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_cases_reachable_by_grenade_in_dir</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">direct</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">liste_second</span> <span class="o">=</span> <span class="n">liste_second</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="n">second_comb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_does_liste_may_impact_case</span><span class="p">(</span>
                <span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">liste_second</span><span class="p">,</span> <span class="n">recursive</span><span class="p">,</span> <span class="n">safemode</span><span class="p">,</span> <span class="n">fullsearch</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">second_comb</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">combinaisons</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">second_comb</span><span class="p">)</span>
        <span class="c1"># retour :</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">combinaisons</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">combinaisons</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">combinaisons</span>

    <span class="k">def</span> <span class="nf">_is_case_surrounded_by_mine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Vérifie si une case est dans la zone d&#39;impact d&#39;une ou plusieurs mines.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">maybeimpacted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># les mines comprises dans la sous matrice 5*5 centrée sur case :</span>
        <span class="n">minelist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_minelist_arround_case</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>
        <span class="n">minelist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;danger_impact&quot;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># recherche d&#39;impact non récursive :</span>
        <span class="k">for</span> <span class="n">dgr</span> <span class="ow">in</span> <span class="n">minelist</span><span class="p">:</span>
            <span class="n">maybeimpacted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_does_mine_impact_case</span><span class="p">(</span><span class="n">dgr</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">maybeimpacted</span> <span class="ow">or</span> <span class="n">dgr</span><span class="o">.</span><span class="n">danger_impact</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># on s&#39;arrête au premier résultat positif (ou lorsque l&#39;impact</span>
                <span class="c1"># est trop faible)</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">maybeimpacted</span>

    <span class="k">def</span> <span class="nf">_does_liste_may_impact_case</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">listecases</span><span class="p">,</span> <span class="n">recursive</span><span class="p">,</span> <span class="n">safemode</span><span class="p">,</span> <span class="n">fullsearch</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recherche la ou les combinaisons consistant à impacter la case par</span>
<span class="sd">        l&#39;explosion d&#39;un danger contenu dans la liste (le set), via un jet de</span>
<span class="sd">        grenade par le robot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">combinaisons</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">liste_dgr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_and_sort_dangers_for_case</span><span class="p">(</span><span class="n">listecases</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">liste_dgr</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result_finded</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">dgr</span> <span class="ow">in</span> <span class="n">liste_dgr</span><span class="p">:</span>
                <span class="n">done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_does_mine_impact_case</span><span class="p">(</span><span class="n">dgr</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                    <span class="c1"># _direct_grenade_parameters_search ne vérifiant pas l&#39;ensemble</span>
                    <span class="c1"># des cases impactées de façon récursive, le coup peut être</span>
                    <span class="c1"># fatal &quot;par rebond&quot;. A ce stade la première solution qui</span>
                    <span class="c1"># fonctionne suffit (d&#39;où fullsearch=False).</span>
                    <span class="n">comb_for_dgr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direct_grenade_parameters_search</span><span class="p">(</span>
                        <span class="n">robot</span><span class="p">,</span> <span class="n">dgr</span><span class="p">,</span> <span class="n">safemode</span><span class="o">=</span><span class="n">safemode</span><span class="p">,</span> <span class="n">fullsearch</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">comb_for_dgr</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">combinaisons</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">comb_for_dgr</span><span class="p">)</span>
                        <span class="n">result_finded</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">result_finded</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fullsearch</span><span class="p">:</span>
                        <span class="k">break</span>
        <span class="c1"># retour :</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">combinaisons</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">combinaisons</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">combinaisons</span>

    <span class="k">def</span> <span class="nf">_extract_and_sort_dangers_for_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">listecases</span><span class="p">,</span> <span class="n">case</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extrait de la liste toutes les cases dangers, opère un trie par</span>
<span class="sd">        proximité à la cases et puissance décroissantes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">listecases</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># 1- filtrage des cases dangers :</span>
        <span class="n">filterset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_dangers_for_case</span><span class="p">(</span><span class="n">listecases</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
        <span class="c1"># 2- création de la liste de dict, trie</span>
        <span class="n">liste_dgr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">liste_dgr_dict</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">}</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">filterset</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">liste_dgr_dict</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cd</span> <span class="ow">in</span> <span class="n">liste_dgr_dict</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span>
                <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;impact&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">danger_impact</span>
                <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;dist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_distance_between_cases</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
            <span class="n">liste_dgr_dict</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;dist&quot;</span><span class="p">))</span>
            <span class="n">liste_dgr_dict</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;impact&quot;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">liste_dgr</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">liste_dgr_dict</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">liste_dgr</span>

    <span class="k">def</span> <span class="nf">_extract_dangers_for_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">listecases</span><span class="p">,</span> <span class="n">case</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retourne le set de cases dangers (impact &gt; 1) contenues dans listecases,</span>
<span class="sd">        différentes de case.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">listecases</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">fullset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">listecases</span><span class="p">)</span>
        <span class="c1"># réduction aux cases dangers</span>
        <span class="n">filterset</span> <span class="o">=</span> <span class="n">fullset</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dangers_set</span><span class="p">)</span>
        <span class="c1"># puis aux dangers d&#39;impacts &gt; 1, sans la case</span>
        <span class="n">filterset</span> <span class="o">=</span> <span class="n">filterset</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dangers_set_1</span><span class="p">,</span> <span class="p">{</span><span class="n">case</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">filterset</span>

    <span class="k">def</span> <span class="nf">_does_mine_impact_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mine</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Est-ce que l&#39;explosion de la mine impacte la case?</span>
<span class="sd">        </span>
<span class="sd">        1/2 : Initialisation</span>
<span class="sd">        </span>
<span class="sd">        * recursive : recherche récursive, faux par défaut</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># set de mémorisation des dangers traités :</span>
        <span class="n">donelist</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="c1"># méthode récursive :</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdoes_mine_impact_case</span><span class="p">(</span><span class="n">mine</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">donelist</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_xdoes_mine_impact_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mine</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">donelist</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Est-ce que l&#39;explosion de la mine impacte la case?</span>
<span class="sd">        </span>
<span class="sd">        2/2 : Méthode récursive.</span>
<span class="sd">        </span>
<span class="sd">        * donelist : liste (set) des dangers déja traités</span>
<span class="sd">        * recursive : recherche récursive, faux par défaut</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">donelist</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mine</span><span class="p">)</span>
        <span class="c1"># set de cases impactées :</span>
        <span class="n">cases_impactees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_cases_adj_impacted_by_danger</span><span class="p">(</span><span class="n">mine</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cases_impactees</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">cases_impactees</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">recursive</span><span class="p">:</span>
                <span class="n">set_dgr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_dangers_for_case</span><span class="p">(</span><span class="n">cases_impactees</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">set_dgr</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">newdgr</span> <span class="o">=</span> <span class="n">set_dgr</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">donelist</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">newdgr</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdoes_mine_impact_case</span><span class="p">(</span>
                            <span class="n">c</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">donelist</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                            <span class="k">break</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_get_segment_for_grenade_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retourne la liste de cases de la cible vers le robot (exclus), s&#39;approchant</span>
<span class="sd">        le plus du vecteur formé par robot &amp; case</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
        <span class="n">vecteur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_vector_for_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">segment</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_segment</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">vecteur</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">vecteur</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">extremite</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">case</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">extremite</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">case</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="n">segment</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_segment</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">extremite</span><span class="p">)</span>
        <span class="n">liste</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span>
        <span class="n">firstcase</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># le robot a pu être déplacé virtuellement sans mise à jour de la</span>
        <span class="c1"># flatmatrice, le test robot == segment[0] n&#39;est donc pas sûr</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">firstcase</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">firstcase</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span><span class="p">):</span>
            <span class="n">liste</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">liste</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">liste</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">liste</span>

    <span class="k">def</span> <span class="nf">_complete_and_valide_grenade_combinaison</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">robot</span><span class="p">,</span>
        <span class="n">case</span><span class="p">,</span>
        <span class="n">combinaison</span><span class="p">,</span>
        <span class="n">safemode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">allowcollatdamage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">directonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Valide la combinaison, la complète en cas de validité.</span>
<span class="sd">        Retourne un boolean indiquant si la combinaison atteint la case ciblée</span>
<span class="sd">        et est cohérente avec le robot et les paramètres passés</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gdSet</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_current_gdSet</span><span class="p">()</span>
        <span class="c1"># cache ?</span>
        <span class="n">cible</span> <span class="o">=</span> <span class="n">combinaison</span><span class="p">[</span><span class="s2">&quot;cible&quot;</span><span class="p">]</span>
        <span class="n">portee</span> <span class="o">=</span> <span class="n">combinaison</span><span class="p">[</span><span class="s2">&quot;portee&quot;</span><span class="p">]</span>
        <span class="n">puissance</span> <span class="o">=</span> <span class="n">combinaison</span><span class="p">[</span><span class="s2">&quot;puissance&quot;</span><span class="p">]</span>
        <span class="n">k</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
            <span class="n">cible</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="n">cible</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
            <span class="n">portee</span><span class="p">,</span>
            <span class="n">puissance</span><span class="p">,</span>
            <span class="n">safemode</span><span class="p">,</span>
            <span class="n">allowcollatdamage</span><span class="p">,</span>
            <span class="n">directonly</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">valide</span><span class="p">,</span> <span class="n">cases_impactees</span><span class="p">,</span> <span class="n">combstats</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_combinaison_grenade_in_cache</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">valide</span><span class="p">,</span> <span class="n">cases_impactees</span><span class="p">,</span> <span class="n">combstats</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># calcul initial</span>
            <span class="n">dangerdict</span> <span class="o">=</span> <span class="n">CaseGrenade</span><span class="o">.</span><span class="n">get_default_dict</span><span class="p">()</span>
            <span class="n">dangerdict</span><span class="p">[</span><span class="s2">&quot;danger_impact&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">puissance</span>
            <span class="n">dangerdict</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cible</span><span class="o">.</span><span class="n">x</span>
            <span class="n">dangerdict</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cible</span><span class="o">.</span><span class="n">y</span>
            <span class="n">virtualgrenade</span> <span class="o">=</span> <span class="n">CaseGrenade</span><span class="p">(</span><span class="n">dangerdict</span><span class="p">)</span>
            <span class="n">dictimpact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">xlook_for_cases_impacted</span><span class="p">(</span><span class="n">virtualgrenade</span><span class="p">)</span>
            <span class="c1"># validité de la combinaison</span>
            <span class="n">cases_impactees</span> <span class="o">=</span> <span class="n">dictimpact</span><span class="p">[</span><span class="s2">&quot;flat_list&quot;</span><span class="p">]</span>
            <span class="c1"># en projectif les coords du robot peuvent être virtuelles, le test</span>
            <span class="c1"># is_bot_impacted = robot in cases_impactees n&#39;est donc pas suffisant</span>
            <span class="n">coords_impactees</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([(</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cases_impactees</span><span class="p">])</span>
            <span class="n">is_bot_impacted</span> <span class="o">=</span> <span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">coords_impactees</span>
            <span class="n">others_bot_impacted</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">c</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cases_impactees</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_ROBOT</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">!=</span> <span class="n">robot</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">alive</span>
            <span class="p">]</span>
            <span class="n">valide</span> <span class="o">=</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">cases_impactees</span>
            <span class="n">midSUR</span> <span class="o">=</span> <span class="n">CaseRobot</span><span class="o">.</span><span class="n">get_feature_threshold</span><span class="p">(</span><span class="s2">&quot;instinct_survie&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">safemode</span> <span class="ow">and</span> <span class="n">robot</span><span class="o">.</span><span class="n">instinct_survie</span> <span class="o">&gt;=</span> <span class="n">midSUR</span> <span class="ow">and</span> <span class="n">is_bot_impacted</span><span class="p">:</span>
                <span class="n">valide</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">allowcollatdamage</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">others_bot_impacted</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">kill_all</span> <span class="o">=</span> <span class="n">gdSet</span><span class="o">.</span><span class="n">get_list_case</span><span class="p">(</span><span class="s2">&quot;kill_all&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">others_bot_impacted</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kill_all</span><span class="p">:</span>
                        <span class="n">valide</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
            <span class="c1"># données complémentaires :</span>
            <span class="n">destruction</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">dangers</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">bonus</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">robots</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">murs</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">valide</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cases_impactees</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_DANGER</span><span class="p">:</span>
                        <span class="n">dangers</span> <span class="o">+=</span> <span class="n">c</span><span class="o">.</span><span class="n">danger_impact</span>
                    <span class="k">elif</span> <span class="n">c</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_BONUS</span><span class="p">:</span>
                        <span class="n">bonus</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">c</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_ROBOT</span><span class="p">:</span>
                        <span class="n">robots</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">c</span><span class="o">.</span><span class="n">type_case</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CASE_MUR</span><span class="p">:</span>
                        <span class="n">murs</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">destruction</span> <span class="o">=</span> <span class="n">dangers</span> <span class="o">+</span> <span class="n">robots</span> <span class="o">+</span> <span class="n">murs</span>
            <span class="n">combstats</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;destruction&quot;</span><span class="p">:</span> <span class="n">destruction</span><span class="p">,</span>
                <span class="s2">&quot;dangers&quot;</span><span class="p">:</span> <span class="n">dangers</span><span class="p">,</span>
                <span class="s2">&quot;bonus&quot;</span><span class="p">:</span> <span class="n">bonus</span><span class="p">,</span>
                <span class="s2">&quot;robots&quot;</span><span class="p">:</span> <span class="n">robots</span><span class="p">,</span>
                <span class="s2">&quot;murs&quot;</span><span class="p">:</span> <span class="n">murs</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">destruction</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">valide</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># mise en cache dans le gdSet</span>
            <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">valide</span><span class="p">,</span> <span class="n">cases_impactees</span><span class="p">,</span> <span class="n">combstats</span><span class="p">)</span>
            <span class="n">gdSet</span><span class="o">.</span><span class="n">cache_combinaison_grenade</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="c1"># on complète la combinaison :</span>
        <span class="n">combinaison</span><span class="p">[</span><span class="s2">&quot;cases_impactees&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cases_impactees</span>
        <span class="n">combinaison</span><span class="p">[</span><span class="s2">&quot;destruction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combstats</span><span class="p">[</span><span class="s2">&quot;destruction&quot;</span><span class="p">]</span>
        <span class="n">combinaison</span><span class="p">[</span><span class="s2">&quot;dangers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combstats</span><span class="p">[</span><span class="s2">&quot;dangers&quot;</span><span class="p">]</span>
        <span class="n">combinaison</span><span class="p">[</span><span class="s2">&quot;bonus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combstats</span><span class="p">[</span><span class="s2">&quot;bonus&quot;</span><span class="p">]</span>
        <span class="n">combinaison</span><span class="p">[</span><span class="s2">&quot;robots&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combstats</span><span class="p">[</span><span class="s2">&quot;robots&quot;</span><span class="p">]</span>
        <span class="n">combinaison</span><span class="p">[</span><span class="s2">&quot;murs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combstats</span><span class="p">[</span><span class="s2">&quot;murs&quot;</span><span class="p">]</span>
        <span class="c1"># retour :</span>
        <span class="k">return</span> <span class="n">valide</span>

    <span class="k">def</span> <span class="nf">_get_params_for_grenade_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retourne les paramètres associés à une commande formatée (ex gn2-5)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dictcmd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dictcmd</span> <span class="o">=</span> <span class="n">CommandHelper</span><span class="o">.</span><span class="n">translate_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="n">dictcmd</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pas</span> <span class="o">=</span> <span class="n">dictcmd</span><span class="p">[</span><span class="s2">&quot;pas&quot;</span><span class="p">]</span>
            <span class="n">direct</span> <span class="o">=</span> <span class="n">dictcmd</span><span class="p">[</span><span class="s2">&quot;direct&quot;</span><span class="p">]</span>
            <span class="n">cible</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_case_for_dir_and_pas</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">direct</span><span class="p">,</span> <span class="n">pas</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cible</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_params_for_grenade</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">cible</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">params</span>

    <span class="c1">#-----&gt; B.12- Utilitaires basiques</span>
    <span class="k">def</span> <span class="nf">_get_dir_for_axe_and_sens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axe</span><span class="p">,</span> <span class="n">sens</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Utilitaire : traduit axe+sens en dir</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">axe</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">AXIS_X</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sens</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">DIR_POS</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">RIGHT</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">LEFT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sens</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">DIR_POS</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">BOTTOM</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">TOP</span>

    <span class="k">def</span> <span class="nf">_get_next_cases_in_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">direct</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retourne la liste des cases suivantes dans la direction direct</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_dimensions</span><span class="p">()</span>
        <span class="n">listcases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">case</span><span class="o">.</span><span class="n">y</span>
        <span class="k">if</span> <span class="n">direct</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">LEFT</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">listcases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
                <span class="n">x</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">direct</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">w</span><span class="p">:</span>
                <span class="n">listcases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
                <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">direct</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">TOP</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">listcases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
                <span class="n">y</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">direct</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">BOTTOM</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">h</span><span class="p">:</span>
                <span class="n">listcases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
                <span class="n">y</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">listcases</span>

    <span class="k">def</span> <span class="nf">_get_dir_cmd_for_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Indique quelle direction de commande correspond à la case</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">vecteur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_vector_for_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_BOTTOM</span>
            <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_TOP</span>
        <span class="k">elif</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_RIGHT</span>
            <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_LEFT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">vecteur</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">vecteur</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_RIGHT</span>
                <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_LEFT</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_BOTTOM</span>
                <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">CHAR_TOP</span>
        <span class="k">return</span> <span class="n">direction</span>

    <span class="k">def</span> <span class="nf">_get_dir_for_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Indique quelle direction correspond à la case</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">vecteur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_vector_for_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">BOTTOM</span>
            <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">TOP</span>
        <span class="k">elif</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">RIGHT</span>
            <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">LEFT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">vecteur</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">vecteur</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">RIGHT</span>
                <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">LEFT</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">BOTTOM</span>
                <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">TOP</span>
        <span class="k">return</span> <span class="n">direction</span>

    <span class="k">def</span> <span class="nf">_get_case_for_dir_and_pas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">,</span> <span class="n">direct</span><span class="p">,</span> <span class="n">pas</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retourne la case associée aux paramètres</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">direct</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">LEFT</span><span class="p">:</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">AXIS_X</span>
            <span class="n">sens</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">DIR_NEG</span>
        <span class="k">elif</span> <span class="n">direct</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">:</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">AXIS_X</span>
            <span class="n">sens</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">DIR_POS</span>
        <span class="k">elif</span> <span class="n">direct</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">TOP</span><span class="p">:</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">AXIS_Y</span>
            <span class="n">sens</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">DIR_NEG</span>
        <span class="k">elif</span> <span class="n">direct</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">BOTTOM</span><span class="p">:</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">AXIS_Y</span>
            <span class="n">sens</span> <span class="o">=</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">DIR_POS</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">x_r</span><span class="p">,</span> <span class="n">y_r</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="n">LabHelper</span><span class="o">.</span><span class="n">AXIS_X</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x_r</span> <span class="o">+</span> <span class="n">pas</span> <span class="o">*</span> <span class="n">sens</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y_r</span> <span class="o">+</span> <span class="n">pas</span> <span class="o">*</span> <span class="n">sens</span>
        <span class="n">flatmatrice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_flat_matrice</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">flatmatrice</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_dirs_to_mainTarget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retourne les directions robot -&gt; cible principale ou None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mainTarget</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">get_main_target</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mainTarget</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">list_dirs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">vecteur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lablevel</span><span class="o">.</span><span class="n">get_vector_for_cases</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">mainTarget</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">list_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">list_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">list_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">BOTTOM</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vecteur</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">list_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LabHelper</span><span class="o">.</span><span class="n">TOP</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">list_dirs</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright Gabriel Leroy - novembre 2020 - Licence Art Libre (https://artlibre.org/)

    </p>
  </div>
    
    
    
    Compilé avec <a href="http://sphinx-doc.org/">Sphinx</a> en utilisant un
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">thème</a>
    
    fourni par <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>